# `acoustics-core.js`: 共有 DSP およびユーティリティ

このモジュールは、音響解析アプリケーション（`wav2Fmax`, `revtime_recorder`, `FilterDesign` など）で使用される、デジタル信号処理（DSP）および共通ユーティリティ関数を提供します。

## 💡 モジュールの主要概念

| 概念 | 詳細 |
| :--- | :--- |
| **信号の表現** | スカラー値には `Number` を、信号（時系列データ）には `Float32Array` を使用します。 |
| **フィルタ構造** | すべてのフィルタは**二次セクション（Biquad）**または**一次セクション**の連立（**SOS: Second-Order Sections**）で構成されます。 |
| **係数形式** | フィルタ係数は `{b0, b1, b2, a1, a2}` のオブジェクト形式で表現されます。一次フィルタの場合、`b2` と `a2` は $0$ です。 |
| **実装** | フィルタ処理には、係数が少ない形式である **転置型 II 次直接形式（DF2T: Direct Form II Transposed）** が使用されます。 |
| **正規化** | すべてのフィルタ（LP, HP, BP）は、設計時の**中心周波数 $f_c$** でのゲインが $0 \text{ dB}$（ユニティゲイン: 振幅 $1$）になるように正規化されます。 |

---

## 🛠️ 1. デジタルフィルタ設計（双一次変換）

アナログフィルタの伝達関数をデジタルフィルタの伝達関数に変換する**双一次変換 (Bilinear Transform)** に基づいた設計関数群です。プリワーピング（Pre-warping）処理が施されています。

| 関数名 | 機能 |
| :--- | :--- |
| `d1_LP(fc, fs)` | プリワーピングされた双一次変換による**一次ローパス (LP) フィルタ**の設計。 |
| `d1_HP(fc, fs)` | プリワーピングされた双一次変換による**一次ハイパス (HP) フィルタ**の設計。 |
| `rbjLP(fc, fs, Q)` | **RBJ (Robert Bristow-Johnson)** 形式に基づく**二次ローパス (LP) フィルタ**の設計。事前に $\omega_0$ をプリワーピングします。 |
| `rbjHP(fc, fs, Q)` | **RBJ** 形式に基づく**二次ハイパス (HP) フィルタ**の設計。 |

---

## 📐 2. バターワースフィルタの設計と合成

バターワース（Butterworth）特性のフィルタを SOS 形式で設計するためのヘルパー関数群です。

| 関数名 | 機能 |
| :--- | :--- |
| `butterQ(n, k)` | バターワースフィルタのアナログ極の角位置に基づき、**$k$ 番目の極**に対応する $Q$ 値を計算します。**二次セクション (Biquad)** の設計に使用されます。 |
| `butterLP_sos(fc, fs, order)` | 指定した**次数 (order)** の**ローパス** バターワースフィルタを SOS（二次セクションの配列）として設計します。奇数次数の場合は末尾に一次セクションを追加します。 |
| `butterHP_sos(fc, fs, order)` | 指定した**次数 (order)** の**ハイパス** バターワースフィルタを SOS として設計します。 |
| `designButterworthBandpassSOS_N(fc, fs, N)` | **ローパスとハイパスの組み合わせ (LP-HP スプリット)** により、**バンドパス (BP)** バターワースフィルタを設計します。**最終的に $f_c$ でユニティゲインに正規化されます。** |

---

## ⚙️ 3. フィルタの適用と周波数応答

信号処理およびフィルタ解析のコア機能です。

| 関数名 | 機能 |
| :--- | :--- |
| `sosFilter(xFloat32, sosArray)` | 入力信号 `xFloat32` に、SOS 形式のフィルタ配列 `sosArray` を適用します。各セクションは**転置型 II 次直接形式 (DF2T)** でカスケード接続されます。 |
| `sosFreqz(sections, fs, fgrid)` | SOS 形式のフィルタの**周波数応答の振幅**を計算します。入力された周波数配列 `fgrid` の各点におけるゲイン（振幅）を返します。 |
| `normalizeAt(sections, fs, fref)` | フィルタ配列 `sections` の**カスケードゲイン**を、指定した参照周波数 `fref` において $0 \text{ dB}$（振幅 $1$）になるように、初段の $b_n$ 係数を調整して正規化します。 |

---

## 📈 4. 解析ユーティリティ

音響測定で一般的に使用される分析機能を提供します。

| 関数名 | 機能 |
| :--- | :--- |
| `centersOct()` | **オクターブバンド（$1/1$ OCT）** の標準的な**中心周波数配列**（$16 \text{ Hz}$ から $8000 \text{ Hz}$）を返します。 |
| `centersThird()` | **$1/3$ オクターブバンド**の標準的な**中心周波数配列**（$16 \text{ Hz}$ から $8000 \text{ Hz}$）を返します。 |
| `percentile(arr, p)` | 配列 `arr` の $p$ パーセンタイル値を計算します（例: $p=0.9$ で $L_{90}$ ）。 |
| `ewmaSquaredToSPL(y, sr, tau)` | 信号の二乗値に対し、**指数移動平均 (EWMA)** を適用し、その結果を $\text{SPL}$（音圧レベル $\text{dB}$）に変換します。$\tau$ は時定数です。 |
| `movingLeqSPL(y, sr, winSec)` | 信号に対し、**移動窓平均**を適用し、**移動等価騒音レベル $L_{\text{eq}}$** を $\text{SPL}$ 形式で計算します。`winSec` は窓幅（秒）です。 |
| `downsampleForPlot(x, y, maxPoints)` | グラフ描画用に、データセット $(x, y)$ を最大 `maxPoints` の点数に**間引き**ます。 |
