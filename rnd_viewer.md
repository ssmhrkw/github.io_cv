## 💻 RND Reader: 技術詳細（専門家向け）

このWebアプリケーションは、ローカルファイルを扱うWebブラウザ機能と、データ解析・可視化ライブラリを組み合わせた、クライアントサイド完結型の解析ツールです。

### 1. データ入出力とエンコーディング処理

| 要素 | 詳細 | 専門的観点 |
| :--- | :--- | :--- |
| **ファイル形式** | CSV形式（`.csv`, `.rnd`, `.txt` 拡張子を許容）。**複数ファイル**対応。 | 騒音計や分析装置が出力する**RNDファイル**（リオン、小野測器などの機器で用いられることが多い）や、一般的なCSVファイルを想定。 |
| **エンコーディング** | **Shift-JIS優先**、UTF-8フォールバック。 | 日本国内で流通する測定機器の多くがCSV出力にShift-JISを使用するため、`new TextDecoder('shift_jis').decode(buf)`でデコードを試みます。失敗した場合に`utf-8`で読み込む堅牢性を確保しています。 |
| **データ構造解析** | 読み込んだCSVは、**固定の行番号**に基づきヘッダーとデータを抽出します。 | データ行は行インデックス**9から20**（CSVの10行目から21行目）を探索し、周波数ヘッダーは行インデックス**7**（CSVの8行目）を使用。これは特定の騒音計の出力フォーマットに**ハードコード**された依存関係を示します。 |
| **データ抽出** | **オクターブバンド**（B列〜N列、13バンド）と**1/3オクターブバンド**（O列〜AU列、34バンド）のデータが、CSVの隣接した列に配置されていることを前提とします。 |

### 2. データ系列の管理

* **対象系列 (`SERIES_ORDER`)**: 以下の**9つ**の音響測定指標に絞ってデータを抽出・描画します。
    * **騒音暴露**: `Leq`, `LE`
    * **時間重み特性**: `Lmax`, `Lmin`
    * **統計レベル**: `LN1`, `LN2`, `LN3`, `LN4`, `LN5`
    * **備考**: **$Lp$**（瞬時音圧レベル）や**$Lp$ Over/Under**はデータ行に存在するものの、グラフ描画対象から除外されています。
* **数値変換**: `toNumOrNaN`関数は、データセルから不要な文字（単位など）を削除し、欠損値を示す文字列 (`-`, `-----`) を**`NaN`**として処理することで、Plotlyでの描画やテーブル表示における欠損データ（ブランク）を適切に扱います。

### 3. 可視化 (Plotly Integration)

* **サブプロット構成**: Plotlyの`grid`レイアウト機能を利用し、9つのターゲット系列（`Leq`から`LN5`まで）を**3行 $\times$ 3列の独立したサブプロット**として描画します。
* **複数ファイル比較**: 読み込まれた各ファイルは、サブプロット内で独立した**トレース（線グラフ）**としてプロットされます。これにより、同一の音響指標（例：`Leq`）について、複数回の測定結果（複数ファイル）を周波数スペクトルとして比較できます。
* **軸設定**:
    * X軸（周波数）は`type:'category'`とし、CSVから抽出した周波数値をそのままティックラベルとして使用します（通常は対数スケールが望ましいが、簡易的なカテゴリー軸として処理）。
    * Y軸（レベル）は`rangemode:'tozero'`（0から始まる範囲）をデフォルトとしています。
* **対話性**: `hovertemplate`を設定することで、マウスオーバー時に「系列名・周波数・レベル・ファイル名」を同時に表示します。

### 4. 結果表示（グラフと表）

* **グラフ表示**: `oct`（オクターブ）と`thirdoct`（1/3オクターブ）の**タブ切り替え**方式で、それぞれ独立した9つのサブプロットを含む大きなグラフ（高さ900px）を表示します。
* **テーブル表示**: グラフの下部には、`details`/`summary`要素で折りたたみ可能な形式で、**周波数帯域ごとの詳細な数値表**が表示されます。
    * **構造**: **行＝ファイル名**、**列＝中心周波数**（$f_c$）の形式で、各系列（$L_{\text{eq}}, L_{\text{max}}$など）ごとに表が作成されます。
    * **スクロール**: ファイル名列（行ヘッダー）は`position:sticky; left:0;`で固定され、テーブル水平スクロール時の視認性を確保しています。

---

## 🚀 RND Reader の使い方（はじめての方へ）

このアプリは、騒音計や計測器で記録したデータファイル（CSVなど）を**グラフと表**で表示し、複数の測定結果を簡単に比較するためのツールです。

### ステップ 1: データの準備

1.  **測定データをCSV形式で用意します。**
    * 多くの騒音計は**RND**または**CSV**形式でデータを出力できます。
    * このビューアは、日本の計測器で一般的な**Shift-JISエンコーディング**のCSVファイルに対応しています。

### ステップ 2: ファイルの読み込み

以下のいずれかの方法でファイルをアプリに読み込ませます。

1.  **ドラッグ＆ドロップ**: 画面中央にある青い枠**「ここにドラッグ＆ドロップ」**に、測定データファイル（複数選択可）をまとめてドラッグして放します。
2.  **ファイル選択**: **「ファイル選択（複数可）」**ボタンを押して、表示されるウィンドウからファイルを選びます。

読み込みが成功すると、画面下部に読み込まれたファイル名がバッジで表示されます。

### ステップ 3: グラフと表の確認

ファイルが読み込まれると、自動的に解析と描画が開始され、結果が表示されます。

#### 1. タブの切り替え
画面上部のタブで、周波数分析の細かさを切り替えられます。
* **OCT**: **オクターブバンド分析**（粗い分類、例：125 Hz, 250 Hz, 500 Hz...）
* **1/3 OCT**: **1/3オクターブバンド分析**（細かい分類）

#### 2. グラフ（サブプロット）の確認
表示される大きなグラフには、以下の**9つの音響指標**が、それぞれ独立したグラフ（サブプロット）として描かれています。

| 指標 | 意味 |
| :--- | :--- |
| **Leq** | 等価騒音レベル（平均的な騒音の大きさ） |
| **LE** | 騒音暴露レベル（全測定期間の音響エネルギー） |
| **Lmax** | 最大騒音レベル |
| **Lmin** | 最小騒音レベル |
| **LN1, LN2...** | 統計レベル（例: LN5は測定時間のうち5%を超える騒音レベル） |

* **複数ファイル比較**: 読み込んだファイルが複数ある場合、同じサブプロット内に**ファイルごとの線**が描画されます。これにより、測定結果の傾向の違いを一目で比較できます。
* **詳細表示**: グラフ上でマウスカーソルを線の上に合わせると、**周波数、dB値、ファイル名**が詳しく表示されます。

#### 3. 数値表の確認
グラフの下にある**「表（系列ごと・行＝ファイル、列＝周波数）を表示」**をクリックすると、詳細な数値データを確認できます。

* **表の構造**:
    * 一番左の列が**ファイル名**です。
    * 上の行が**中心周波数**です。
    * 交差するセルに、そのファイル・その周波数帯の**dB値**が表示されます。
* **便利な機能**: 表が大きくて横にスクロールが必要な場合でも、**ファイル名の列は固定**されているため、どのファイルのデータかを見失わずに確認できます。
