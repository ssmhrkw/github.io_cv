<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>板材の音響・振動特性 計算ツール (Web版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Meiryo', sans-serif; display: flex; gap: 20px; padding: 10px; }
        .input-column, .output-column { display: flex; flex-direction: column; gap: 15px; }
        .input-column { min-width: 350px; }
        .output-column { flex-grow: 1; }
        fieldset { border: 1px solid #ccc; border-radius: 5px; padding: 15px; }
        legend { font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: 120px 1fr 40px; align-items: center; gap: 5px; }
        label { font-size: 14px; }
        input, select { width: 100%; padding: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; font-weight: bold; cursor: pointer; }
        .tabs { display: flex; border-bottom: 1px solid #ccc; }
        .tab-button { padding: 10px 15px; cursor: pointer; background: #f1f1f1; border: 1px solid #ccc; border-bottom: none; border-radius: 5px 5px 0 0; }
        .tab-button.active { background: #fff; border-bottom: 1px solid #fff; }
        .tab-content { display: none; padding: 10px; border: 1px solid #ccc; border-top: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        th { background-color: #f2f2f2; text-align: center; }
    </style>
</head>
<body>

    <div class="input-column">
        <fieldset>
            <legend>入力条件</legend>
            <div class="form-grid">
                <label for="material-select">材料選択:</label>
                <select id="material-select"></select>
                <span></span>
                <label for="freq-input">周波数 (f):</label>
                <input type="number" id="freq-input" value="500">
                <span>Hz</span>
                <label for="thick-input">板厚 (h):</label>
                <input type="number" id="thick-input" value="12.0">
                <span>mm</span>
                <label for="lx-input">板の長さ (Lx):</label>
                <input type="number" id="lx-input" value="1000">
                <span>mm</span>
                <label for="ly-input">板の幅 (Ly):</label>
                <input type="number" id="ly-input" value="1000">
                <span>mm</span>
                <label for="eta-input">損失係数 (η):</label>
                <input type="number" id="eta-input" value="0.01">
                <span></span>
            </div>
        </fieldset>
        <fieldset>
            <legend>材料物性値（手動入力可）</legend>
            <div class="form-grid">
                <label for="e-input">ヤング率 (E):</label>
                <input type="text" id="e-input">
                <span>Pa</span>
                <label for="rho-input">密度 (ρ):</label>
                <input type="text" id="rho-input">
                <span>kg/m³</span>
                <label for="nu-input">ポアソン比 (ν):</label>
                <input type="text" id="nu-input">
                <span></span>
            </div>
        </fieldset>
        <button id="calc-button">計算実行</button>
    </div>

    <div class="output-column">
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'basic-tab')">基本特性</button>
            <button class="tab-button" onclick="openTab(event, 'natural-freq-tab')">固有振動数</button>
            <button class="tab-button" onclick="openTab(event, 'stl-tab')">透過損失(STL)</button>
            <button class="tab-button" onclick="openTab(event, 'rad-tab')">音響放射効率(σ)</button>
        </div>

        <div id="basic-tab" class="tab-content active">
            <table id="basic-results-table"></table>
        </div>
        <div id="natural-freq-tab" class="tab-content">
            <table id="natural-freq-table"></table>
        </div>
        <div id="stl-tab" class="tab-content">
            <canvas id="stl-chart"></canvas>
            <table id="stl-table"></table>
        </div>
        <div id="rad-tab" class="tab-content">
            <canvas id="rad-chart"></canvas>
            <table id="rad-table"></table>
        </div>
    </div>

<script>
    // --- データと定数 ---
    const MATERIAL_PROPERTIES = {
        "手動入力": { "E": 0, "rho": 0, "nu": 0 },
        "木材 (スギ)": { "E": 7.4e9, "rho": 400, "nu": 0.30 },
        "石膏ボード": { "E": 2.5e9, "rho": 800, "nu": 0.25 },
        "アスファルト": { "E": 5.0e9, "rho": 2300, "nu": 0.35 },
        "ALC": { "E": 1.8e9, "rho": 500, "nu": 0.20 },
        "コンクリート": { "E": 25.0e9, "rho": 2300, "nu": 0.20 },
    };

    const FREQS = [16, 20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300, 8000];
    let stlChart, radChart; // グラフオブジェクトをグローバルに保持

    // --- UI要素の取得 ---
    const ui = {
        materialSelect: document.getElementById('material-select'),
        freqInput: document.getElementById('freq-input'),
        thickInput: document.getElementById('thick-input'),
        lxInput: document.getElementById('lx-input'),
        lyInput: document.getElementById('ly-input'),
        etaInput: document.getElementById('eta-input'),
        eInput: document.getElementById('e-input'),
        rhoInput: document.getElementById('rho-input'),
        nuInput: document.getElementById('nu-input'),
        calcButton: document.getElementById('calc-button'),
        basicTable: document.getElementById('basic-results-table'),
        naturalFreqTable: document.getElementById('natural-freq-table'),
        stlTable: document.getElementById('stl-table'),
        radTable: document.getElementById('rad-table'),
    };
    
    // --- 初期化処理 ---
    function initialize() {
        // 材料選択のプルダウンを生成
        for (const name in MATERIAL_PROPERTIES) {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            ui.materialSelect.appendChild(option);
        }
        ui.materialSelect.value = "石膏ボード";
        
        // イベントリスナーを設定
        ui.materialSelect.addEventListener('change', onMaterialSelect);
        ui.calcButton.addEventListener('click', calculateAllProperties);

        // 初期表示
        onMaterialSelect();
        calculateAllProperties();
    }
    
    // --- イベントハンドラ ---
    function onMaterialSelect() {
        const selectedName = ui.materialSelect.value;
        const props = MATERIAL_PROPERTIES[selectedName];
        const isManual = selectedName === "手動入力";

        ui.eInput.value = isManual ? "" : props.E.toExponential(2);
        ui.rhoInput.value = isManual ? "" : props.rho;
        ui.nuInput.value = isManual ? "" : props.nu;

        [ui.eInput, ui.rhoInput, ui.nuInput].forEach(input => {
            input.readOnly = !isManual;
        });
    }
    
    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
    
    // --- 計算ロジック ---
    function calculateAllProperties() {
        try {
            // 入力値を取得
            const h = parseFloat(ui.thickInput.value) / 1000;
            const E = parseFloat(ui.eInput.value);
            const rho = parseFloat(ui.rhoInput.value);
            const nu = parseFloat(ui.nuInput.value);
            const eta = parseFloat(ui.etaInput.value);
            const c0 = 343.0;

            if (h <= 0 || E <= 0 || rho <= 0 || eta < 0) {
                alert("厚さ、ヤング率、密度は正の値、損失係数は0以上の値を入力してください。");
                return;
            }

            // 基本特性
            const D = (E * Math.pow(h, 3)) / (12 * (1 - Math.pow(nu, 2)));
            const fc = (Math.pow(c0, 2) / (2 * Math.PI * h)) * Math.sqrt((12 * rho * (1 - Math.pow(nu, 2))) / E);
            const Z_inf = 8 * Math.sqrt(D * rho * h);

            updateBasicPropertiesTab(Z_inf, fc, h, E, rho, nu);
            updateNaturalFrequencyTab(D, rho, h);
            updateFrequencyDependentTabs(h, rho, eta, fc);

        } catch (error) {
            alert(`計算エラー: ${error.message}`);
        }
    }
    
    function updateBasicPropertiesTab(Z_inf, fc, h, E, rho, nu) {
        const Z_inf_dB = 20 * Math.log10(Z_inf / 1.0);
        let results = [
            ["無限長板インピーダンス (Z_inf)", `${Z_inf.toFixed(2)} (${Z_inf_dB.toFixed(1)} dB)`, "N·s/m"],
            ["臨界周波数 (Fc)", `${fc.toFixed(2)}`, "Hz"]
        ];
        
        const f_single = parseFloat(ui.freqInput.value);
        if (f_single > 0) {
            const omega = 2 * Math.PI * f_single;
            const C_L_p = Math.sqrt(E / (rho * (1 - Math.pow(nu, 2))));
            const c_BP = Math.sqrt(omega * h * C_L_p / Math.sqrt(12));
            const c_g = 2 * c_BP;
            results.push(["--- @指定周波数 ---", "", ""]);
            results.push(["位相速度 (c_BP)", `${c_BP.toFixed(2)}`, "m/s"]);
            results.push(["群速度 (c_g)", `${c_g.toFixed(2)}`, "m/s"]);
            results.push(["縦波板速度 (C_L_p)", `${C_L_p.toFixed(2)}`, "m/s"]);
        }
        createTable(ui.basicTable, ["物理量", "計算値", "単位"], results);
    }
    
    function updateNaturalFrequencyTab(D, rho, h) {
        let results = [];
        const Lx = parseFloat(ui.lxInput.value) / 1000;
        const Ly = parseFloat(ui.lyInput.value) / 1000;
        if (Lx > 0 && Ly > 0) {
            for (let m = 1; m <= 3; m++) {
                for (let n = 1; n <= 3; n++) {
                    const f_mn = (Math.PI / 2) * Math.sqrt(D / (rho * h)) * (Math.pow(m / Lx, 2) + Math.pow(n / Ly, 2));
                    results.push([`f(${m},${n})`, f_mn.toFixed(2), "Hz"]);
                }
            }
        }
        createTable(ui.naturalFreqTable, ["モード次数", "周波数", "単位"], results);
    }
    
    function updateFrequencyDependentTabs(h, rho, eta, fc) {
        const m_double_prime = rho * h;
        const R_mass = FREQS.map(f => 20 * Math.log10(m_double_prime * f) - 42.5);
        const R_coincidence = R_mass.map((r, i) => {
            const f = FREQS[i];
            const f_ratio = f / fc;
            if (Math.abs(f_ratio - 1) < 1e-6) return r; // Avoid singularity
            const correction = (2 * eta) / (Math.PI * f_ratio) * (1 / Math.pow(1 - Math.pow(f_ratio, 2), 2));
            return r - 10 * Math.log10(Math.abs(correction) + 1);
        });
        
        const Lx = parseFloat(ui.lxInput.value) / 1000;
        const Ly = parseFloat(ui.lyInput.value) / 1000;
        const P = Lx > 0 && Ly > 0 ? 2 * (Lx + Ly) : 4.0;
        const A = Lx > 0 && Ly > 0 ? Lx * Ly : 1.0;
        const lambda_c = 343.0 / fc;
        
        const sigma = FREQS.map(f => {
            let s_val;
            if (f > fc) {
                s_val = Math.pow(1 - fc / f, -0.5);
            } else {
                s_val = (P * lambda_c / (Math.PI * A)) * Math.pow(f / fc, 2);
            }
            return Math.max(1e-4, Math.min(s_val, 5.0)); // Clip values
        });
        const sigma_db = sigma.map(s => 10 * Math.log10(s));

        // STLタブ更新
        createPlot(ui.stlChart.getContext('2d'), 'stl-chart', FREQS, 
            [{label: '質量則(垂直入射)', data: R_mass}, {label: 'コインシデンス考慮', data: R_coincidence}],
            '透過損失 (STL) 周波数特性');
        createTable(ui.stlTable, ['周波数 (Hz)', '質量則 (dB)', 'コインシデンス (dB)'], 
            FREQS.map((f, i) => [f, R_mass[i].toFixed(1), R_coincidence[i].toFixed(1)]));
        
        // 放射効率タブ更新
        createPlot(ui.radChart.getContext('2d'), 'rad-chart', FREQS, 
            [{label: '放射効率', data: sigma_db}], '音響放射効率 周波数特性');
        createTable(ui.radTable, ['周波数 (Hz)', 'σ', '10log(σ) (dB)'],
            FREQS.map((f, i) => [f, sigma[i].toFixed(3), sigma_db[i].toFixed(1)]));
    }
    
    // --- ヘルパー関数 ---
    function createTable(tableElement, headers, data) {
        tableElement.innerHTML = `
            <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
            <tbody>${data.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>
        `;
    }

    function createPlot(ctx, chartId, labels, datasets, title) {
        // 既存のチャートがあれば破棄
        if (chartId === 'stl-chart' && stlChart) stlChart.destroy();
        if (chartId === 'rad-chart' && radChart) radChart.destroy();

        const chartConfig = {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets.map((ds, i) => ({
                    label: ds.label,
                    data: ds.data,
                    borderColor: i === 0 ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 99, 132, 1)',
                    backgroundColor: i === 0 ? 'rgba(54, 162, 235, 0.2)' : 'rgba(255, 99, 132, 0.2)',
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 3
                }))
            },
            options: {
                responsive: true,
                plugins: { title: { display: true, text: title } },
                scales: {
                    x: {
                        type: 'logarithmic',
                        title: { display: true, text: '周波数 (Hz)' },
                        ticks: {
                            callback: function(value, index, values) {
                                const standard_ticks = [63, 125, 250, 500, 1000, 2000, 4000, 8000];
                                return standard_ticks.includes(value) ? value : null;
                            }
                        }
                    },
                    y: {
                        title: { display: true, text: 'dB' }
                    }
                }
            }
        };

        if (chartId === 'stl-chart') {
            stlChart = new Chart(ctx, chartConfig);
        } else if (chartId === 'rad-chart') {
            radChart = new Chart(ctx, chartConfig);
        }
    }

    // --- アプリケーション開始 ---
    initialize();

</script>
</body>
</html>
