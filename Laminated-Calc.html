<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統合版 音響シミュレーター (Web版) - 最終修正版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* 基本スタイル */
        body { font-family: 'Meiryo', sans-serif; margin: 0; padding: 10px; font-size: 14px; background-color: #f4f4f4; display: flex; flex-direction: column; gap: 15px; }
        .column { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        fieldset { border: 1px solid #ccc; border-radius: 5px; padding: 10px 15px; background-color: #fff; margin: 0; }
        legend { font-weight: bold; padding: 0 5px; }
        button { padding: 10px 15px; font-weight: bold; cursor: pointer; border-radius: 5px; border: 1px solid #aaa; background-color: #f0f0f0; }
        .button-group { display: flex; gap: 10px; }
        .button-group button { flex-grow: 1; }
        .prop-label { font-size: 12px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; background-color: #fafafa; padding: 5px; border-radius: 3px; border: 1px solid #eee; }
        .result-summary-grid { display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 5px 15px;}
        #f0-value { font-size: 1.2em; font-weight: bold; color: #d9534f; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: right; font-size: 12px; }
        th { background-color: #f2f2f2; text-align: center; }
        .layer-table tbody tr { cursor: pointer; }
        .layer-table tbody tr:hover { background-color: #f5f5f5; }
        .layer-table tbody tr.selected { background-color: #d9edf7; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; }
        .modal-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 8px; z-index: 101; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px; }
        .modal-grid { display: grid; grid-template-columns: 100px 1fr; gap: 10px; align-items: center; }
        .modal-buttons { text-align: right; margin-top: 20px; display: flex; gap: 10px; }
        .modal-buttons button { flex-grow: 1; }
        #formula-container { margin-top: 20px; padding: 15px; background-color: #fff; border: 1px solid #ccc; border-radius: 5px; font-size: 13px; }
        #formula-container h5 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; }

        @media (min-width: 768px) {
            body {
                flex-direction: row;
                align-items: flex-start; /* 左カラムの高さに右カラムが影響されないようにする */
            }
            .input-column {
                min-width: 420px;
                width: 420px;
            }
            /* ★★★★★★★★★★★★★★★★★★★★★★★★★★★★ */
            /* ★★★ 修正箇所: グラフが伸びる問題へのシンプルな対策 ★★★ */
            /* ★★★★★★★★★★★★★★★★★★★★★★★★★★ */
            .graph-column {
                flex-grow: 1;
                /* グラフエリアの高さを画面の高さの60%に固定（お好みの値に調整してください） */
                height: 65vh;
                /* Chart.jsがサイズを正しく計算するために `position: relative` を指定 */
                position: relative;
            }
        }
    </style>
</head>
<body>
    <div id="layer-modal" class="modal-backdrop">
        <div class="modal-dialog">
            <h3 id="modal-title">レイヤー編集</h3>
            <div class="modal-grid">
                <label>材料:</label> <select id="modal-mat-select"></select>
                <label>厚さ (mm):</label> <input type="number" id="modal-thick-input" value="12.5">
                <label>密度 (kg/m³):</label> <input type="text" id="modal-rho-input">
                <label>ヤング率 (Pa):</label> <input type="text" id="modal-e-input">
                <label>ポアソン比:</label> <input type="text" id="modal-nu-input">
            </div>
            <div class="modal-buttons">
                <button id="modal-cancel-btn">キャンセル</button>
                <button id="modal-ok-btn" style="background-color: #337ab7; color: white;">OK</button>
            </div>
        </div>
    </div>
    <div class="column input-column">
        <fieldset>
            <legend>パネルA (躯体側)</legend>
            <div id="panel-a-container"></div>
            <div class="button-group">
                <button onclick="openLayerModal('A')">レイヤー追加</button>
                <button onclick="removeLayer('A')">選択レイヤー削除</button>
            </div>
            <pre id="prop-a-label" class="prop-label">N/A</pre>
        </fieldset>
        <fieldset>
            <legend>中間層</legend>
            <label>空気層の厚さ (mm): <input type="number" id="air-gap-input" value="0" style="width: 100%;"></label>
            <label>吸音材: <select id="absorbent-select" style="width: 100%;"></select></label>
            <label>流動抵抗 (Pa·s/m²): <input type="number" id="flow-resist-input"></label>
        </fieldset>
        <fieldset>
            <legend>パネルB (内装側)</legend>
            <div id="panel-b-container"></div>
             <div class="button-group">
                <button onclick="openLayerModal('B')">レイヤー追加</button>
                <button onclick="removeLayer('B')">選択レイヤー削除</button>
            </div>
            <pre id="prop-b-label" class="prop-label">N/A</pre>
        </fieldset>
        <div class="button-group" style="margin-top: 10px;">
            <button id="calc-button" style="flex-grow: 1; padding: 12px; background-color: #5cb85c; color: white;">計算実行</button>
            <button id="export-csv-button" style="flex-grow: 1; background-color: #337ab7; color: white;">CSVエクスポート</button>
        </div>
        <fieldset>
            <legend>結果サマリー</legend>
            <div class="result-summary-grid">
                <label style="font-weight: bold;">共鳴周波数 (f₀):</label>
                <span id="f0-value">N/A</span>
            </div>
            <div id="summary-table-container"></div>
        </fieldset>
    </div>
    <div class="column graph-column">
        <canvas id="stl-chart"></canvas>
        <div id="formula-container">
            <h5 style="margin-top:0;">計算式</h5>
            <div id="formula-display">
                <p>計算を実行すると、ここに適用された計算式が表示されます。</p>
            </div>
        </div>
    </div>

<script>
    // (JavaScript部分の大部分は変更ありません)
    const MATERIAL_PROPERTIES = { "手動入力": { "rho": 0, "E": 0, "nu": 0 }, "コンクリート": { "rho": 2.3e3, "E": 2.1e10, "nu": 0.005 }, "軽量コンクリート": { "rho": 1.5e3, "E": 0.5e10, "nu": 0.005 }, "発泡コンクリート": { "rho": 0.6e3, "E": 0.16e10, "nu": 0.005 }, "石こうボード": { "rho": 0.8e3, "E": 0.18e10, "nu": 0.005 }, "特殊石こうボード": { "rho": 1.1e3, "E": 0.2e10, "nu": 0.005 }, "フレキシブル板": { "rho": 1.9e3, "E": 0.2e10, "nu": 0.005 }, "ハードボード": { "rho": 0.9e3, "E": 0.6e10, "nu": 0.005 }, "合板": { "rho": 0.6e3, "E": 0.5e10, "nu": 0.30 }, "コルク": { "rho": 0.25e3, "E": 6e7, "nu": 0.30 }, "ガラス": { "rho": 2500, "E": 70.0e9, "nu": 0.23 }, "硬質塩ビ": { "rho": 1.4e3, "E": 0.35e10, "nu": 0.012 }, "ゴム(硬度50)": { "rho": 1.11e3, "E": 0.46e7, "nu": 0.1 } };
    const ABSORBENT_PROPERTIES = { "なし": { "resistivity": 0 }, "グラスウール (24k)": { "resistivity": 8000 }, "グラスウール (32k)": { "resistivity": 12000 }, "手動入力": { "resistivity": -1 } };
    const FREQS = [50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000];
    let layer_data_a = [], layer_data_b = [];
    let results_df = null; let stlChart; let modalContext = { panel: null, index: -1 };
    const ui = { airGapInput: document.getElementById('air-gap-input'), absorbentSelect: document.getElementById('absorbent-select'), flowResistInput: document.getElementById('flow-resist-input'), calcButton: document.getElementById('calc-button'), exportCsvButton: document.getElementById('export-csv-button'), propALabel: document.getElementById('prop-a-label'), propBLabel: document.getElementById('prop-b-label'), f0Value: document.getElementById('f0-value'), summaryTableContainer: document.getElementById('summary-table-container'), stlChart: document.getElementById('stl-chart'), panelAContainer: document.getElementById('panel-a-container'), panelBContainer: document.getElementById('panel-b-container'), modal: document.getElementById('layer-modal'), modalTitle: document.getElementById('modal-title'), modalMatSelect: document.getElementById('modal-mat-select'), modalThickInput: document.getElementById('modal-thick-input'), modalRhoInput: document.getElementById('modal-rho-input'), modalEInput: document.getElementById('modal-e-input'), modalNuInput: document.getElementById('modal-nu-input'), modalOkBtn: document.getElementById('modal-ok-btn'), modalCancelBtn: document.getElementById('modal-cancel-btn'), formulaDisplay: document.getElementById('formula-display') };
    const calculatePanelProperties = (layers) => { if (!layers || layers.length === 0) return { thick: 0, m_prime: 0, stiff: 0, fc: Infinity }; const total_thickness = layers.reduce((sum, l) => sum + l.h, 0); const total_surface_density = layers.reduce((sum, l) => sum + l.rho * l.h, 0); const total_bending_stiffness = layers.reduce((sum, l) => { if (l.mat === '空気層') return sum; return sum + (l.E * Math.pow(l.h, 3)) / (12 * (1 - Math.pow(l.nu, 2))); }, 0); const c0 = 343.0; const fc_total = (total_bending_stiffness > 0) ? (Math.pow(c0, 2) / (2 * Math.PI)) * Math.sqrt(total_surface_density / total_bending_stiffness) : Infinity; return { thick: total_thickness, m_prime: total_surface_density, stiff: total_bending_stiffness, fc: fc_total }; };
    const calculateRandomIncidenceTL = (m_prime, freqs) => { const tl_normal = freqs.map(f => 20 * Math.log10(m_prime * f) - 42.5); const tl_random = tl_normal.map(tl0 => { if (tl0 <= 0) return tl0; const log_arg = 0.23 * tl0; return tl0 - 10 * Math.log10(log_arg); }); return { normal: tl_normal, random: tl_random }; };
    function updateFormulaDisplay(type, props) {
        let html = '';
        switch (type) {
            case 'single':
                html = `<h5>単層パネル（質量則）</h5><p>以下の質量則の近似式（ランダム入射）を用いて計算しています。</p><p><b>垂直入射:</b> $$ TL_0 \\approx 20 \\log_{10}(m'f) - 42.5 \\; (dB) $$</p><p><b>ランダム入射:</b> $$ TL_R \\approx TL_0 - 10 \\log_{10}(0.23 \\cdot TL_0) \\; (dB) $$</p><p>ここで、<br>\\(m'\\): パネルの面密度 (${props.m_prime.toFixed(1)} kg/m²)<br>\\(f\\): 周波数 (Hz)</p>`;
                break;
            case 'laminated':
                html = `<h5>積層パネル（等価単層モデル）</h5><p>積層パネルを、物性値が等価な一枚のパネルと見なして計算しています。<b>この計算は簡略化されたモデルであり、あくまで参考値です。</b></p><p><b>等価面密度 (\\(m'_{eq}\\)):</b> $$ m'_{eq} = \\sum_{i=1}^{n} \\rho_i h_i = ${props.m_prime.toFixed(1)} \\; (kg/m^2) $$</p><p><b>等価曲げ剛性 (\\(B_{eq}\\)):</b> $$ B_{eq} \\approx \\sum_{i=1}^{n} \\frac{E_i h_i^3}{12(1-\\nu_i^2)} $$</p><p>これらの等価物性値を用いて、単層パネルの質量則および臨界周波数を計算しています。</p>`;
                break;
            case 'double':
                html = `<h5>二重壁</h5><p>周波数帯域に応じて、以下の式を用いて計算しています。</p><p><b>共鳴周波数 (\\(f_0\\)):</b> $$ f_0 = \\frac{1}{2\\pi} \\sqrt{\\frac{\\rho_0 c_0^2 (m'_1 + m'_2)}{d \\cdot m'_1 m'_2}} = ${props.f0.toFixed(1)} \\; (Hz) $$</p><p><b>低周波域 (\\(f < f_0\\)):</b><br>パネル全体を一つの質量と見なす質量則で計算します。$$ TL_R \\approx 20 \\log_{1
