<!doctype html>
<html lang="ja">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HFR5WYG42Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HFR5WYG42Q'); // ページビュー自動送信
</script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RND Reader — Octave / 1/3 Octave (Shift-JIS CSV)</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  :root{--bg:#f8fafc;--card:#fff;--line:#e5e7eb;--text:#111827;--muted:#6b7280;--accent:#2563eb}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif}
  .container{max-width:1280px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .u{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .drop{flex:1;min-width:260px;text-align:center;padding:16px;border:2px dashed #cbd5e1;border-radius:12px;background:#f1f5f9}
  .drop.drag{background:#e0e7ff;border-color:#93c5fd}
  input[type="file"]{display:none}
  .btn{display:inline-block;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .files{margin-top:8px;font-size:13px;color:var(--muted)}
  .tabs{display:flex;gap:8px;margin-top:12px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-bottom:none;border-radius:10px 10px 0 0;background:#eef2ff;cursor:pointer}
  .tab.active{background:#fff;border-color:#c7d2fe}
  .panel{border:1px solid var(--line);border-radius:0 12px 12px 12px;background:#fff;padding:12px}
  .grid9{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .plot{width:100%;height:260px}
  details{margin-top:10px}
  summary{cursor:pointer;color:#374151}
  table{border-collapse:collapse;width:100%;font-size:12px}
  th,td{border:1px solid #e5e7eb;padding:6px 8px;text-align:right}
  th.sticky{position:sticky;left:0;background:#fff;z-index:1;text-align:left}
  .seriesTitle{font-weight:600;margin:16px 0 6px}
  .freqWrap{overflow:auto}
  .badge{display:inline-block;font-size:12px;color:#1f2937;background:#e5e7eb;border-radius:999px;padding:2px 8px;margin:2px 6px 0 0}
</style>
</head>
<body>
<div class="container">
  <h1>RND Reader <span class="u">— Octave / 1/3 Octave（Shift-JIS CSV・複数ファイル対応）</span></h1>
  <div class="row">
    <label class="btn" for="fileInput">ファイル選択（複数可）</label>
    <input id="fileInput" type="file" accept=".csv,.CSV,.rnd,.RND,.txt" multiple>
    <div id="drop" class="drop">ここにドラッグ＆ドロップ（RND/CSV, Shift-JIS, コンマ区切り）</div>
  </div>
  <div id="fileList" class="files"></div>

  <div class="tabs">
    <div class="tab active" data-tab="oct">OCT</div>
    <div class="tab" data-tab="thirdoct">1/3 OCT</div>
  </div>
  <div id="oct" class="panel"></div>
  <div id="thirdoct" class="panel" style="display:none"></div>
</div>

<script>
(() => {
  // 対象系列（9つ：3×3サブプロット）
  const SERIES_ORDER = [
    'Leq','LE','Lmax',
    'Lmin','LN1','LN2',
    'LN3','LN4','LN5'
  ];
  const EXCLUDE_ROWS = new Set(['Lp Over','Lp Under']); // 除外
  const LABEL_ROW_MAP = new Map([ // 表の左列（A列）に出る和文/略記ゆらぎケア（必要に応じ追加）
    ['Leq','Leq'],['LE','LE'],['Lmax','Lmax'],['Lmin','Lmin'],
    ['LN1','LN1'],['LN2','LN2'],['LN3','LN3'],['LN4','LN4'],['LN5','LN5'],
    ['Lp','Lp'],['Lp Over','Lp Over'],['Lp Under','Lp Under']
  ]);

  const state = { files: [], data: [] };
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');

  // タブ切替
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const id = t.dataset.tab;
      document.getElementById('oct').style.display = id==='oct' ? '' : 'none';
      document.getElementById('thirdoct').style.display = id==='thirdoct' ? '' : 'none';
    });
  });

  // DnD
  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();drop.classList.add('drag');});
  });
  ['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');});
  });
  drop.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
  fileInput.addEventListener('change', e => handleFiles(e.target.files));

  function handleFiles(fileListLike){
    const arr = Array.from(fileListLike || []);
    if(arr.length===0) return;
    state.files.push(...arr);
    renderFileList();
    Promise.all(arr.map(readRND)).then(results=>{
      state.data.push(...results.filter(Boolean));
      renderAll();
    });
  }

  function renderFileList(){
    if(state.files.length===0){ fileList.textContent = ''; return; }
    fileList.innerHTML = '<span>読み込み済み：</span>' + state.files.map(f=>`<span class="badge">${escapeHtml(f.name)}</span>`).join('');
  }

  // Shift-JIS 読込 → 解析
  async function readRND(file){
    const buf = await file.arrayBuffer();
    // Shift-JIS優先、失敗時はUTF-8フォールバック
    let text = '';
    try{
      text = new TextDecoder('shift_jis').decode(buf);
    }catch{ text = new TextDecoder('utf-8').decode(buf); }
    const rows = text.replace(/\r\n?/g,'\n').split('\n').map(r=>r.split(','));
    // ヘッダ行（8行目, 0始まりでは index=7）
    const headOct = rows[7].slice(1,14).map(s=>s.trim());       // B8:N8（13列）
    const head13  = rows[7].slice(14,47).map(s=>s.trim());      // O8:AU8（34列）

    // データ行 A10:A21（10行, index 9..20）
    const wanted = new Set(SERIES_ORDER); // 9行分
    const seriesOct = {}, series13 = {};
    for(const k of SERIES_ORDER){ seriesOct[k]=[], series13[k]=[]; }

    for(let r=9;r<=20 && r<rows.length;r++){
      const labelRaw = (rows[r][0]||'').trim();
      const label = LABEL_ROW_MAP.get(labelRaw) || labelRaw;
      if(EXCLUDE_ROWS.has(label)) continue;
      if(!wanted.has(label)) continue;

      const octVals = rows[r].slice(1,14).map(toNumOrNaN);   // B..N
      const thVals  = rows[r].slice(14,47).map(toNumOrNaN);  // O..AU
      seriesOct[label] = octVals;
      series13[label]  = thVals;
    }

    return {
      fileName: file.name,
      oct: { freqs: headOct, series: seriesOct },
      thirdoct: { freqs: head13, series: series13 }
    };
  }

  function toNumOrNaN(s){
    const t = (s||'').trim();
    if(!t || t==='-' || t==='-----') return NaN;
    const v = Number(t.replace(/[^0-9.+-]/g,'')); // 末尾に単位や空白が来ても念のため削除
    return Number.isFinite(v) ? v : NaN;
  }

  function renderAll(){
    renderTab('oct');
    renderTab('thirdoct');
  }

  function renderTab(kind){ // 'oct' or 'thirdoct'
    const mount = document.getElementById(kind);
    if(state.data.length===0){ mount.innerHTML='<div class="u">ファイルを読み込むと表示されます。</div>'; return; }
    const freqs = state.data[0][kind].freqs; // 先頭ファイルを採用（全ファイル同一前提）
    // ===== 3×3 サブプロット（系列ごと、トレース＝ファイル）=====
    const traces = [];
    const layout = {
      grid:{rows:3,columns:3,pattern:'independent'},
      margin:{l:50,r:10,t:30,b:40},
      legend:{orientation:'h'},
      showlegend:true
    };
    // 軸・タイトルの注釈
    layout.annotations = [];

    SERIES_ORDER.forEach((seriesName, idx)=>{
      const r = Math.floor(idx/3)+1;
      const c = (idx%3)+1;
      state.data.forEach((d,i)=>{
        const y = d[kind].series[seriesName] || [];
        traces.push({
          x: freqs,
          y: y,
          name: i===0 ? d.fileName : d.fileName,
          mode: 'lines+markers',
          xaxis: `x${idx+1}`,
          yaxis: `y${idx+1}`,
          hovertemplate: `${seriesName} · %{x}: %{y:.1f} dB<extra>${d.fileName}</extra>`
        });
      });
      layout[`xaxis${idx+1}`] = {title:'Frequency',type:'category',tickangle:-45};
      layout[`yaxis${idx+1}`] = {title:'dB',rangemode:'tozero'};
      layout.annotations.push({
        text: seriesName, xref:`x${idx+1} domain`, yref:`y${idx+1} domain`,
        x:0.02, y:0.98, showarrow:false, font:{size:12}
      });
    });

    const plotDivId = `${kind}-plot`;
    const plotDiv = document.createElement('div');
    plotDiv.id = plotDivId;
    plotDiv.className = 'plot'; // 高さは個別指定
    plotDiv.style.height = '900px'; // 3×3まとめて表示
    // ===== テーブル（系列ごと：行＝ファイル、列＝周波数）=====
    const tableWrap = document.createElement('div');
    SERIES_ORDER.forEach(seriesName=>{
      const h = document.createElement('div');
      h.className='seriesTitle';
      h.textContent = `${seriesName}（dB）`;
      tableWrap.appendChild(h);

      const freqDiv = document.createElement('div');
      freqDiv.className='freqWrap';
      const tbl = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      const th0 = document.createElement('th'); th0.className='sticky'; th0.textContent='File';
      trh.appendChild(th0);
      freqs.forEach(f=>{
        const th = document.createElement('th'); th.textContent=f; trh.appendChild(th);
      });
      thead.appendChild(trh); tbl.appendChild(thead);
      const tbody = document.createElement('tbody');
      state.data.forEach(d=>{
        const tr = document.createElement('tr');
        const td0 = document.createElement('td'); td0.className='sticky'; td0.textContent = d.fileName; tr.appendChild(td0);
        const y = d[kind].series[seriesName] || [];
        for(let i=0;i<freqs.length;i++){
          const td = document.createElement('td');
          const v = y[i];
          td.textContent = Number.isFinite(v) ? v.toFixed(1) : '';
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody);
      freqDiv.appendChild(tbl);
      tableWrap.appendChild(freqDiv);
    });

    // ===== パネルに配置 =====
    mount.innerHTML = '';
    // ファイル一覧（再掲）
    const badges = document.createElement('div');
    badges.className='files';
    badges.innerHTML = '<span>描画中のファイル：</span>' + state.data.map(d=>`<span class="badge">${escapeHtml(d.fileName)}</span>`).join('');
    mount.appendChild(badges);

    const grid = document.createElement('div');
    grid.className='card';
    grid.appendChild(plotDiv);
    mount.appendChild(grid);

    const det = document.createElement('details');
    const sum = document.createElement('summary');
    sum.textContent = '表（系列ごと・行＝ファイル、列＝周波数）を表示';
    det.appendChild(sum);
    const tableCard = document.createElement('div');
    tableCard.className='card';
    tableCard.appendChild(tableWrap);
    det.appendChild(tableCard);
    mount.appendChild(det);

    Plotly.newPlot(plotDivId, traces, layout, {responsive:true,displaylogo:false});
  }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])) }

})();
</script>
</body>
</html>
