<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RND Reader — 評価（等級図） / OCT / 1/3OCT</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  :root{--bg:#f8fafc;--card:#fff;--line:#e5e7eb;--text:#111827;--muted:#6b7280;--accent:#2563eb}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .drop{flex:1 1 220px;min-width:220px;min-height:120px;text-align:center;padding:12px;border:2px dashed #cbd5e1;border-radius:12px;background:#f1f5f9}
  .drop.drag{background:#e0e7ff;border-color:#93c5fd}
  input[type="file"].hiddenInput{display:none}
  .btn{display:inline-block;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
  .badge{display:inline-block;font-size:12px;color:#1f2937;background:#e5e7eb;border-radius:999px;padding:2px 8px;margin:0 4px 4px 0}
  .files{font-size:13px;color:#6b7280;margin:8px 0}
  .tabs{display:flex;gap:8px;margin-top:12px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-bottom:none;border-radius:10px 10px 0 0;background:#eef2ff;cursor:pointer}
  .tab.active{background:#fff;border-color:#c7d2fe}
  .panel{border:1px solid var(--line);border-radius:0 12px 12px 12px;background:#fff;padding:12px}
  .seriesTabs{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 8px}
  .seriesTab{padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#f3f4f6;cursor:pointer}
  .seriesTab.active{background:#fff;border-color:#c7d2fe}
  .plot{width:100%;height:720px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .ctrl{border:1px dashed #e5e7eb;border-radius:10px;padding:10px;background:#fafafa}
  .ctrl h3{margin:4px 0 8px;font-size:14px}
  .ctrl label{display:block;font-size:13px;margin:3px 0}
  .note{font-size:12px;color:#6b7280}
  table{border-collapse:collapse;width:100%;font-size:12px;margin-top:8px}
  th,td{border:1px solid #e5e7eb;padding:6px 8px}
  th.sticky,td.sticky{position:sticky;left:0;background:#fff;z-index:1}
  tr.avg-row{background-color:#fffacd;}
  .card{border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px}
</style>
</head>
<body>
<div class="container">
  <h1>RND Reader — 評価（等級図） / OCT / 1/3OCT</h1>

  <div class="row" id="dropRow"></div>

  <!-- 暗騒音補正 UI -->
  <div class="card" style="margin-top:12px;">
    <p style="margin-top:0; font-weight:600;">暗騒音補正の適用</p>
    <label><input type="radio" name="noiseCorrection" value="none" checked> 補正しない</label>
    <label style="margin-left: 15px;"><input type="radio" name="noiseCorrection" value="apply"> 補正する</label>

    <div id="noiseFileControls" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--line); display:none;">
      <label class="btn" for="noiseFileInput" style="margin-bottom:8px;">暗騒音ファイル選択（RND/CSV）</label>
      <input id="noiseFileInput" type="file" accept=".csv,.CSV,.rnd,.RND,.txt">
      <div id="noiseFileName" class="files"></div>
      <span class="note">Lmax系列の暗騒音レベル L<sub>b</sub> を含むファイルを選択</span>
    </div>
    <div id="status" class="files"></div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="rating">評価（等級図）</div>
    <div class="tab" data-tab="oct">OCT</div>
    <div class="tab" data-tab="thirdoct">1/3 OCT</div>
  </div>

  <div id="rating" class="panel">
    <div class="grid">
      <div id="rating-plot" class="plot"></div>
      <div class="ctrl">
        <h3>評価設定</h3>
        <label><input type="checkbox" id="tol2db" checked> 許容差 +2 dB</label>
        <div class="note">チェック切替時のみ再計算</div>
        <div id="rating-result" style="margin-top:8px"></div>
        <div id="rating-table"></div>
        <button id="csvBtn" class="btn" style="margin-top:6px;display:none">CSV書き出し</button>
      </div>
    </div>
  </div>

  <div id="oct" class="panel" style="display:none">
    <div class="seriesTabs" id="seriesTabs-oct"></div>
    <div id="oct-content"></div>
  </div>

  <div id="thirdoct" class="panel" style="display:none">
    <div class="seriesTabs" id="seriesTabs-thirdoct"></div>
    <div id="thirdoct-content"></div>
  </div>
</div>

<script>
(() => {
  // ===== 定数 =====
  const SERIES_ORDER = ['Lmax','Leq','LE','Lmin','LN1','LN2','LN3','LN4','LN5'];
  const GROUP_COUNT = 5;
  const EXCLUDE_ROWS = new Set(['Lp Over','Lp Under']);
  const LABEL_ROW_MAP = new Map([['Leq','Leq'],['LE','LE'],['Lmax','Lmax'],['Lmin','Lmin'],['LN1','LN1'],['LN2','LN2'],['LN3','LN3'],['LN4','LN4'],['LN5','LN5']]);

  const EVAL_FREQS   = [63,125,250,500];
  const CURVE_FREQS  = [63,125,250,500,1000,2000,4000];
  const REF_DB_EXT   = [53,43,36,30,24,18,12];
  const MAX_WIDTH = 560;

  const groups = Array.from({length:GROUP_COUNT}, ()=>({files:[],data:[]}));
  let activeBandTab = 'rating';
  let activeSeries  = 'Lmax';

  // ===== 暗騒音補正 UI =====
  let noiseMode = 'none';
  let noiseData = {oct:null, thirdoct:null};
  const noiseRadios = document.getElementsByName('noiseCorrection');
  const noiseFileControls = document.getElementById('noiseFileControls');
  const noiseFileInput = document.getElementById('noiseFileInput');
  const noiseFileName = document.getElementById('noiseFileName');

  noiseRadios.forEach(r=>{
    r.addEventListener('change',()=>{
      noiseMode = document.querySelector('input[name="noiseCorrection"]:checked').value;
      noiseFileControls.style.display = (noiseMode==='apply') ? '' : 'none';
      if(activeBandTab==='rating'){ if(anyData()) calcAndDrawRating(); } else { renderBand(activeBandTab); }
    });
  });
  noiseFileInput.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f){ noiseData={oct:null,thirdoct:null}; noiseFileName.textContent=''; return; }
    const d = await readRND(f);
    noiseData.oct = d ? {freqs: d.oct.freqs, Lb: (d.oct.series['Lmax']||[]).slice()} : null;
    noiseData.thirdoct = d ? {freqs: d.thirdoct.freqs, Lb: (d.thirdoct.series['Lmax']||[]).slice()} : null;
    noiseFileName.innerHTML = d ? `<span class="badge">${escapeHtml(f.name)}</span>` : '読込失敗';
    if(activeBandTab==='rating'){ if(anyData()) calcAndDrawRating(); } else { renderBand(activeBandTab); }
  });

  // ===== 入力UI =====
  const dropRow = document.getElementById('dropRow');
  for(let g=0; g<GROUP_COUNT; g++){
    const idx=g+1, box=document.createElement('div');
    box.className='drop';
    box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <strong>Group ${idx}</strong>
        <label class="btn">追加
          <input class="hiddenInput" id="fileInput${idx}" type="file" accept=".csv,.CSV,.rnd,.RND,.txt" multiple />
        </label>
      </div>
      <div class="hint">ドラッグ＆ドロップ（Shift-JIS/CSV）</div>
      <div class="files" id="files${idx}"></div>`;
    ['dragenter','dragover'].forEach(ev=>box.addEventListener(ev,e=>{e.preventDefault();box.classList.add('drag');}));
    ['dragleave','drop'].forEach(ev=>box.addEventListener(ev,e=>{e.preventDefault();box.classList.remove('drag');}));
    box.addEventListener('drop', e=>handleFiles(g, e.dataTransfer.files));
    box.querySelector(`#fileInput${idx}`).addEventListener('change', e=>handleFiles(g, e.target.files));
    dropRow.appendChild(box);
  }
  const status = document.getElementById('status');

  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const id=t.dataset.tab; activeBandTab=id;
      document.getElementById('rating').style.display = id==='rating'?'':'none';
      document.getElementById('oct').style.display     = id==='oct'?'':'none';
      document.getElementById('thirdoct').style.display= id==='thirdoct'?'':'none';
      if(id==='rating'){ if(anyData()) calcAndDrawRating(); } else { renderBand(id); }
      safeResize();
      makeSeriesTabs('oct'); makeSeriesTabs('thirdoct');
    });
  });

  // ===== RND/CSV 読み込み =====
  async function readRND(file){
    const buf=await file.arrayBuffer();
    let text=''; try{ text=new TextDecoder('shift_jis').decode(buf); } catch{ text=new TextDecoder('utf-8').decode(buf); }
    const rows=text.replace(/\r\n?/g,'\n').split('\n').map(r=>r.split(','));
    if(rows.length<21) return null;
    const headOct = rows[7].slice(1,14).map(s=>s.trim());
    const head13  = rows[7].slice(14,47).map(s=>s.trim());
    const seriesOct={}, series13={}; for(const k of SERIES_ORDER){ seriesOct[k]=[]; series13[k]=[]; }
    for(let r=9;r<=20 && r<rows.length;r++){
      const labelRaw=(rows[r][0]||'').trim();
      if(EXCLUDE_ROWS.has(labelRaw)) continue;
      if(!LABEL_ROW_MAP.has(labelRaw)) continue;
      const k=LABEL_ROW_MAP.get(labelRaw);
      seriesOct[k]=rows[r].slice(1,14).map(toNum);
      series13[k]=rows[r].slice(14,47).map(toNum);
    }
    return {fileName:file.name, oct:{freqs:headOct,series:seriesOct}, thirdoct:{freqs:head13,series:series13}};
  }
  const toNum=s=>{const t=(s||'').trim(); if(!t||t==='-'||t==='-----') return NaN; const v=Number(t.replace(/[^0-9.+-]/g,'')); return Number.isFinite(v)?v:NaN;};
  function handleFiles(groupIndex, filesLike){
    const arr=[...filesLike||[]]; if(!arr.length) return;
    groups[groupIndex].files.push(...arr);
    Promise.all(arr.map(readRND)).then(res=>{
      groups[groupIndex].data.push(...res.filter(Boolean));
      document.getElementById(`files${groupIndex+1}`).innerHTML = groups[groupIndex].data.map((d,i)=>`<span class="badge">G${groupIndex+1}-${i+1} ${escapeHtml(d.fileName)}</span>`).join('');
      const info=groups.map((gp,i)=>`G${i+1}:${gp.data.length}`).join('  ');
      status.textContent=`読み込み済みファイル数 → ${info}`;
      if(activeBandTab==='rating') calcAndDrawRating(); else renderBand(activeBandTab);
    });
  }
  const escapeHtml=s=>s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  const anyData=()=>groups.some(gp=>gp.data.length);

  // ===== 丸め(JIS偶数丸め, 小数1桁表示用) =====
  function roundJIS1(x){
    if(!Number.isFinite(x)) return x;
    const s = Math.sign(x)||1;
    const ax100 = Math.abs(x)*100;
    const h = Math.floor(ax100 + 1e-12);
    const tenth = Math.floor(h/10);
    const hundredth = h - tenth*10;
    const resid = ax100 - h;
    if(hundredth < 5) return s*(tenth/10);
    if(hundredth > 5) return s*((tenth+1)/10);
    if(resid > 1e-12) return s*((tenth+1)/10);
    return s*((tenth%2===0)?(tenth/10):((tenth+1)/10));
  }

  // ===== 暗騒音補正 Lc(表1+線形補間) =====
  const LC_TABLE = {
    6:[1.3,1.3,1.2,1.2,1.2,1.2,1.1,1.1,1.1,1.1],
    7:[1.0,1.0,1.0,0.9,0.9,0.9,0.9,0.9,0.8,0.8],
    8:[0.8,0.8,0.7,0.7,0.7,0.6,0.6,0.6,0.6,0.6],
    9:[0.6,0.6,0.6,0.5,0.5,0.5,0.5,0.5,0.5,0.5],
    10:[0.4,0.4,0.4,0.4,0.4,0.3,0.3,0.3,0.3,0.3],
    11:[0.3,0.3,0.3,0.3,0.3,0.3,0.2,0.2,0.2,0.2],
    12:[0.3,0.3,0.3,0.3,0.2,0.2,0.2,0.2,0.2,0.2],
    13:[0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.1,0.1,0.1],
    14:[0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.1,0.1]
  };
  function lcFromDelta(delta){
    if(!Number.isFinite(delta)) return 0;
    if(delta < 6 || delta >= 15) return 0;
    const d0 = Math.floor(delta);
    const frac = Math.min(0.999, Math.max(0, delta - d0));
    const c = Math.floor(frac*10);
    const y0 = LC_TABLE[d0][c];
    const y1 = (c===9) ? ( (d0===14)?0:LC_TABLE[d0+1][0] ) : LC_TABLE[d0][c+1];
    const t = (frac - c/10) / 0.1;
    return y0 + t*(y1 - y0);
  }

  // ===== 補正適用（Lmaxのみ） =====
  function correctedSeriesArray(kind, seriesName, dataObj){
    const arr = (dataObj[kind].series[seriesName]||[]).slice();
    if(seriesName!=='Lmax' || noiseMode!=='apply') return arr;
    const noise = (kind==='oct') ? noiseData.oct : noiseData.thirdoct;
    if(!noise || !noise.Lb?.length) return arr;
    return arr.map((v,i)=>{
      const Lb = noise.Lb[i];
      if(!Number.isFinite(v) || !Number.isFinite(Lb)) return v;
      const Lc = lcFromDelta(v - Lb);
      return v - Lc;
    });
  }

  // ===== エネルギー平均 =====
  function energyMean(values){
    const val = values.filter(v=>Number.isFinite(v));
    if(!val.length) return NaN;
    const lin = val.map(db=>10**(db/10));
    return 10*Math.log10(lin.reduce((a,b)=>a+b,0)/lin.length);
  }
  function groupEnergyAvg(gi,kind,sname,{omitCols=[]}={}){
    const gp=groups[gi]; if(!gp||!gp.data.length) return {y:[],labels:[]};
    const labels = gp.data[0][kind].freqs;
    const omit = omitCols.map(s=>s.toLowerCase());
    const idxKeep = labels.map((lab,i)=>omit.includes(String(lab).toLowerCase())?null:i).filter(i=>i!==null);
    const outLabels=idxKeep.map(i=>labels[i]);
    const out = idxKeep.map(i=>{
      const vals = gp.data.map(d=>correctedSeriesArray(kind,sname,d)[i]);
      return energyMean(vals);
    });
    return {y:out, labels:outLabels};
  }
  function globalAvgForRating_Oct_Lmax(){
    let labels=[]; for(const gp of groups){ if(gp.data.length){ labels=gp.data[0].oct.freqs; break; } }
    const idxKeep = labels.map((lab,i)=>(['sub','main'].includes(String(lab).toLowerCase())?null:i)).filter(i=>i!==null);
    const out = idxKeep.map(i=>{
      const perGroup=[];
      for(let g=0; g<GROUP_COUNT; g++){
        const gp=groups[g]; if(!gp.data.length) continue;
        const v = energyMean(gp.data.map(d=>correctedSeriesArray('oct','Lmax',d)[i]));
        if(Number.isFinite(v)) perGroup.push(v);
      }
      return perGroup.length? perGroup.reduce((a,b)=>a+b,0)/perGroup.length : NaN;
    });
    return {labels:idxKeep.map(i=>labels[i]), y:out};
  }

  // ===== 評価タブ =====
  const tolEl = document.getElementById('tol2db');
  tolEl.addEventListener('change', calcAndDrawRating);

  function computeShift(meas, ref, tol){ let need=-Infinity; for(let i=0;i<meas.length;i++) need=Math.max(need, meas[i]-ref[i]-tol); return Math.max(0,need); }
  function roundLr(L, tol){ const threshold=(tol===2)?2.0:2.5; const base=Math.floor(L/5)*5; return (L-base)<=threshold?base:base+5; }
  const roundInt=x=>Math.round(x);
  function pick(labels, values, targets){ const num=labels.map(s=>parseFloat(String(s).replace(/[^\d.]/g,''))); const idxs=targets.map(f=>num.findIndex(x=>Math.round(x)===f)); if(idxs.some(i=>i<0)) return null; return idxs.map(i=>values[i]); }
  function decisionFreqs(meas, ref, tol, freqs){ const diffs=meas.map((m,i)=>m-ref[i]-tol); const maxv=Math.max(...diffs), eps=1e-9; const idxs=diffs.map((v,i)=>Math.abs(v-maxv)<=eps?i:-1).filter(i=>i>=0); return idxs.map(i=>freqs[i]); }

  function calcAndDrawRating(){
    const fig = document.getElementById('rating-plot');
    const resDiv = document.getElementById('rating-result');
    const tableDiv = document.getElementById('rating-table');
    const csvBtn = document.getElementById('csvBtn');

    const any = groups.find(gp=>gp.data.length);
    if(!any){ fig.innerHTML=''; resDiv.innerHTML=''; tableDiv.innerHTML='<div class="note">各グループにRND/CSVを読み込んでください。</div>'; csvBtn.style.display='none'; return; }

    const gAvg = globalAvgForRating_Oct_Lmax();
    const labels = gAvg.labels;
    const yGlobal = gAvg.y;
    const yEval = pick(labels, yGlobal, EVAL_FREQS);
    if(!yEval || yEval.some(v=>!Number.isFinite(v))){ fig.innerHTML=''; resDiv.innerHTML=''; tableDiv.innerHTML='<div class="note">評価不可：必要バンド欠落。</div>'; csvBtn.style.display='none'; return; }

    const tol = tolEl.checked ? 2 : 0;
    const shift = computeShift(yEval, REF_DB_EXT.slice(0,4), tol);
    const Lcont = 30 + shift, Lint=Math.round(Lcont), Lr=roundLr(Lint,tol);
    const refShiftEval = REF_DB_EXT.slice(0,4).map(v=>v+shift);
    const diffs = yEval.map((m,i)=>m-refShiftEval[i]);
    const decFreqs = decisionFreqs(yEval, REF_DB_EXT.slice(0,4), tol, EVAL_FREQS);

    const width = Math.min(fig.parentElement.clientWidth, MAX_WIDTH);
    const traces=[], shapes=[], textTraces=[];
    const DEC_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--accent')?.trim() || '#2563eb';

    const FAMILY_FREQS = [63,125,250,500,1000,2000];
    for (let L = 30; L <= 80; L += 5) {
      const s = L - 30;
      traces.push({x:FAMILY_FREQS,y:REF_DB_EXT.map(v=>v+s),mode:'lines',line:{width:2,dash:'dot'},hoverinfo:'skip',showlegend:false});
    }
    traces.push({x:EVAL_FREQS,y:yEval,mode:'lines+markers',line:{width:3,color:'black',dash:'dot'},marker:{symbol:'diamond',size:9,color:'black'},name:'Global',showlegend:false});
    const shiftPlot = (Lr - 30);
    traces.push({x:EVAL_FREQS,y:REF_DB_EXT.slice(0,4).map(v=>v+shiftPlot),mode:'lines',line:{width:2,color:DEC_COLOR},hoverinfo:'skip',showlegend:false});

    const idx2k = CURVE_FREQS.indexOf(2000), yBase2k=REF_DB_EXT[idx2k], lrX=[],lrY=[],lrText=[];
    for (let L = 30; L <= 80; L += 5) {
      const y = yBase2k + (L - 30);
      shapes.push({type:'line',x0:2000,x1:2300,y0:y,y1:y,xref:'x',yref:'y',line:{color:'#111',width:1}});
      lrX.push(3995); lrY.push(y); lrText.push(`Lr-${L}`);
    }
    textTraces.push({x:lrX,y:lrY,text:lrText,mode:'text',textposition:'middle left',textfont:{size:11,color:'#000'},hoverinfo:'skip',showlegend:false,cliponaxis:false});
    textTraces.push({x:[900],y:[yEval[3]],text:[`Lr-${Lr}`],mode:'text',textposition:'bottom left',textfont:{size:11,color:'#000'},hoverinfo:'skip',showlegend:false,cliponaxis:false});

    const layout = {
      width, height: 640,
      margin: { l: 90, r: 110, t: 16, b: 50 },
      xaxis: { type:'log', range:[Math.log10(31.5), Math.log10(4000)], tickvals:[63,125,250,500,1000,2000,4000], ticktext:['63','125','250','500','1000','2000','4000'] },
      yaxis: { range:[30,110], dtick:10, title:'床衝撃音レベル (dB)' },
      showlegend:false, shapes
    };
    Plotly.newPlot('rating-plot', [...traces, ...textTraces], layout, { displaylogo:false, responsive:false });

    const decStr = decFreqs.map(f=>`${f} Hz`).join(', ');
    document.getElementById('rating-result').innerHTML = `評価結果：<span class="badge">Lr-${Lr}</span>　<span class="badge">L=${Lint}</span>（決定周波数：${decStr}、許容差=${tol} dB）`;

    let html='<table><thead><tr><th>Band (Hz)</th><th>Measured(Global, dB)</th><th>Ref+shift (dB)</th><th>Diff</th></tr></thead><tbody>';
    for(let i=0;i<EVAL_FREQS.length;i++){
      html += `<tr><td>${EVAL_FREQS[i]}</td><td>${roundJIS1(yEval[i]).toFixed(1)}</td><td>${roundJIS1(refShiftEval[i]).toFixed(1)}</td><td>${roundJIS1(diffs[i]).toFixed(1)}</td></tr>`;
    }
    html+='</tbody></table>';
    document.getElementById('rating-table').innerHTML = html;

    const csvBtn = document.getElementById('csvBtn');
    csvBtn.style.display='';
    csvBtn.onclick=()=>{
      const lines=[
        'Band,Measured_dB,RefShifted_dB,Diff_dB',
        ...EVAL_FREQS.map((f,i)=>`${f},${roundJIS1(yEval[i]).toFixed(1)},${roundJIS1(refShiftEval[i]).toFixed(1)},${roundJIS1(diffs[i]).toFixed(1)}`)
      ];
      const blob=new Blob([lines.join('\n')],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Global_Lmax_Rating_63-500.csv'; a.click(); URL.revokeObjectURL(a.href);
    };
  }

  // ===== シリーズタブ =====
  makeSeriesTabs('oct'); makeSeriesTabs('thirdoct');
  function makeSeriesTabs(kind){
    const wrap=document.getElementById(`seriesTabs-${kind}`); if(!wrap) return;
    wrap.innerHTML='';
    SERIES_ORDER.forEach(name=>{
      const t=document.createElement('div');
      const isActive=(activeBandTab===kind && activeSeries===name);
      t.className='seriesTab'+(isActive?' active':'');
      t.textContent=name;
      t.addEventListener('click',()=>{activeSeries=name; document.querySelectorAll('.seriesTab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); renderBand(kind);});
      wrap.appendChild(t);
    });
  }

  // ===== OCT / 1/3OCT：3×2（G1..G5 + 右下=各Gのエネ平均重ね描画） =====
  function renderBand(kind){
    let freqs=[]; for(const gp of groups){ if(gp.data.length){ freqs=gp.data[0][kind].freqs; break; } }
    const mount=document.getElementById(`${kind}-content`);
    if(!freqs.length){ mount.innerHTML='<div class="note">各グループにファイルを追加してください。</div>'; return; }

    const omitCols = (kind==='oct') ? ['Sub','Main'] : [];
    const rect = mount.getBoundingClientRect();
    const width = Math.min((rect.width||mount.parentElement.clientWidth||MAX_WIDTH), MAX_WIDTH);

    // マウント
    const plotDivId=`${kind}-plot`;
    const plotDiv=document.createElement('div'); plotDiv.id=plotDivId; plotDiv.className='plot';
    const tableWrap=document.createElement('div'); tableWrap.style.marginTop='8px';
    mount.innerHTML=''; mount.appendChild(plotDiv); mount.appendChild(tableWrap);

    const traces=[];
    const layout = {
      grid:{rows:3, columns:2, pattern:'independent'},
      width, height:720, margin:{l:60,r:20,t:20,b:40}, showlegend:false
    };

    // 1〜5枠：G1..G5（各ファイル＋グループ平均）
    for(let g=0; g<GROUP_COUNT; g++){
      const xa=`x${g+1}`, ya=`y${g+1}`;
      const gp=groups[g];
      if(gp.data.length){
        const labels = gp.data[0][kind].freqs;
        const omitLower = omitCols.map(s=>s.toLowerCase());
        const keepIdx = labels.map((lab,i)=>omitLower.includes(String(lab).toLowerCase())?null:i).filter(i=>i!==null);

        gp.data.forEach((d,idx)=>{
          const vec = correctedSeriesArray(kind,activeSeries,d);
          const x = keepIdx.map(i=>labels[i]);
          const y = keepIdx.map(i=>vec[i]);
          traces.push({x,y,mode:'lines+markers',marker:{size:5},name:`G${g+1}-${idx+1}`,xaxis:xa,yaxis:ya});
        });

        const gavg = groupEnergyAvg(g,kind,activeSeries,{omitCols});
        traces.push({
          x:gavg.labels,y:gavg.y,mode:'lines+markers',
          line:{width:2,color:'black',dash:'dot'},
          marker:{symbol:'diamond',size:7,color:'black'},
          name:`G${g+1} エネルギー平均`,xaxis:xa,yaxis:ya
        });
      }
      layout[`xaxis${g+1}`] = {type:'category',tickangle:-45,title:`G${g+1} (${activeSeries})`};
      layout[`yaxis${g+1}`] = {title:'dB'};
    }

    // 6枠：各Gのエネルギー平均を重ね描画
    {
      const xa='x6', ya='y6';
      for (let g=0; g<GROUP_COUNT; g++) {
        if (!groups[g].data.length) continue;
        const gavg = groupEnergyAvg(g, kind, activeSeries, { omitCols });
        traces.push({ x:gavg.labels, y:gavg.y, mode:'lines+markers', name:`G${g+1} エネルギー平均`, xaxis:xa, yaxis:ya });
      }
      layout['xaxis6'] = { type:'category', tickangle:-45, title:`G1–G5 エネルギー平均 (${activeSeries})` };
      layout['yaxis6'] = { title:'dB' };
    }

    Plotly.newPlot(plotDivId,traces,layout,{responsive:false,displaylogo:false});

    // テーブル
    let html='<table><thead><tr><th class="sticky">Series / Hz</th>'+freqs.map(f=>`<th>${f}</th>`).join('')+'</tr></thead><tbody>';
    for(let g=0; g<GROUP_COUNT; g++){
      const gp = groups[g]; if(!gp.data.length) continue;
      gp.data.forEach((d,idx)=>{
        const vec = correctedSeriesArray(kind,activeSeries,d);
        html += `<tr><td class="sticky">G${g+1}-${idx+1}</td>` +
          freqs.map((f,i)=>Number.isFinite(vec[i])?roundJIS1(vec[i]).toFixed(1):'').map(s=>`<td>${s}</td>`).join('') +
          '</tr>';
      });
      const full = groupEnergyAvg(g,kind,activeSeries,{omitCols});
      html += `<tr class="avg-row"><td class="sticky">G${g+1} エネルギー平均</td>` +
        full.labels.map((_,i)=>Number.isFinite(full.y[i])?roundJIS1(full.y[i]).toFixed(1):'').map(s=>`<td>${s}</td>`).join('') +
        '</tr>';
    }
    html += '</tbody></table>';
    tableWrap.innerHTML = html;
  }

  // ===== 初回 =====
  if(anyData()) calcAndDrawRating();

  // ===== リサイズ =====
  function safeResize(){
    if(activeBandTab==='rating'){
      const fig=document.getElementById('rating-plot');
      if(fig && fig.data){ const w=Math.min(fig.parentElement.clientWidth, MAX_WIDTH); Plotly.relayout(fig,{width:w,height:640}); }
    } else {
      ['oct','thirdoct'].forEach(id=>{
        const el=document.getElementById(`${id}-plot`);
        if(el && el.data){
          const rect = el.parentElement.getBoundingClientRect();
          const w = Math.min((rect.width||el.parentElement.clientWidth||MAX_WIDTH), MAX_WIDTH);
          Plotly.relayout(el,{width:w,height:720});
        }
      });
    }
  }
  window.addEventListener('resize', safeResize);
})();
</script>
</body>
</html>
