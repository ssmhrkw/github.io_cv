<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NA28 Floor Impact Sound Classifier — Octave / 1/3 Octave (Shift-JIS CSV)</title>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HFR5WYG42Q');
</script>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  :root{--bg:#f8fafc;--card:#fff;--line:#e5e7eb;--text:#111827;--muted:#6b7280;--accent:#2563eb}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif}
  .container{max-width:1280px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .u{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .drop{flex:1;min-width:260px;text-align:center;padding:16px;border:2px dashed #cbd5e1;border-radius:12px;background:#f1f5f9}
  .drop.drag{background:#e0e7ff;border-color:#93c5fd}
  input[type="file"]{display:none}
  .btn{display:inline-block;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .files{margin-top:8px;font-size:13px;color:var(--muted)}
  .tabs{display:flex;gap:8px;margin-top:12px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-bottom:none;border-radius:10px 10px 0 0;background:#eef2ff;cursor:pointer}
  .tab.active{background:#fff;border-color:#c7d2fe}
  .panel{border:1px solid var(--line);border-radius:0 12px 12px 12px;background:#fff;padding:12px}
  .plot{width:100%;height:260px}
  details{margin-top:10px}
  summary{cursor:pointer;color:#374151}
  table{border-collapse:collapse;width:100%;font-size:12px}
  th,td{border:1px solid #e5e7eb;padding:6px 8px;text-align:right}
  th.sticky{position:sticky;left:0;background:#fff;z-index:1;text-align:left}
  .seriesTitle{font-weight:600;margin:16px 0 6px}
  .freqWrap{overflow:auto}
  .badge{display:inline-block;font-size:12px;color:#1f2937;background:#e5e7eb;border-radius:999px;padding:2px 8px;margin:2px 6px 0 0}

  .gate-backdrop{position:fixed;inset:0;background:rgba(17,24,39,.6);display:flex;align-items:center;justify-content:center;z-index:9999}
  .gate-modal{width:min(640px,92vw);background:#fff;border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:20px 18px}
  .gate-title{font-size:18px;margin:0 0 8px}
  .gate-body{font-size:14px;color:#374151;line-height:1.6;margin-bottom:16px;white-space:pre-wrap}
  .gate-actions{display:flex;justify-content:flex-end;gap:8px}
  .gate-btn{appearance:none;border:1px solid #d1d5db;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .gate-hidden{display:none}
</style>
</head>
<body>
<div id="gate" class="gate-backdrop" role="dialog" aria-modal="true" aria-labelledby="gate-title">
  <div class="gate-modal">
    <h2 id="gate-title" class="gate-title">注意勧告</h2>
    <div id="gate-text" class="gate-body">
このツールは参考用です。結果の最終確認は利用者の責任で行ってください。
ファイルは端末内で処理されます。
    </div>
    <div class="gate-actions"><button id="gate-ok" class="gate-btn" type="button">OK</button></div>
  </div>
</div>

<div class="container" aria-hidden="true" id="app-root">
  <h1>NA28 Floor Impact Sound Classifier <span class="u">— Octave / 1/3 Octave（Shift-JIS CSV・複数ファイル対応）</span></h1>

  <div class="row">
    <label class="btn" for="fileInput">ファイル選択（複数可）</label>
    <input id="fileInput" type="file" accept=".csv,.CSV,.rnd,.RND,.txt" multiple>
    <div id="drop" class="drop">ここにドラッグ＆ドロップ（RND/CSV, Shift-JIS, コンマ区切り）</div>
  </div>
  <div id="fileList" class="files"></div>

  <div class="card" style="margin-top:12px;">
    <p style="margin-top:0;font-weight:600;">暗騒音補正の適用</p>
    <label><input type="radio" name="noiseCorrection" value="none" checked> 補正しない</label>
    <label style="margin-left:15px;"><input type="radio" name="noiseCorrection" value="apply"> 補正する</label>
    <div id="noiseFileControls" style="margin-top:10px;padding-top:10px;border-top:1px solid var(--line);display:none;">
      <label class="btn" for="noiseFileInput" style="margin-bottom:8px;">暗騒音ファイル選択（RND/CSV）</label>
      <input id="noiseFileInput" type="file" accept=".csv,.CSV,.rnd,.RND,.txt">
      <div id="noiseFileName" class="files"></div>
      <span class="u">Lmax列を含むファイルを選択</span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="oct">OCT</div>
    <div class="tab" data-tab="thirdoct">1/3 OCT</div>
  </div>
  <div id="oct" class="panel"></div>
  <div id="thirdoct" class="panel" style="display:none"></div>
</div>

<script>
/* 注意勧告ゲート */
(()=>{const g=document.getElementById('gate'),ok=document.getElementById('gate-ok'),app=document.getElementById('app-root');
function show(){document.body.style.overflow='hidden';g.classList.remove('gate-hidden');app.setAttribute('aria-hidden','true');ok.focus();}
function hide(){g.classList.add('gate-hidden');document.body.style.overflow='';app.removeAttribute('aria-hidden');}
ok.addEventListener('click',hide);g.addEventListener('keydown',e=>{if(e.key==='Escape'){e.preventDefault();}});
show();})();
</script>

<script>
(()=>{
  const SERIES_ORDER=['Leq','LE','Lmax','Lmin','LN1','LN2','LN3','LN4','LN5'];
  const PLOT_SERIES = ['Leq','LE','Lmax','Lmin','LN1'];
  const EXCLUDE_ROWS=new Set(['Lp Over','Lp Under']);
  const LABEL_ROW_MAP=new Map([['Leq','Leq'],['LE','LE'],['Lmax','Lmax'],['Lmin','Lmin'],['LN1','LN1'],['LN2','LN2'],['LN3','LN3'],['LN4','LN4'],['LN5','LN5'],['Lp','Lp'],['Lp Over','Lp Over'],['Lp Under','Lp Under']]);

  /* 表1（ΔL→Lc）。行=整数部6〜14，列=小数部0.0〜0.9。15以上は補正なし。 */
  const LC_TABLE = {
    6:[1.3,1.2,1.2,1.2,1.1,1.1,1.0,1.0,1.0,1.0],
    7:[1.0,1.0,0.9,0.9,0.9,0.8,0.8,0.8,0.8,0.8],
    8:[0.7,0.7,0.7,0.7,0.7,0.6,0.6,0.6,0.6,0.6],
    9:[0.6,0.6,0.6,0.5,0.5,0.5,0.5,0.5,0.5,0.5],
   10:[0.5,0.5,0.5,0.5,0.4,0.4,0.4,0.4,0.4,0.4],
   11:[0.4,0.4,0.3,0.3,0.3,0.3,0.3,0.3,0.3,0.3],
   12:[0.3,0.3,0.3,0.3,0.3,0.3,0.2,0.2,0.2,0.2],
   13:[0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.1,0.1],
   14:[0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1]
  };

  const state={files:[],data:[],noiseData:null,noiseMode:'none'};

  const drop=document.getElementById('drop');
  const fileInput=document.getElementById('fileInput');
  const fileList=document.getElementById('fileList');
  const noiseControls=document.getElementById('noiseFileControls');
  const noiseFileInput=document.getElementById('noiseFileInput');
  const noiseFileName=document.getElementById('noiseFileName');

  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const id=t.dataset.tab;
      document.getElementById('oct').style.display=id==='oct'?'':'none';
      document.getElementById('thirdoct').style.display=id==='thirdoct'?'':'none';
    });
  });

  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.add('drag');});
  });
  ['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');});
  });
  drop.addEventListener('drop',e=>handleFiles(e.dataTransfer.files));
  fileInput.addEventListener('change',e=>handleFiles(e.target.files));

  document.querySelectorAll('input[name="noiseCorrection"]').forEach(r=>{
    r.addEventListener('change',()=>{
      state.noiseMode=r.value;
      noiseControls.style.display=state.noiseMode==='apply'?'':'none';
      renderAll();
    });
  });

  noiseFileInput.addEventListener('change',async e=>{
    const f=e.target.files&&e.target.files[0];
    if(!f){state.noiseData=null;noiseFileName.textContent='';renderAll();return;}
    noiseFileName.innerHTML='<span>暗騒音：</span><span class="badge">'+escapeHtml(f.name)+'</span>';
    state.noiseData=await readNoiseRND(f);
    renderAll();
  });

  function handleFiles(fileListLike){
    const arr=Array.from(fileListLike||[]);
    if(arr.length===0) return;
    state.files.push(...arr);
    renderFileList();
    Promise.all(arr.map(readRND)).then(results=>{
      state.data.push(...results.filter(Boolean));
      renderAll();
    });
  }

  function renderFileList(){
    if(state.files.length===0){fileList.textContent='';return;}
    const labels=state.files.map((f,i)=>`<span class="badge">G1-${i+1}：${escapeHtml(f.name)}</span>`);
    fileList.innerHTML='<span>読み込み済み：</span>'+labels.join('');
  }

  async function readRND(file){
    const rows=await decodeToRows(file);
    if(!rows||rows.length<10) return null;
    const headOct=rows[7].slice(1,14).map(s=>s.trim());
    const head13=rows[7].slice(14,47).map(s=>s.trim());
    const seriesOct={},series13={};
    for(const k of SERIES_ORDER){seriesOct[k]=[];series13[k]=[];}
    for(let r=9;r<=20&&r<rows.length;r++){
      const labelRaw=(rows[r][0]||'').trim();
      const label=LABEL_ROW_MAP.get(labelRaw)||labelRaw;
      if(EXCLUDE_ROWS.has(label)) continue;
      if(!(label in seriesOct)) continue;
      const octVals=rows[r].slice(1,14).map(toNumOrNaN);
      const thVals =rows[r].slice(14,47).map(toNumOrNaN);
      seriesOct[label]=octVals; series13[label]=thVals;
    }
    return {fileName:file.name,oct:{freqs:headOct,series:seriesOct},thirdoct:{freqs:head13,series:series13}};
  }

  async function readNoiseRND(file){
    const rows=await decodeToRows(file);
    const headOct=rows[7].slice(1,14).map(s=>s.trim());
    const head13=rows[7].slice(14,47).map(s=>s.trim());
    let Lb_oct=new Array(headOct.length).fill(NaN);
    let Lb_13 =new Array(head13.length).fill(NaN);
    for(let r=9;r<=20&&r<rows.length;r++){
      const label=(rows[r][0]||'').trim();
      if(label==='Lmax'){
        Lb_oct=rows[r].slice(1,14).map(toNumOrNaN);
        Lb_13 =rows[r].slice(14,47).map(toNumOrNaN);
        break;
      }
    }
    return {oct:{freqs:headOct,Lb:Lb_oct},thirdoct:{freqs:head13,Lb:Lb_13}};
  }

  async function decodeToRows(file){
    const buf=await file.arrayBuffer();
    let text='';
    try{text=new TextDecoder('shift_jis').decode(buf);}catch{ text=new TextDecoder('utf-8').decode(buf); }
    return text.replace(/\r\n?/g,'\n').split('\n').map(r=>r.split(','));
  }

  function toNumOrNaN(s){
    const t=(s||'').trim();
    if(!t||t==='-'||t==='-----') return NaN;
    const v=Number(t.replace(/[^0-9.+-]/g,''));
    return Number.isFinite(v)?v:NaN;
  }

  /* JIS Z 8401 最近接偶数丸め */
  function roundHalfEven(x,digits){
    const p=Math.pow(10,digits);
    const y=x*p;
    const f=Math.floor(y);
    const frac=y-f;
    if(Math.abs(frac-0.5)<1e-12){return ((f%2===0)?f:f+1)/p;}
    return Math.round(y)/p;
  }
  function roundIntJIS(x){return roundHalfEven(x,0);}

  /* 表1に従う Lc。ΔL<6は補正不可→NaN。15以上は0。中間値は0.1刻みで線形補間。 */
  function lcFromDelta(dL){
    if(!Number.isFinite(dL)) return NaN;
    if(dL<6) return NaN;                 /* 添付 5.5 の扱い：6 dB未満は補正せず参考値 */
    if(dL>=15) return 0.0;
    const i0=Math.floor(dL);                      /* 6〜14 */
    const i1=Math.min(i0+1,14);
    const frac=dL-i0;

    const col = Math.floor((dL - i0)*10);        /* 0〜9 */
    const x0 = i0 + col/10;
    const x1 = Math.min(i0 + (col+1)/10, i1);

    const v0 = LC_TABLE[i0][col];
    const v1 = (col===9)? LC_TABLE[i1][0] : LC_TABLE[i0][col+1];
    /* 0.1区間内補間 */
    const t = (dL - x0) / (x1 - x0 + 1e-12);
    return v0 + t*(v1 - v0);
  }

  function correctLmaxArray(Lf,Lb){
    const out=new Array(Lf.length);
    for(let i=0;i<Lf.length;i++){
      const v=Lf[i], nb=Lb[i];
      if(!Number.isFinite(v)||!Number.isFinite(nb)){out[i]=NaN;continue;}
      const d=v-nb;
      const Lc=lcFromDelta(d);
      if(!Number.isFinite(Lc)){ out[i]=NaN; } else { out[i]=v-Lc; }
    }
    return out;
  }

  /* エネルギー平均。入力ベクトル群 rows の各列で計算。NaNは無視。 */
  function energyAverageRows(rows){
    if(rows.length===0) return [];
    const n=rows[0].length,out=new Array(n).fill(NaN);
    for(let k=0;k<n;k++){
      let sum=0,m=0;
      for(let i=0;i<rows.length;i++){
        const v=rows[i][k];
        if(Number.isFinite(v)){sum+=Math.pow(10,v/10);m++;}
      }
      if(m>0){ out[k]=10*Math.log10(sum/m); }
    }
    return out;
  }

  /* 添付 5.6: 平均レベル Lfmax,k は整数。個々の測定値は0.1桁。 */
  function applyRoundingForDisplay(seriesName, vec, kind){
    if(seriesName==='Lmax' && kind){ /* Lfmax,k 用整数丸めに使う時は別途処理する */
      return vec.map(v=>Number.isFinite(v)?roundIntJIS(v):NaN);
    }
    return vec.map(v=>Number.isFinite(v)?roundHalfEven(v,1):NaN);
  }

  function renderAll(){ renderTab('oct'); renderTab('thirdoct'); }

  function renderTab(kind){
    const mount=document.getElementById(kind);
    if(state.data.length===0){ mount.innerHTML='<div class="u">ファイルを読み込むと表示されます。</div>'; return; }

    const freqs=state.data[0][kind].freqs;
    const useCorrection=(state.noiseMode==='apply'&&state.noiseData&&state.noiseData[kind]&&Array.isArray(state.noiseData[kind].Lb));

    const seriesMatrix={}; SERIES_ORDER.forEach(s=>seriesMatrix[s]=[]);
    const LmaxCorrected=[];
    state.data.forEach((d,fi)=>{
      SERIES_ORDER.forEach(s=>{ seriesMatrix[s].push(d[kind].series[s]||[]); });
      const LmaxArr=d[kind].series['Lmax']||[];
      LmaxCorrected.push(useCorrection?correctLmaxArray(LmaxArr,(state.noiseData[kind].Lb||[])):LmaxArr.slice());
    });

    /* エネルギー平均（Lmaxは補正後で計算） */
    const energyMeanBySeries={};
    SERIES_ORDER.forEach(s=>{
      const rows=(s==='Lmax')?LmaxCorrected:seriesMatrix[s];
      const mean=energyAverageRows(rows);
      if(s==='Lmax'){
        energyMeanBySeries[s+'_int']=applyRoundingForDisplay('Lmax',mean,true); /* 整数表示用（Lfmax,k） */
        energyMeanBySeries[s]=applyRoundingForDisplay('other',mean,false);       /* 図用に0.1表示も保持 */
      }else{
        energyMeanBySeries[s]=applyRoundingForDisplay('other',mean,false);
      }
    });

    /* 図: 3x2。1〜5に先頭5系列。6に全系列のエネルギー平均（Lmaxは0.1表示） */
    const traces=[],layout={grid:{rows:3,columns:2,pattern:'independent'},margin:{l:50,r:10,t:30,b:40},legend:{orientation:'h'},showlegend:true,annotations:[]};

    PLOT_SERIES.forEach((seriesName,idx)=>{
      const ax=idx+1;
      state.data.forEach((d,fi)=>{
        const label=`G1-${fi+1}`;
        const y=(seriesName==='Lmax')?LmaxCorrected[fi]:(d[kind].series[seriesName]||[]);
        traces.push({x:freqs,y:y,name:label,mode:'lines+markers',xaxis:`x${ax}`,yaxis:`y${ax}`,
          hovertemplate:`${seriesName} · %{x}: %{y:.1f} dB<extra>${label}</extra>`});
      });
      layout[`xaxis${ax}`]={title:'Frequency',type:'category',tickangle:-45};
      layout[`yaxis${ax}`]={title:'dB',rangemode:'tozero'};
      layout.annotations.push({text:seriesName,xref:`x${ax} domain`,yref:`y${ax} domain`,x:0.02,y:0.98,showarrow:false,font:{size:12}});
    });

    const ax6=6;
    SERIES_ORDER.forEach(seriesName=>{
      const y=(seriesName==='Lmax')?energyMeanBySeries['Lmax']:(energyMeanBySeries[seriesName]||[]);
      traces.push({x:freqs,y:y,name:`${seriesName} 平均`,mode:'lines+markers',xaxis:`x${ax6}`,yaxis:`y${ax6}`,
        hovertemplate:`Mean · %{x}: %{y:.1f} dB<extra>${seriesName}</extra>`});
    });
    layout[`xaxis${ax6}`]={title:'Frequency',type:'category',tickangle:-45};
    layout[`yaxis${ax6}`]={title:'dB',rangemode:'tozero'};
    layout.annotations.push({text:'全系列 エネルギー平均',xref:`x${ax6} domain`,yref:`y${ax6} domain`,x:0.02,y:0.98,showarrow:false,font:{size:12}});

    const plotDivId=`${kind}-plot`;
    const plotDiv=document.createElement('div'); plotDiv.id=plotDivId; plotDiv.className='plot'; plotDiv.style.height='900px';

    /* 表 */
    const tableWrap=document.createElement('div');
    SERIES_ORDER.forEach(seriesName=>{
      const h=document.createElement('div'); h.className='seriesTitle'; h.textContent=`${seriesName}（dB）`; tableWrap.appendChild(h);
      const freqDiv=document.createElement('div'); freqDiv.className='freqWrap';
      const tbl=document.createElement('table');
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      const th0=document.createElement('th'); th0.className='sticky'; th0.textContent='File'; trh.appendChild(th0);
      freqs.forEach(f=>{const th=document.createElement('th'); th.textContent=f; trh.appendChild(th);});
      thead.appendChild(trh); tbl.appendChild(thead);
      const tbody=document.createElement('tbody');

      state.data.forEach((d,fi)=>{
        const tr=document.createElement('tr');
        const td0=document.createElement('td'); td0.className='sticky'; td0.textContent=`G1-${fi+1}`; tr.appendChild(td0);
        let y=(seriesName==='Lmax')?LmaxCorrected[fi]:(d[kind].series[seriesName]||[]);
        /* 個別の測定値は0.1桁 JIS丸め */
        y=y.map(v=>Number.isFinite(v)?roundHalfEven(v,1):NaN);
        for(let i=0;i<freqs.length;i++){
          const td=document.createElement('td'); const v=y[i]; td.textContent=Number.isFinite(v)?v.toFixed(1):''; tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });

      const meanRow=document.createElement('tr'); meanRow.setAttribute('style','background-color:#fffacd;');
      const tdTitle=document.createElement('td'); tdTitle.className='sticky'; tdTitle.textContent='エネルギー平均'; meanRow.appendChild(tdTitle);
      const yMean=(seriesName==='Lmax')?energyMeanBySeries['Lmax_int']:energyMeanBySeries[seriesName];
      for(let i=0;i<freqs.length;i++){
        const td=document.createElement('td'); const v=yMean[i];
        if(seriesName==='Lmax'){ td.textContent=Number.isFinite(v)?String(v):''; }
        else{ td.textContent=Number.isFinite(v)?v.toFixed(1):''; }
        meanRow.appendChild(td);
      }
      tbody.appendChild(meanRow);

      tbl.appendChild(tbody); freqDiv.appendChild(tbl); tableWrap.appendChild(freqDiv);
    });

    mount.innerHTML='';
    const badges=document.createElement('div'); badges.className='files';
    const labels=state.data.map((d,i)=>`<span class="badge">G1-${i+1}：${escapeHtml(d.fileName)}</span>`);
    badges.innerHTML='<span>描画中のファイル：</span>'+labels.join('');
    mount.appendChild(badges);

    const grid=document.createElement('div'); grid.className='card'; grid.appendChild(plotDiv); mount.appendChild(grid);
    const det=document.createElement('details'); const sum=document.createElement('summary'); sum.textContent='表（系列ごと・行＝ファイル、列＝周波数）を表示';
    det.appendChild(sum); const tableCard=document.createElement('div'); tableCard.className='card'; tableCard.appendChild(tableWrap); det.appendChild(tableCard); mount.appendChild(det);

    Plotly.newPlot(plotDivId,traces,layout,{responsive:true,displaylogo:false});
  }

  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
})();
</script>
</body>
</html>

