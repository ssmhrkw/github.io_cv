はい、承知いたしました。ご提示のHTML/JavaScriptコードに基づき、**「手をたたいて残響時間を推定するWebアプリ」**の概要、技術的な仕組み、および具体的な使い方を、初心者の方にも分かりやすいようにMarkdown形式でまとめます。

---

# 🔊 手拍子で残響時間 (RT) を推定するアプリ

このツールは、スマートフォンなどのマイクで録音した**手拍子の音**（インパルス応答）を解析し、部屋の**残響時間 (Reverberation Time, RT)** を簡易的に推定するコンセプトアプリです。

## 💡 アプリの仕組みと技術的要素

残響時間（RT）とは、室内の音が60 dB減衰するのにかかる時間です。このアプリでは、以下の主要な音響解析手法を用いてRTを推定します。

### 1. 録音とフィルタリング
1.  **インパルス応答の代用**: 強い**手拍子**を、部屋の音響特性を表す**インパルス応答 (IR)** の代わりとして使います。
2.  **帯域分割 (BPF)**: 録音された音を、人間が聴く周波数帯域（63 Hzから4 kHzなど）に合わせて**オクターブバンドパスフィルター**で分割します。これは、残響時間が周波数によって異なるためです。

### 2. 残響減衰曲線の作成
* **シュレーダー積分**: 分割された各周波数帯域の信号に対し、**シュレーダーの逆積分**という手法を適用し、音のエネルギーが時間とともにどのように減衰していくかを示す、滑らかな**減衰曲線**を作成します。

### 3. 残響時間の計算
* **直線回帰 (T30/T20/T10/EDT)**: 作成した減衰曲線上の特定のデシベル範囲（例：-5 dBから-35 dB）を直線で近似する（**直線回帰**）ことで、その傾きからRTを推定します。
    * **T30**: -5 dBから-35 dBの範囲から推定（最も一般的）。
    * **T20**: -5 dBから-25 dBの範囲から推定。
    * **T10**: -5 dBから-15 dBの範囲から推定。
    * **EDT (Early Decay Time)**: 0 dBから-10 dBの初期の減衰から推定。
* **BGノイズ補正**: オプションで、録音前の**暗騒音**のエネルギーを減衰曲線から差し引くことで、より正確なRTを推定しようとします。

### 4. 測定の信頼性評価 (SNR)
* **SNR 判定**: 測定結果の信頼性を評価するため、手拍子直後の信号パワーと、手拍子前の暗騒音パワーの比である**SNR (信号対雑音比)** を計算します。
    * **全体判定「OK」の基準**: ほとんどの周波数帯域で**SNRが20 dB以上**であること。（20 dB未満の場合は、減衰曲線の末尾が暗騒音に埋もれている可能性があり、RTの値の信頼性が低いとされます。）

---

## 🚀 はじめての使い方（クイックガイド）

### ⚠️ はじめに（重要）
このツールは簡易測定用です。使用前に「**測定結果の正確性について保証はできません**」という警告を確認し、同意する必要があります。

### ステップ 1: 録音する
1.  **静かな環境**を確保します。
2.  「1) 測定と入力」セクションの**「録音長（秒）」**を設定します（デフォルトは5秒）。
3.  **「録音開始」**ボタンを押します。
4.  ボタンを押した後、**約1秒待ってから、一度だけ強く、手を叩いてください。**
5.  設定した録音時間が経過するか、**「停止」**ボタンを押すと録音が終了し、音声が再生されます。
6.  `state` が `recorded` になったら成功です。

### ステップ 2: 解析設定
1.  **「2) 解析・判定設定」**セクションを確認します。
2.  **「帯域」**を選択します。（初めての場合はデフォルトの「1/1 Octave」のままで構いません）
3.  **「BGノイズ補正」**はチェックを入れたままを推奨します。
4.  **「手動で回帰区間を決定する」**は、**最初はチェックを外したまま**自動解析を行います。

### ステップ 3: 解析と結果の確認
1.  **「解析する」**ボタンを押します。
2.  しばらく待つと、結果が「3) 結果（帯域別）」と「4) 減衰曲線（詳細）」に表示されます。

#### 📢 確認のポイント
* **全体判定**: 「2) 解析・判定設定」の**「全体判定」**が**「OK」**になっているか確認してください。NGの場合、SNR不足のため、信頼できるRTは得られていません。（もっと静かな環境で録音し直すか、もっと大きな音で叩く必要があります。）
* **残響時間（RT）**: 「3) 結果（帯域別）」の表で、各中心周波数（$f_c$）の**T30 [s]** の値を確認します。これが、その周波数帯の残響時間の推定値です。
* **減衰曲線**: 「4) 減衰曲線（詳細）」で、選択した帯域の**減衰曲線（Schroeder）**が滑らかに直線的に減衰しているか確認してください。

### ステップ 4: 詳細な確認と手動解析 (応用)
1.  **手動回帰**を使いたい場合は、「手動で回帰区間を決定する」にチェックを入れます。
2.  「4) 減衰曲線（詳細）」で**「表示帯域」**を選びます。
3.  グラフ上で、減衰曲線の直線的な部分をマウスで**ドラッグして選択**すると、**「開始時間[s]」**と**「終了時間[s]」**に値が自動入力されます。
4.  **「T20を手動計算」**ボタンを押し、手動で決定した範囲での残響時間を確認できます。

**備考**: **T30**は減衰範囲が広いため、SNRが低いとノイズの影響を受けやすく不安定になりがちです。SNRが低い測定結果では、**EDT**や**T10**の値がより信頼できる傾向があります。


承知いたしました。提供されたHTML/JavaScriptコードについて、音響解析の専門家向けに、使用されている主要な技術、アルゴリズムの詳細、およびISO 3382に準拠するための工夫点や限界について詳細に説明します。

---

## 💻 手拍子残響時間推定アプリ: 技術詳細（専門家向け）

このWebアプリケーションは、ブラウザネイティブのAPIとカスタム実装された音響処理アルゴリズムを利用して、インパルス応答（IR）の代替としての**手拍子（Clap）**を用いた残響時間（RT）の簡易推定を実現しています。

### 1. 測定と信号入力 (Recording & Input)

| 要素 | 詳細 | 専門的観点 |
| :--- | :--- | :--- |
| **API** | `navigator.mediaDevices.getUserMedia`、`MediaRecorder`、`AudioContext.decodeAudioData` | マイク入力にWeb Audio APIを使用。`constraints`として`echoCancellation:false`, `noiseSuppression:false`, `autoGainControl:false`を指定し、**デバイス側の非線形信号処理**（特にAGC）を抑制することを試みています。 |
| **サンプリング周波数** | `AudioContext`初期化時に**48000 Hz**を指定。 | 処理効率と、少なくとも20 kHzまでの帯域をカバーするため（ナイキスト周波数）。 |
| **トリガー検出** | `detectClapStart`関数 | 信号の最大絶対値（ピーク）を探索し、指定された閾値（デフォルト**−20 dBFS**）と比較。ピーク前の短い時間（0.01 s）をIRの開始点として推定し、**IRの切り出し（窓処理）**を行います。 |
| **暗騒音窓** | 手拍子検出点より前の**0.5秒間**。 | ISO 3382の要求を満たすために、残響解析に影響を与える前の**暗騒音パワー**を推定する窓として使用されます。 |
| **解析信号長** | 手拍子検出点から**1.0秒**に固定。 | 部屋の容積が小さくRTが短いと想定されるため、1.0 sに制限されています。 |

---

### 2. 信号処理と解析アルゴリズム (Signal Processing & Analysis)

#### 周波数帯域フィルタリング (Bandpass Filtering)
* **フィルター種別**: 帯域によって**1/1オクターブ**または**1/3オクターブ**のいずれかを選択。
* **アルゴリズム**: `designButterworthBandpassSOS_N` で設計された**N次バタワースIIRフィルター**を使用。
    * **1/1オクターブ**: $\text{N}=36$ 次（SOS (Second-Order Section) 18段）。
    * **1/3オクターブ**: $\text{N}=24$ 次（SOS 12段）。
* **フィルター特性**: ISO 3382では、通常、高性能なデジタルフィルター（例：高次のFIRまたは厳密なIIR設計）が必要です。この実装は、計算量と精度のバランスを取った簡易的なIIR設計です。

#### シュレーダー逆積分 (Schroeder's Integration)
* **基本原理**: フィルター処理された信号 $y(n)$ のエネルギー $E(n) = y^2(n)$ に対し、逆時間積分 $D(t) = \int_t^{T} E(\tau) d\tau$ を行います。
* **ノイズ補正**: `schroederDBNoiseComp`関数にて、ISO 3382-1で推奨される**暗騒音補正**をオプションで実装。
    $$D_{comp}(t) = \int_t^{T} (\text{max}(0, E(\tau) - P_{BG})) d\tau$$
    ここで、$P_{BG}$ は手拍子前の暗騒音パワー（0.5 s窓の平均二乗値）です。これにより、暗騒音に埋もれた減衰末尾の積分を抑制し、RT推定の限界を広げます。

#### 残響時間推定 (RT Estimation)
* **手法**: 減衰曲線 $L(t) = 10 \log_{10}(D(t)/D(0))$ [dB] 上での**最小二乗直線回帰**（`linreg`関数）。
* **指標と回帰範囲**:
    * **EDT**: 0 dB $\to$ -10 dB （$\text{RT}_{60} = 6 \times \text{EDT}$)
    * **T10**: -5 dB $\to$ -15 dB （$\text{RT}_{60} = 6 \times \text{T}10$)
    * **T20**: -5 dB $\to$ -25 dB （$\text{RT}_{60} = 3 \times \text{T}20$)
    * **T30**: -5 dB $\to$ -35 dB （$\text{RT}_{60} = 2 \times \text{T}30$)
* **優先順位**: 信頼性の高いT30から順に、**T30 $\to$ T20 $\to$ T10 $\to$ EDT** の順で代表RTとして選択されます。

---

### 3. 測定品質の評価 (Measurement Quality)

#### 信号対雑音比 (SNR)
* **定義**: $\text{SNR} = 10 \log_{10} \left( \frac{P_{\text{Sig}}}{P_{\text{BG}}} \right)$ [dB]
    * $P_{\text{Sig}}$: 手拍子直後**200 ms**の平均パワー。
    * $P_{\text{BG}}$: 手拍子前の**500 ms**の平均暗騒音パワー。
* **判定基準**: **中央値SNR $\ge 20 \text{ dB}$** で全体「OK」と判定。
    * **専門的意義**: ISO 3382では、RT30の安定した推定には通常**45 dB以上のSNR**が必要とされます。本アプリの20 dB基準は、簡易測定としての最低限の信頼性ラインであり、T30の推定が困難であることを示唆します。

#### 信頼性警告 (!! / ※)
* **!! (信頼性警告)**:
    1.  T10/T20/T30のいずれかが**10秒以上**の異常な長さ。
    2.  T10, T20, T30 の相対差が**10%以上**（$|T_{\text{max}} - T_{\text{min}}| \ge 0.1 \times T_{\text{min}}$）。これは**減衰曲線の非線形性**や**測定ノイズ**が大きいことを示します。
* **※ (ショートRT不一致警告)**:
    1.  T10, T20, T30 が全て**1.0秒以下**。
    2.  かつ、それらの最大差が**0.3秒以上**。これは、RTが非常に短い環境で、指標間に大きな不一致（初期減衰と中期減衰の差）が生じていることを示します。

---

### 4. ユーザーインターフェースと可視化

* **Plotly**: 専門的な減衰曲線のグラフ表示に利用。ユーザーが特定の周波数帯を選択し、回帰範囲（EDT, T10, T20, T30）を視覚的に確認できます。
* **手動回帰**: グラフ上でドラッグ選択された時間窓（$t_1 \to t_2$）に基づき、任意の区間でのT20を再計算する機能。これは自動解析結果に不審な点がある場合に、測定者が回帰範囲を強制的に指定するためのものです。
* **波形表示**: 信号の切り出し位置（手拍子点、暗騒音窓、信号窓）を元の波形上で視覚的に示し、測定者が手拍子のタイミングが適切であったかをフィードバックします。
* **$R^2$ (決定係数)**: 直線回帰の適合度を示す指標として表示。高い$R^2$（例：0.95以上）は、減衰がほぼ直線的であり、回帰推定の信頼性が高いことを示します。

---

### ⚠️ ISO 3382 準拠の限界

本アプリは「コンセプト」であり、ISO 3382規格に照らし合わせた場合、以下のような本質的な限界があります。

1.  **音源の不確実性**: 手拍子は真のインパルス応答ではなく、再現性のある**全方向性**の音源でもありません。
2.  **マイクと校正**: 一般的なスマートフォンマイクは、**周波数特性が平坦ではない**（特に低域）上、**音圧レベルの絶対校正**が行われていません。
3.  **積分範囲の制約**: SNR不足により、特にT30の推定に必要な$\mathbf{-35 \text{ dB}}$までの減衰をノイズフロアの上で確保することが極めて困難です。
4.  **測定回数**: ISO規格は複数点での測定と平均化を要求しますが、本アプリの簡易版ではその機能は限定的です。
