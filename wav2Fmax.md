# wav2Fmax — Pro v3: HTML/JavaScript 詳細分析

このドキュメントは、提供されたHTMLファイルが構築しているウェブアプリケーションの構造、機能、および実装ロジックについて詳細に説明します。<br>
このアプリは、WAVまたはCSV形式の音響データを読み込み、**オクターブバンド分析**を行い、**音響レベル（$L_{\text{Fmax}}$、$L_{\text{eq}}$など）**を計算・表示するためのものです。

---

## 💻 アプリケーション概要

| 項目 | 詳細 |
| :--- | :--- |
| **名称** | `wav2Fmax — Pro v3` |
| **機能** | 音響ファイル（WAV/CSV）の読み込み、バターワースバンドパスフィルタを用いたオクターブバンド分析、時間重み付け（Fast/Slow/$L_{\text{eq}}$）、音響指標（最大値、等価レベル、パーセンタイルレベル）の計算、結果のテーブル・グラフ表示。|
| **技術** | HTML5, CSS3, バニラJavaScript (ES Module), Plotly.js (グラフ描画) |

---

## 🛠️ HTML `<head>` 要素の構成

| 要素 | 内容/目的 |
| :--- | :--- |
| `charset/viewport` | **UTF-8**での文字エンコーディング、およびモバイルフレンドリーなビューポート設定。 |
| `<title>` | `wav2Fmax — Pro v3` を表示。 |
| Google Analytics | `gtag.js` を使用したアクセス解析。 |
| **カスタムESモジュール** | 外部ファイル **`acoustics-core.js`** から音響信号処理のための多数の関数（`designButterworthBandpassSOS_N`, `sosFilter`, `ewmaSquaredToSPL`, `percentile` など）をインポートし、グローバルスコープ（`window`）に割り当てて、処理ロジック内で利用可能にしています。 |
| **Plotly.js** | グラフ描画ライブラリをCDNから読み込み、解析結果の時系列プロットやスペクトル表示に使用します。 |
| `<style>` | アプリケーション全体の**デザイン定義**。特に処理中のボタンの強制的な赤色表示（`#process-btn.processing`）や、計算中のオーバーレイ表示（`#overlay`）のスタイルが含まれます。 |

---

## 🖥️ UI要素と機能

アプリケーションのUIは、ファイル読み込み、設定、結果表示の3つの主要なセクションに分かれています。

### 1. ファイル操作エリア

| ID/クラス | 機能 |
| :--- | :--- |
| `#file-input` | **ファイル選択** (`.wav`, `.csv`, `.txt` の複数選択可)。 |
| `#load-btn` | 選択ファイルを読み込み、WAVデコードまたはCSVパースを実行し、設定エリアを表示させます。 |
| `#file-name` | 読み込んだファイル名を表示。 |
| `#status` | 処理状況（`Ready`, `Loading...`, `Processed` など）を表示。 |

### 2. チャンネル設定 (`#setup`)

ファイルロード後に表示されます。WAVのチャンネル数、またはCSV/TXTの列数に基づき設定項目が生成されます。

- **Useチェックボックス**: 解析対象とするチャンネルを選択（$g.setup$ に状態を保存）。
- **Roleプルダウン**: チャンネルの役割（Microphone, Accelerometerなど）を選択。
- **Correction × (Gain)**: 信号の補正係数（ゲイン）を設定。

### 3. 解析設定 (`#config`)

| ID | 機能/設定項目 | デフォルト値 |
| :--- | :--- | :--- |
| `#band-type` | **周波数バンド**のタイプ: `1/1 Octave` または `1/3 Octave` を選択。 | `oct` (1/1 Octave) |
| `#band-lo`, `#band-hi` | 解析対象とする**中心周波数**の範囲（下限/上限）。 | リストの最初/最後 |
| `#time-weight` | **時間重み付け**（平均化方法）: `None`, `Fast` ($125 \text{ ms}$), `Slow` ($1 \text{ s}$), `Leq` (窓長), `MaxHold` を選択。| `fast` |
| `#leq-win` | `Leq` 選択時の**積分時間窓長**（秒）。 | $1.0$ 秒 |
| `#csv-sr` | CSV/TXTファイル使用時の**サンプリング周波数** ($SR$)。WAVの場合はWAVヘッダーから取得した値に更新されます。| $25600 \text{ Hz}$ |
| `#has-header` | CSV/TXTファイルに**ヘッダー行**が含まれるか。 | `checked` |
| `#process-btn` | 設定に基づき**音響解析**を開始します。処理中はクラスが`processing`に変化し、オーバーレイが表示されます。 |

### 4. 結果表示エリア (`#summary`)

- **`#tabs`**: `$L_{\text{Fmax}}$ 等の計算結果を切り替える**チャンネルタブ**。`#setup`で`use`に設定されたチャンネル分だけ動的に生成されます。
- **`#table-wrap`**:
    - 各バンドの中心周波数（$f_{\text{c}}$）ごとの**音響指標テーブル**を表示。
    - 指標には **$L_{\text{Fmax}}, L_{\text{Smax}}, L_{\text{eq}}, L_{\text{E}}$**（単発暴露レベル）、および **$L_{05}, L_{10}, L_{50}, L_{90}, L_{95}$**（パーセンタイルレベル）が含まれます。
    - テーブル行クリックで該当するグラフ位置へスムーズスクロールします。
- **`#plots-wrap`**:
    - 各バンドの中心周波数ごとの**時系列グラフ**を表示（Plotly.jsを使用）。
    - グラフには、バンドパス後の信号波形、Fast重み付けエンベロープ、および $L_{\text{Fmax}}$ の発生位置がプロットされます。
- **`#log`**: 処理のログ（時刻付き）とエラーメッセージを表示。

---

## ⚙️ JavaScriptによる処理ロジック

### 1. データ操作とデコード

- **`g` (グローバルステート)**: すべてのデータと設定を保持する中核オブジェクト。
- **`P0`**: 基準音圧 $2 \times 10^{-5} \text{ Pa}$。
- **`parseCSV`**: CSVテキストをパース。初列の時間情報からサンプリング周期を推定し、$SR$ 算出を試みます。
- **WAVデコード**: `readWavHeader` および `decodePCM` 関数で、WAVヘッダーを解析し、PCMデータを**正規化されたFloat32Array**にデコードします（$8, 16, 24, 32$ ビット整数、および $32$ ビット浮動小数点に対応）。

### 2. 音響解析ロジック (`onProcess()`)

1.  **設定取得**: $SR$、バンドタイプ、帯域範囲（$f_{\text{lo}}$〜$f_{\text{hi}}$）、時間重み付けモードなどを取得。
2.  **バンドパスフィルタリング**:
    - 使用されるフィルタ次数 $N$ はコード内で **$N=36$ に固定**されています。
    - **`designButterworthBandpassSOS_N(fc, SR, N)`** を使用して、各中心周波数 $f_{\text{c}}$ のバターワースバンドパスフィルタ係数（SOS形式）を設計。
    - **`sosFilter(x, sos)`** を使用して、信号 $x$ をフィルタリング。
3.  **時間重み付け・レベル計算**:
    - **`ewmaSquaredToSPL(y, SR, \tau)`** を使用して、時定数 $\tau=0.125 \text{ s}$（Fast）および $\tau=1.0 \text{ s}$（Slow）の時系列SPLを計算。
    - **`movingLeqSPL`** を使用して、$L_{\text{eq}}$ 窓長に基づく時系列SPLを計算。
    - 最終的な $L_{\text{Fmax}}$、平均の $L_{\text{eq}}$、$L_{\text{E}}$（暴露レベル）を計算。
    - **`percentile(series, p)`** を使用して、選択された時系列（`series`）からパーセンタイルレベル（$L_{05}$ 等）を計算。
4.  **結果集計**: 処理結果を `$g.results` に格納し、`renderChannel` を呼び出して表示に反映します。

### 3. 表示ロジック (`renderChannel()`)

- 選択チャンネルの結果レコードを取得。
- テーブルに各指標の値を `$0.1 \text{ dB}$ 単位`で表示します。
- Plotlyを使用して時系列グラフを描画します。グラフの表示フレーム数を**`downsampleForPlot`**で約$2000$点に間引くことで、ウェブブラウザでの描画負荷を軽減しています。
- グラフには、`L_{Fmax}`が発生した時点の時間とレベルが注釈（`annotations`）として付加されます。
