ご提示いただいたHTML/JavaScriptコードは、**WAVファイルやCSVデータ**を読み込み、音響解析で一般的に用いられる**周波数分析（オクターブ/1/3オクターブ）**と**時間重み付け（Fast/Slow/Leq/MaxHold）**を組み合わせた高度な処理を実行し、その結果（$L_{\text{fmax}}, L_{\text{eq}}, L_{\text{N}}$など）をグラフと表で表示するツールです。

以下に、初めての方向けの使用ガイドと、専門家向けの詳細説明を記載します。

---

# 🎶 wav2Fmax — 音響データ解析ツール (Pro v3)

このツールは、録音された音のデータ（WAVファイルなど）を読み込み、**「どの周波数帯域で、どれくらいの大きさの音が出ていたか」**を詳細に分析するためのWebアプリケーションです。

## 🚀 はじめての使い方（クイックガイド）

このツールを使うことで、手元のWAVファイルやCSVデータから、騒音計で測ったような**周波数別の最大音圧レベル**や**平均音圧レベル**を算出できます。

### ステップ 1: ファイルの読み込み
1.  **「Load」**ボタンの左にある**ファイル選択**ボタン（`<input type="file">`）をクリックし、解析したい**WAVファイル**または**CSVファイル**を選択します。
2.  **「Load」**ボタンをクリックします。
3.  読み込みに成功すると、画面下部の「Log」に成功メッセージが表示され、「Channel setup」と「Config」が表示されます。

### ステップ 2: チャンネル設定 (Channel Setup)
読み込んだファイルが複数のマイクやセンサー（チャンネル）を持つ場合、どのチャンネルを解析するか設定します。

* **Use (チェックボックス)**: 解析したいチャンネルにチェックを入れます。
* **Role (役割)**: そのチャンネルが何で測定されたか（マイク、加速度計、力ハンマーなど）を設定します。
* **Correction (補正係数)**: センサーの感度補正やキャリブレーション値（倍率）があれば入力します。（通常は1.0のまま）

### ステップ 3: 解析設定 (Config)
解析方法を指定します。

| 設定項目 | 説明 | 初心者向けの推奨設定 |
| :--- | :--- | :--- |
| **Bands** | 周波数分析の細かさ | **1/1 Octave** (オクターブバンド) |
| **Lo/Hi (Hz)** | 解析する周波数帯域の下限と上限 | そのまま（デフォルト） |
| **Time weighting** | 時間の平均の取り方 | **Fast (125 ms)**（最大音を捉えやすい） |
| **Leq window (s)** | Leq (平均レベル) の計算に使う時間窓（Leq選択時のみ） | 1.0 (秒) |
| **CSV SR (Hz)** | CSVファイルの場合のサンプリング周波数 | ファイル読み込み時に自動推定された値 |

### ステップ 4: 解析の実行と結果の確認
1.  **「Process」**ボタンをクリックします。
2.  「計算中...」の表示が消えるまで待ちます。（データ量によっては時間がかかります）
3.  解析が完了すると、**「Summary」**セクションに結果が表示されます。

#### 結果の見方

1.  **タブ (Tabs)**: 複数のチャンネルを解析対象にした場合、チャンネルごとにタブが表示されます。
2.  **表 (テーブル)**:
    * **f(Hz)**: 中心周波数（例：125 Hz、1000 Hz）。
    * **Lfmax (dB)**: **Fast（速い）**時間重み付けでの最大音圧レベル。
    * **Lsmax (dB)**: **Slow（遅い）**時間重み付けでの最大音圧レベル。
    * **Leq (dB)**: 測定時間全体の平均音圧レベル。
    * **L05, L10, L50...**: 統計レベル（例: L50は測定時間の50%を超える騒音レベル）。
3.  **グラフ (Plots)**: 表の行をクリックすると、その周波数帯域の**時間波形**と**Fast時間重み付けによるエンベロープ（包絡線）**が表示されます。これにより、音の変動を視覚的に確認できます。

---

## 💻 wav2Fmax: 技術詳細（専門家向け）

このアプリケーションは、Web Audio APIやPlotlyといった外部ライブラリに依存せず、音響信号処理の核となるアルゴリズムをカスタムESモジュール（`acoustics-core.js`）として実装し、ブラウザ上で**高精度な音響分析**を実現することを目的としています。

### 1. データ入力と前処理

| 要素 | 詳細 | 専門的観点 |
| :--- | :--- | :--- |
| **WAVデコード** | `decodePCM`、`readWavHeader`関数。 | ブラウザネイティブの`AudioContext`を使用せず、**バイナリ操作（`DataView`）**によりWAVファイルのヘッダーを解析し、PCM (16/24/32-bit int) やIEEE Float (32-bit) のデータ部を**$\pm 1$の正規化された`Float32Array`**に変換します。これにより、Web Audio APIの制約を受けずにサンプルデータを直接取得します。 |
| **CSV解析** | `parseCSV`関数。 | CSVのテキストを読み込み、**サンプリングレート（SR）**をデータ列の時刻情報から**差分の中央値**を用いて推定します。これにより、SRが明記されていないCSVデータ（特に振動計データなど）の処理を可能にします。 |
| **チャンネル設定** | `g.setup`の状態管理。 | チャンネルごとの**使用/不使用**、**センサー種別（Role）**、および**倍率補正係数（Gain）**を個別に設定。このGainは、信号解析の直前にデータに乗算され、**物理単位への校正**を簡易的にシミュレートします。 |

### 2. 周波数分析とフィルタリング

* **フィルターバンク**: `designButterworthBandpassSOS_N`で設計された**36次（N=36）のバタワースバンドパスフィルター**を、オクターブ/1/3オクターブ中心周波数 ($f_c$) ごとに適用します。
    * **N=36**: フィルターの**ロールオフ特性（急峻さ）**を非常に高く設定しており、ISO 16832などの規格の理想的なフィルターに近づける試みが見られます。ただし、実装はデジタルフィルターの**Second-Order Section (SOS)** 形式です。
* **ナイキスト周波数チェック**: $f_c / \sqrt{2}$ がサンプリング周波数 ($f_s/2$) を超える帯域は解析から除外されます。

### 3. 時間重み付けと音響指標の計算

フィルタリングされた各帯域の信号 $y(t)$ に対し、以下の処理を実行します。

1.  **瞬時音圧二乗**: $p^2(t) = y^2(t)$ を計算。
2.  **時定数処理（Fast/Slow）**:
    * `ewmaSquaredToSPL`関数を使用。これは、二乗信号 $p^2(t)$ に対して**指数移動平均 (EWMA)** フィルタ（騒音計の**時定数回路**を模倣）を適用し、時定数 $\tau$ に応じた$L_{\tau}(t)$ を算出します。
    * Fast ($\tau=125\text{ ms}$)、Slow ($\tau=1\text{ s}$) を実行。
3.  **音響指標計算**:
    * **Leq (等価騒音レベル)**: 全信号の二乗平均を計算し、$10 \log_{10} (\overline{p^2} / P_0^2)$ で算出（$P_0=2\times 10^{-5}\text{ Pa}$）。
    * **LE (音響暴露レベル)**: $\text{LE} = \text{Leq} + 10 \log_{10}(T)$ から算出。
    * **$L_{\text{max}}$**: FastまたはSlowの時系列 $L_{\tau}(t)$ の最大値として算出。
    * **$L_{\text{N}}$ (統計レベル)**: $L_{\tau}(t)$ の時系列データに対して`percentile`関数（パーセンタイル計算）を適用し、L05, L10, L50, L90, L95を算出します。

### 4. 結果表示と可視化

* **Plotly**: 各中心周波数 $f_c$ ごとに、以下の要素を含む独立したグラフ（`band-plot`）を描画します。
    * **BP (バンドパス信号)**: フィルタリング後の時間波形（`downsampleForPlot`で間引いて表示）。
    * **Env (Fastエンベロープ)**: Fast時定数で処理されたエンベロープ $\sqrt{\overline{p^2}_{\text{Fast}}}$。
    * **Fast Max-Hold**: Fastエンベロープの最大値（$L_{\text{fmax}}$の発生点）をマーカーと注釈で示します。
* **結果テーブル**: 各$f_c$と指標（$L_{\text{fmax}}, L_{\text{eq}}$など）の数値結果を表形式で表示し、**行クリックで対応するグラフへスクロール**する動的な連携を持たせています。
