ご依頼のHTMLファイルについて、その内容と機能を詳細に記述したMarkdownドキュメントを作成します。

---

# Phase 1 — IEC 61260 バターワース $1/n$ オクターブフィルタ設計ツール

このドキュメントは、提供されたHTMLファイルが構築しているウェブアプリケーションの構造と機能について詳細に説明します。このツールは、**IEC 61260-1規格**に適合する**バターワース $1/n$ オクターブバンドフィルタ**をデジタル設計し、その周波数特性（$\Delta A$ 空間）を視覚的にチェックすることを目的としています。

---

## 💻 アプリケーション概要

| 項目 | 詳細 |
| :--- | :--- |
| **名称** | `Phase 1 — IEC 61260 Butterworth 1/n‑Octave Filter Designer` |
| **目的** | デジタルバターワースバンドパスフィルタを設計し、IEC 61260-1規格の許容誤差（$\Delta A$）を満たしているか検証する。 |
| **設計手法** | プリワープ双一次変換を用いたハイパスフィルタ（$f_1$）とローパスフィルタ（$f_2$）の縦続接続（カスケード）によりバンドパスフィルタを構成。中心周波数 $f_{\text{m}}$ でゲインを正規化。 |
| **出力** | 周波数特性プロット（$\Delta A$ vs $f$）、規格適合性サマリー、SOS (Second-Order Section) 係数。 |

---

## 🛠️ HTML `<head>` 要素の構成

| 要素 | 内容/目的 |
| :--- | :--- |
| `<title>` | `Phase 1 — IEC 61260 Butterworth 1/n‑Octave Filter Designer (ΔA, no ∞ tails)` |
| **カスタムESモジュール** | 外部ファイル **`acoustics-core.js`** から、フィルタ設計、周波数応答計算 (`sosFreqz`)、ゲイン正規化 (`normalizeAt`) など、すべての信号処理に必要な関数をインポートし、グローバルスコープ（`window`）に公開しています。 |
| **Plotly.js** | グラフ描画ライブラリをCDNから読み込んでいます（`<script type="module" src="...">` の `src` 属性に記述されていますが、実際には`type="module"`ブロック内でPlotlyが直接インポートされず、グローバルにロードされる想定です）。 |
| `<style>` | ダークテーマ (`--bg: #0b1220`, `--card: #0f172a`) をベースとしたスタイル定義。グリッドレイアウト (`.grid`) や適合性チェック結果の表示（`.pass`/`.fail`）のスタイルが含まれます。 |

---

## 🖥️ UI要素と設計パラメータ

アプリケーションのUIは、主に設計パラメータの設定、グラフ表示、結果サマリー、係数出力の4つのセクションに分かれています。

### 1. 設計パラメータ設定 (`.card > .grid`)

| ID | 項目 | 選択肢/機能 | 説明 |
| :--- | :--- | :--- | :--- |
| `#b` | **Bandwidth (1/n)** | 1 (Octave), 3 (1/3 Oct) | バンド幅を指定（$1/n$ オクターブ）。 |
| `#fm` | **Center (exact) $f_{\text{m}}$ [Hz]** | 10 Hz〜20 kHzの正確な中心周波数リスト | 選択された $1/n$ オクターブの中心周波数（$f_{\text{m}}$）を指定。 |
| `#fs` | **$F_{\text{s}}$ [Hz]** | 48000, 44100 | デジタルフィルタのサンプリング周波数。 |
| `#order` | **Total band‑pass order** | 3, 6, 12, 24, **36** (selected), 72 | バンドパスフィルタ全体の次数 $M$ を指定。 |
| `#iec` | **IEC Class** | Class 0, **Class 1** (selected), Class 2 | 規格適合チェックに使用するIEC 61260-1のクラスを指定。 |
| `#yr` | **$\Delta A$ axis range [dB]**| 0,120 / **0,320** (selected) | グラフのY軸（$\Delta A$）の表示範囲を設定。 |
| `#run` | **Design + Check** | プライマリボタン | 設定に基づきフィルタ設計と規格チェックを実行。 |

### 2. 周波数特性プロット (`#plot`)

- Plotly.jsを使用して、設計されたフィルタの**$\Delta A$** (減衰量)を周波数に対してプロットします。
- $\Delta A(f) = -|H(f)|_{\text{dB}}$ （$|H(f_{\text{m}})| \approx 0 \text{ dB}$）で計算されます。
- プロットには、選択されたIECクラスに基づいた**最小限界 ($\Delta A_{\text{min}}$)** と **最大限界 ($\Delta A_{\text{max}}$)** が点線で描画されます。

### 3. サマリー (`#summary`)

設計結果の要約と規格適合性チェックの結果が表示されます。

- **バンド情報**: $1/n$、 $f_{\text{m}}$、カットオフ周波数 $f_1, f_2$。
- **フィルタ次数**: ハイパス $HP$ 次数（$\lfloor M/2 \rfloor$）とローパス $LP$ 次数（$\lceil M/2 \rceil$）、合計次数 $M$。
- **IECクラス適合性**:
    - 全周波数範囲で許容誤差内に収まっているか判定し、「**PASS**」または「**FAIL**」を色付きで表示。
    - 適合性が最も厳しくなった「**Worst margin**」（最小マージン）を、その周波数 $f$ および $\Delta A$ とともに表示。

### 4. 係数出力 (`#sos`)

- **SOS (biquad / first-order) coefficients** を表示。
- フィルタの設計情報（$F_{\text{s}}, n, f_{\text{m}}, f_1, f_2$, 次数）と、設計されたすべてのSOSセクションの係数 `{b:[b0,b1,b2], a:[1,a1,a2]}` を含む **JSON形式のテキスト**を出力します。

---

## ⚙️ JavaScriptによるフィルタ設計ロジック

アプリケーションのコアロジックは、規格に定義された$\Delta A$テーブルを実装し、設計されたフィルタ応答と比較することにあります。

### 1. 規格周波数の計算

- **`centers_1overn(b)`**: IEC規格で定められた中心周波数（$f_{\text{m}}$）のセットを $1/n$ に基づいて生成します。基準値 $G = 10^{3/10}$ を使用。
- **`edges_from_fm(fm, b)`**: 中心周波数 $f_{\text{m}}$ から、カットオフ周波数 $f_1$ と $f_2$ を計算します。

### 2. $\Delta A$ 許容誤差テーブルの実装

- **`OCT` / `THIRDP`**: IEC 61260-1規格の表に基づく**離散的な$\Delta A$許容誤差**をデータとして保持しています。
    - 周波数比 $\Omega = f/f_{\text{m}}$ と、IECクラス（0, 1, 2）ごとの最小（`min`）と最大（`max`）の許容値が含まれます。
    - $\Omega = G^{\pm 1}$ などの遮断域では、許容最大値が**$\infty$**（$+\infty$）と設定されている点に注意が必要です。

### 3. フィルタ設計とチェック (`run()`)

1.  **パラメータ取得**: UIから $n, f_{\text{m}}, F_{\text{s}}$, 総次数 $M$, クラス $C$ を取得。
2.  **次数分割**: $M$ を $HP$ 次数 $\lfloor M/2 \rfloor$ と $LP$ 次数 $\lceil M/2 \rceil$ に分割。
3.  **フィルタ設計**: `butterHP_sos(f1, fs, hpOrd)` と `butterLP_sos(f2, fs, lpOrd)` を呼び出し、各フィルタのSOS係数を取得し、結合します。
4.  **正規化**: **`normalizeAt(sections, fs, fm)`** を使用し、$f_{\text{m}}$ におけるゲインが $0 \text{ dB}$ になるよう全セクションの係数をスケーリングします。
5.  **周波数応答計算**: `sosFreqz(sections, fs, fgrid)` で対数的に$2000$点 ($N=2000$) の周波数グリッド $f_{\text{grid}}$ 上での振幅応答 $H(f)$ を計算し、$\Delta A = -|H(f)|_{\text{dB}}$ を求めます。
6.  **許容誤差補間**: 離散的な$\Delta A$テーブルデータを用いて、プロットに使用する連続的な周波数グリッド上の**最小限界 $y_{\text{Min}}$ と最大限界 $y_{\text{Max}}$ を対数線形補間**で計算します。
    - **無限大の許容値**: $\Delta A_{\text{max}} = \infty$ の領域は補間を行わず、グラフに描画しないように処理されます。
7.  **規格適合性チェック**: $\Delta A$ 値が全グリッド点で $y_{\text{Min}} \le \Delta A \le y_{\text{Max}}$ を満たしているかチェック。
8.  **Worst Margin**: 最小マージン（$\min(\Delta A_{\text{max}} - \Delta A, \Delta A - \Delta A_{\text{min}})$）を計算し、最も厳しい点（**Worst**）を特定します。
9.  **Plotly描画**: 計算された $\Delta A$ および $y_{\text{Min}}, y_{\text{Max}}$ をプロットします。
10. **結果出力**: サマリー表示と、SOS係数を含むJSONをテキストエリアに出力します。

このツールは、IEC 61260-1規格の要件を満たす**高次のデジタルフィルタ**（例えば $36$ 次）の設計と検証を、ユーザーフレンドリーなウェブインターフェース上で可能にするものです。
