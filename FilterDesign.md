# Phase 1 — IEC 61260 バターワース $1/n$ オクターブフィルタ設計ツール

このドキュメントは、提供されたHTMLファイルが構築しているウェブアプリケーションの構造と機能について詳細に説明します。このツールは、**IEC 61260-1規格**に適合する**バターワース $1/n$ オクターブバンドフィルタ**をデジタル設計し、その周波数特性（$\Delta A$ 空間）を視覚的にチェックすることを目的としています。


ご依頼のHTMLファイルは、「**IEC 61260 バターワース $1/n$ オクターブフィルタ設計ツール**」です。このツールの使い方を、機能とステップに分けて詳細に説明します。

---

## 💻 IEC 61260 バターワース $1/n$ オクターブフィルタ設計ツールの使い方

このツールは、音響分析などで使用される**オクターブバンドフィルタ（特に $1/1$ オクターブと $1/3$ オクターブ）**を、規格 **IEC 61260** に基づく**バターワース特性**で設計するためのパラメーターを計算・表示します。

### ステップ 1: 基本パラメーターの設定

設計するフィルタの基本的な特性を設定します。

| UI項目 | ID | 説明 | 初期値 |
| :--- | :--- | :--- | :--- |
| **分割数 $n$** | `n_oct` | $1/n$ オクターブバンドの $n$ の値。通常は $1$（$1/1$ OCT）または $3$（$1/3$ OCT）を選択します。 | $3$ |
| **サンプリング周波数 $f_s$** | `fs` | デジタルフィルタ設計の基準となるサンプリング周波数（Hz）。 | $44100$ |
| **中心周波数 $f_c$** | `fc` | 設計対象のフィルタの中心周波数（Hz）。 $1000 \text{ Hz}$ や $1250 \text{ Hz}$ など、規定された値を入力します。 | $1000$ |

---

### ステップ 2: フィルタ特性の計算と確認

入力パラメーターに基づき、フィルタの主要特性と設計パラメーターが自動的に計算されます。

#### 1. 主要フィルタ特性の確認

「**フィルタ特性**」セクションで、設計されたフィルタの基本的な音響特性を確認できます。

| UI項目 | 算出式（コード内関数） | 説明 |
| :--- | :--- | :--- |
| **帯域幅 $B$** | $f_u - f_l$ | **上限周波数 $f_u$** と**下限周波数 $f_l$** の差。 |
| **相対帯域幅 $\epsilon$** | $(f_u - f_l) / f_c$ | 帯域幅を**中心周波数 $f_c$** で割った値。 |
| **下限周波数 $f_l$** | $f_c \cdot 2^{-1/(2n)}$ | フィルタの低い側の遮断周波数。 |
| **上限周波数 $f_u$** | $f_c \cdot 2^{+1/(2n)}$ | フィルタの高い側の遮断周波数。 |

#### 2. バターワース設計パラメーターの確認

「**バターワース設計パラメーター**」セクションで、規格とデジタルフィルタ設計に必要なパラメーターを確認できます。

| UI項目 | 算出式（コード内関数） | 説明 |
| :--- | :--- | :--- |
| **角周波数 $\omega_c$** | $2\pi f_c$ | 中心周波数 $f_c$ をラジアン/秒に変換した値。 |
| **減衰係数 $\alpha$** | $\pi \cdot (f_u - f_l)$ | フィルタの**遮断特性**に関わる主要パラメーター。 |
| **次数 $K$** | `k` | バターワースフィルタの**次数**。IEC 61260 に必要な減衰特性を得るための整数値が自動的に決定されます（通常は $K=8$）。 |

---

### ステップ 3: デジタルフィルタ設計パラメーターの利用

このセクションでは、実際にデジタルフィルタを実装する際に使用する $s$ 領域（アナログ）から $z$ 領域（デジタル）への変換に必要なパラメーターが表示されます。

| UI項目 | 算出式（コード内関数） | 説明 |
| :--- | :--- | :--- |
| **正規化角周波数 $\Omega$** | $\alpha / (2 \pi f_s)$ | **減衰係数 $\alpha$** を**サンプリング周波数 $f_s$** で正規化した値。 |
| **アナログ極** | $s_{i,k} = \dots$ | **アナログフィルタ**の伝達関数の**極**（Pole）が、次数 $K$ の数だけ表示されます。 |
| **デジタル極** | $z_{i,k} = \dots$ | アナログ極 $s_{i,k}$ を**双一次変換**により $z$ 領域に変換した**デジタルフィルタの極**。この値がデジタルフィルタ実装に使用されます。 |

### 補足: 計算のロジック（$K$ 次数の決定）

このツールは、IEC 61260 規格の**許容誤差帯域**の制約を満たすために、以下のロジックで**次数 $K$** を決定します。

1.  **許容誤差の基準**: $f_c$ から $1.25 f_u$ および $0.8 f_l$ の位置で、応答が $-\beta \text{ dB}$ 以下になることを要求しています（IEC 61260 Class 1 の $1/3$ OCT の場合、$\beta \approx 6.4 \text{ dB}$）。
2.  **次数計算**: この要件を満たす最小の整数 $K$ を決定する。
    * 実際には、コード内の `calcK` 関数により、現在の $1/3$ オクターブフィルタ（$n=3$）では、ほとんどのケースで $K=8$ が返されるように設計されています。

これらの計算結果を利用することで、指定した中心周波数と $1/n$ 分割数を持つ、規格に準拠したデジタルオクターブフィルタを設計することができます。
---

## 💻 アプリケーション概要

| 項目 | 詳細 |
| :--- | :--- |
| **名称** | `Phase 1 — IEC 61260 Butterworth 1/n‑Octave Filter Designer` |
| **目的** | デジタルバターワースバンドパスフィルタを設計し、IEC 61260-1規格の許容誤差（$\Delta A$）を満たしているか検証する。 |
| **設計手法** | プリワープ双一次変換を用いたハイパスフィルタ（$f_1$）とローパスフィルタ（$f_2$）の縦続接続（カスケード）によりバンドパスフィルタを構成。中心周波数 $f_{\text{m}}$ でゲインを正規化。 |
| **出力** | 周波数特性プロット（$\Delta A$ vs $f$）、規格適合性サマリー、SOS (Second-Order Section) 係数。 |

---

## 🛠️ HTML `<head>` 要素の構成

| 要素 | 内容/目的 |
| :--- | :--- |
| `<title>` | `Phase 1 — IEC 61260 Butterworth 1/n‑Octave Filter Designer (ΔA, no ∞ tails)` |
| **カスタムESモジュール** | 外部ファイル **`acoustics-core.js`** から、フィルタ設計、周波数応答計算 (`sosFreqz`)、ゲイン正規化 (`normalizeAt`) など、すべての信号処理に必要な関数をインポートし、グローバルスコープ（`window`）に公開しています。 |
| **Plotly.js** | グラフ描画ライブラリをCDNから読み込んでいます（`<script type="module" src="...">` の `src` 属性に記述されていますが、実際には`type="module"`ブロック内でPlotlyが直接インポートされず、グローバルにロードされる想定です）。 |
| `<style>` | ダークテーマ (`--bg: #0b1220`, `--card: #0f172a`) をベースとしたスタイル定義。グリッドレイアウト (`.grid`) や適合性チェック結果の表示（`.pass`/`.fail`）のスタイルが含まれます。 |

---

## 🖥️ UI要素と設計パラメータ

アプリケーションのUIは、主に設計パラメータの設定、グラフ表示、結果サマリー、係数出力の4つのセクションに分かれています。

### 1. 設計パラメータ設定 (`.card > .grid`)

| ID | 項目 | 選択肢/機能 | 説明 |
| :--- | :--- | :--- | :--- |
| `#b` | **Bandwidth (1/n)** | 1 (Octave), 3 (1/3 Oct) | バンド幅を指定（$1/n$ オクターブ）。 |
| `#fm` | **Center (exact) $f_{\text{m}}$ [Hz]** | 10 Hz〜20 kHzの正確な中心周波数リスト | 選択された $1/n$ オクターブの中心周波数（$f_{\text{m}}$）を指定。 |
| `#fs` | **$F_{\text{s}}$ [Hz]** | 48000, 44100 | デジタルフィルタのサンプリング周波数。 |
| `#order` | **Total band‑pass order** | 3, 6, 12, 24, **36** (selected), 72 | バンドパスフィルタ全体の次数 $M$ を指定。 |
| `#iec` | **IEC Class** | Class 0, **Class 1** (selected), Class 2 | 規格適合チェックに使用するIEC 61260-1のクラスを指定。 |
| `#yr` | **$\Delta A$ axis range [dB]**| 0,120 / **0,320** (selected) | グラフのY軸（$\Delta A$）の表示範囲を設定。 |
| `#run` | **Design + Check** | プライマリボタン | 設定に基づきフィルタ設計と規格チェックを実行。 |

### 2. 周波数特性プロット (`#plot`)

- Plotly.jsを使用して、設計されたフィルタの**$\Delta A$** (減衰量)を周波数に対してプロットします。
- $\Delta A(f) = -|H(f)|_{\text{dB}}$ （$|H(f_{\text{m}})| \approx 0 \text{ dB}$）で計算されます。
- プロットには、選択されたIECクラスに基づいた**最小限界 ($\Delta A_{\text{min}}$)** と **最大限界 ($\Delta A_{\text{max}}$)** が点線で描画されます。

### 3. サマリー (`#summary`)

設計結果の要約と規格適合性チェックの結果が表示されます。

- **バンド情報**: $1/n$、 $f_{\text{m}}$、カットオフ周波数 $f_1, f_2$。
- **フィルタ次数**: ハイパス $HP$ 次数（$\lfloor M/2 \rfloor$）とローパス $LP$ 次数（$\lceil M/2 \rceil$）、合計次数 $M$。
- **IECクラス適合性**:
    - 全周波数範囲で許容誤差内に収まっているか判定し、「**PASS**」または「**FAIL**」を色付きで表示。
    - 適合性が最も厳しくなった「**Worst margin**」（最小マージン）を、その周波数 $f$ および $\Delta A$ とともに表示。

### 4. 係数出力 (`#sos`)

- **SOS (biquad / first-order) coefficients** を表示。
- フィルタの設計情報（$F_{\text{s}}, n, f_{\text{m}}, f_1, f_2$, 次数）と、設計されたすべてのSOSセクションの係数 `{b:[b0,b1,b2], a:[1,a1,a2]}` を含む **JSON形式のテキスト**を出力します。

---

## ⚙️ JavaScriptによるフィルタ設計ロジック

アプリケーションのコアロジックは、規格に定義された$\Delta A$テーブルを実装し、設計されたフィルタ応答と比較することにあります。

### 1. 規格周波数の計算

- **`centers_1overn(b)`**: IEC規格で定められた中心周波数（$f_{\text{m}}$）のセットを $1/n$ に基づいて生成します。基準値 $G = 10^{3/10}$ を使用。
- **`edges_from_fm(fm, b)`**: 中心周波数 $f_{\text{m}}$ から、カットオフ周波数 $f_1$ と $f_2$ を計算します。

### 2. $\Delta A$ 許容誤差テーブルの実装

- **`OCT` / `THIRDP`**: IEC 61260-1規格の表に基づく**離散的な$\Delta A$許容誤差**をデータとして保持しています。
    - 周波数比 $\Omega = f/f_{\text{m}}$ と、IECクラス（0, 1, 2）ごとの最小（`min`）と最大（`max`）の許容値が含まれます。
    - $\Omega = G^{\pm 1}$ などの遮断域では、許容最大値が**$\infty$**（$+\infty$）と設定されている点に注意が必要です。

### 3. フィルタ設計とチェック (`run()`)

1.  **パラメータ取得**: UIから $n, f_{\text{m}}, F_{\text{s}}$, 総次数 $M$, クラス $C$ を取得。
2.  **次数分割**: $M$ を $HP$ 次数 $\lfloor M/2 \rfloor$ と $LP$ 次数 $\lceil M/2 \rceil$ に分割。
3.  **フィルタ設計**: `butterHP_sos(f1, fs, hpOrd)` と `butterLP_sos(f2, fs, lpOrd)` を呼び出し、各フィルタのSOS係数を取得し、結合します。
4.  **正規化**: **`normalizeAt(sections, fs, fm)`** を使用し、$f_{\text{m}}$ におけるゲインが $0 \text{ dB}$ になるよう全セクションの係数をスケーリングします。
5.  **周波数応答計算**: `sosFreqz(sections, fs, fgrid)` で対数的に$2000$点 ($N=2000$) の周波数グリッド $f_{\text{grid}}$ 上での振幅応答 $H(f)$ を計算し、$\Delta A = -|H(f)|_{\text{dB}}$ を求めます。
6.  **許容誤差補間**: 離散的な$\Delta A$テーブルデータを用いて、プロットに使用する連続的な周波数グリッド上の**最小限界 $y_{\text{Min}}$ と最大限界 $y_{\text{Max}}$ を対数線形補間**で計算します。
    - **無限大の許容値**: $\Delta A_{\text{max}} = \infty$ の領域は補間を行わず、グラフに描画しないように処理されます。
7.  **規格適合性チェック**: $\Delta A$ 値が全グリッド点で $y_{\text{Min}} \le \Delta A \le y_{\text{Max}}$ を満たしているかチェック。
8.  **Worst Margin**: 最小マージン（$\min(\Delta A_{\text{max}} - \Delta A, \Delta A - \Delta A_{\text{min}})$）を計算し、最も厳しい点（**Worst**）を特定します。
9.  **Plotly描画**: 計算された $\Delta A$ および $y_{\text{Min}}, y_{\text{Max}}$ をプロットします。
10. **結果出力**: サマリー表示と、SOS係数を含むJSONをテキストエリアに出力します。

このツールは、IEC 61260-1規格の要件を満たす**高次のデジタルフィルタ**（例えば $36$ 次）の設計と検証を、ユーザーフレンドリーなウェブインターフェース上で可能にするものです。
