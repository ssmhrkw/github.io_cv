<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>板材の音響・振動特性 計算ツール (Web版) - 修正版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { 
            font-family: 'Meiryo', sans-serif; 
            margin: 0;
            padding: 10px; 
            font-size: 14px; 
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column; /* Mobile-first: default to vertical layout */
            gap: 15px;
        }
        .input-column, .output-column { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            width: 100%;
        }
        fieldset { border: 1px solid #ccc; border-radius: 5px; padding: 15px; background-color: #fff; margin: 0; }
        legend { font-weight: bold; padding: 0 5px; }
        .form-grid { display: grid; grid-template-columns: 120px 1fr 40px; align-items: center; gap: 8px; }
        label { font-size: 14px; }
        input, select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 3px; }
        button { width: 100%; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 5px; border: 1px solid #aaa; background-color: #f0f0f0; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid #ccc; }
        .tab-button { padding: 10px 15px; cursor: pointer; background: #f1f1f1; border: 1px solid #ccc; border-bottom: none; border-radius: 5px 5px 0 0; margin-bottom: -1px; }
        .tab-button.active { background: #fff; border-bottom: 1px solid #fff; }
        .tab-content { display: none; padding: 15px; border: 1px solid #ccc; border-top: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        th { background-color: #f2f2f2; text-align: center; }

        /* ★★★ 修正点2: グラフと計算式表示エリアのスタイルを追加 ★★★ */
        .chart-wrapper {
            position: relative;
            width: 100%;
        }
        .formula-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #fafafa;
            border: 1px solid #eee;
            border-radius: 5px;
            font-size: 13px;
        }
        .formula-container h5 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        @media (min-width: 900px) {
            body {
                flex-direction: row;
                align-items: flex-start;
            }
            .input-column {
                width: 380px;
                min-width: 380px;
            }
            .output-column {
                flex-grow: 1;
            }
            /* ★★★ 修正点3: グラフが伸びる問題の対策 ★★★ */
            .chart-wrapper {
                height: 400px; /* グラフの高さを固定 */
            }
        }
    </style>
</head>
<body>

    <div class="input-column">
        <fieldset>
            <legend>入力条件</legend>
            <div class="form-grid">
                <label for="material-select">材料選択:</label>
                <select id="material-select"></select><span></span>
                <label for="freq-input">周波数 (f):</label>
                <input type="number" id="freq-input" value="500"><span>Hz</span>
                <label for="thick-input">板厚 (h):</label>
                <input type="number" id="thick-input" value="12.0"><span>mm</span>
                <label for="lx-input">板の長さ (Lx):</label>
                <input type="number" id="lx-input" value="1000"><span>mm</span>
                <label for="ly-input">板の幅 (Ly):</label>
                <input type="number" id="ly-input" value="1000"><span>mm</span>
                <label for="eta-input">損失係数 (η):</label>
                <input type="number" id="eta-input" value="0.01" step="0.01"><span></span>
            </div>
        </fieldset>
        <fieldset>
            <legend>材料物性値（手動入力可）</legend>
            <div class="form-grid">
                <label for="e-input">ヤング率 (E):</label>
                <input type="text" id="e-input"><span>Pa</span>
                <label for="rho-input">密度 (ρ):</label>
                <input type="text" id="rho-input"><span>kg/m³</span>
                <label for="nu-input">ポアソン比 (ν):</label>
                <input type="text" id="nu-input"><span></span>
            </div>
        </fieldset>
        <button id="calc-button">計算実行</button>
    </div>

    <div class="output-column">
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'basic-tab')">基本特性</button>
            <button class="tab-button" onclick="openTab(event, 'natural-freq-tab')">固有振動数</button>
            <button class="tab-button" onclick="openTab(event, 'stl-tab')">透過損失(STL)</button>
            <button class="tab-button" onclick="openTab(event, 'rad-tab')">音響放射効率(σ)</button>
        </div>
        <div id="basic-tab" class="tab-content active">
            <table id="basic-results-table"></table>
            <div id="basic-formula" class="formula-container"></div>
        </div>
        <div id="natural-freq-tab" class="tab-content">
            <table id="natural-freq-table"></table>
            <div id="natural-freq-formula" class="formula-container"></div>
        </div>
        <div id="stl-tab" class="tab-content">
            <div class="chart-wrapper">
                <canvas id="stl-chart"></canvas>
            </div>
            <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;"><table id="stl-table"></table></div>
            <div id="stl-formula" class="formula-container"></div>
        </div>
        <div id="rad-tab" class="tab-content">
            <div class="chart-wrapper">
                <canvas id="rad-chart"></canvas>
            </div>
            <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;"><table id="rad-table"></table></div>
            <div id="rad-formula" class="formula-container"></div>
        </div>
    </div>

<script>
    const MATERIAL_PROPERTIES = {
        "手動入力": { "rho": 0, "E": 0, "nu": 0 },
        "コンクリート": { "rho": 2.3e3, "E": 2.1e10, "nu": 0.005 }, "軽量コンクリート": { "rho": 1.5e3, "E": 0.5e10, "nu": 0.005 }, "発泡コンクリート": { "rho": 0.6e3, "E": 0.16e10, "nu": 0.005 }, "石こうボード": { "rho": 0.8e3, "E": 0.18e10, "nu": 0.005 }, "特殊石こうボード": { "rho": 1.1e3, "E": 0.2e10, "nu": 0.005 }, "フレキシブル板": { "rho": 1.9e3, "E": 0.2e10, "nu": 0.005 }, "ハードボード": { "rho": 0.9e3, "E": 0.6e10, "nu": 0.005 }, "合板": { "rho": 0.6e3, "E": 0.5e10, "nu": 0.30 }, "コルク": { "rho": 0.25e3, "E": 6e7, "nu": 0.30 }, "ガラス": { "rho": 2500, "E": 70.0e9, "nu": 0.23 }, "硬質塩ビ": { "rho": 1.4e3, "E": 0.35e10, "nu": 0.012 }, "ゴム(硬度50)": { "rho": 1.11e3, "E": 0.46e7, "nu": 0.1 }
    };
    const FREQS = [16, 20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300, 8000];
    let stlChart, radChart;
    const ui = { materialSelect: document.getElementById('material-select'), freqInput: document.getElementById('freq-input'), thickInput: document.getElementById('thick-input'), lxInput: document.getElementById('lx-input'), lyInput: document.getElementById('ly-input'), etaInput: document.getElementById('eta-input'), eInput: document.getElementById('e-input'), rhoInput: document.getElementById('rho-input'), nuInput: document.getElementById('nu-input'), calcButton: document.getElementById('calc-button'), basicTable: document.getElementById('basic-results-table'), naturalFreqTable: document.getElementById('natural-freq-table'), stlTable: document.getElementById('stl-table'), radTable: document.getElementById('rad-table'), stlChart: document.getElementById('stl-chart'), radChart: document.getElementById('rad-chart') };
    
    function initialize() {
        for (const name in MATERIAL_PROPERTIES) { ui.materialSelect.add(new Option(name, name)); }
        ui.materialSelect.value = "石こうボード";
        ui.materialSelect.addEventListener('change', onMaterialSelect);
        ui.calcButton.addEventListener('click', calculateAllProperties);
        onMaterialSelect();
        calculateAllProperties();
    }
    
    function onMaterialSelect() {
        const selectedName = ui.materialSelect.value;
        const props = MATERIAL_PROPERTIES[selectedName];
        const isManual = selectedName === "手動入力";
        ui.eInput.value = isManual ? "" : props.E.toExponential(2);
        ui.rhoInput.value = isManual ? "" : props.rho;
        ui.nuInput.value = isManual ? "" : props.nu;
        [ui.eInput, ui.rhoInput, ui.nuInput].forEach(input => input.readOnly = !isManual);
    }
    
    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
    
    function calculateAllProperties() {
        try {
            const h = parseFloat(ui.thickInput.value) / 1000;
            const E = parseFloat(ui.eInput.value);
            const rho = parseFloat(ui.rhoInput.value);
            const nu = parseFloat(ui.nuInput.value);
            const eta = parseFloat(ui.etaInput.value);
            const c0 = 343.0;
            if (h <= 0 || E <= 0 || rho <= 0 || eta < 0) { alert("厚さ、ヤング率、密度は正の値、損失係数は0以上の値を入力してください。"); return; }
            const D = (E * Math.pow(h, 3)) / (12 * (1 - Math.pow(nu, 2)));
            const fc = (Math.pow(c0, 2) / (2 * Math.PI * h)) * Math.sqrt((12 * rho * (1 - Math.pow(nu, 2))) / E);
            const Z_inf = 8 * Math.sqrt(D * rho * h);
            updateBasicPropertiesTab(Z_inf, fc, h, E, rho, nu);
            updateNaturalFrequencyTab(D, rho, h);
            updateFrequencyDependentTabs(h, rho, eta, fc);

            // ★★★ 修正点6: 計算式表示関数を呼び出す ★★★
            updateFormulas({ D, fc, h, rho, nu, E });

        } catch (error) { alert(`計算エラー: ${error.message}`); }
    }
    
    function updateBasicPropertiesTab(Z_inf, fc, h, E, rho, nu) {
        const Z_inf_dB = 20 * Math.log10(Z_inf / 1.0);
        let results = [ ["無限長板インピーダンス (Z_inf)", `${Z_inf.toFixed(2)} (${Z_inf_dB.toFixed(1)} dB)`, "N·s/m"], ["臨界周波数 (Fc)", `${fc.toFixed(2)}`, "Hz"] ];
        const f_single = parseFloat(ui.freqInput.value);
        if (f_single > 0) {
            const omega = 2 * Math.PI * f_single;
            const C_L_p = Math.sqrt(E / (rho * (1 - Math.pow(nu, 2))));
            const c_BP = Math.sqrt(omega * h * C_L_p / Math.sqrt(12));
            const c_g = 2 * c_BP;
            results.push(["--- @指定周波数 ---", "", ""], ["位相速度 (c_BP)", `${c_BP.toFixed(2)}`, "m/s"], ["群速度 (c_g)", `${c_g.toFixed(2)}`, "m/s"], ["縦波板速度 (C_L_p)", `${C_L_p.toFixed(2)}`, "m/s"]);
        }
        createTable(ui.basicTable, ["物理量", "計算値", "単位"], results);
    }
    
    function updateNaturalFrequencyTab(D, rho, h) {
        let results = [];
        const Lx = parseFloat(ui.lxInput.value) / 1000;
        const Ly = parseFloat(ui.lyInput.value) / 1000;
        if (Lx > 0 && Ly > 0) {
            for (let m = 1; m <= 3; m++) {
                for (let n = 1; n <= 3; n++) {
                    const f_mn = (Math.PI / 2) * Math.sqrt(D / (rho * h)) * (Math.pow(m / Lx, 2) + Math.pow(n / Ly, 2));
                    results.push([`f(${m},${n})`, f_mn.toFixed(2), "Hz"]);
                }
            }
        }
        createTable(ui.naturalFreqTable, ["モード次数", "周波数", "単位"], results);
    }
    
    function updateFrequencyDependentTabs(h, rho, eta, fc) {
        const m_double_prime = rho * h;
        const R_mass = FREQS.map(f => 20 * Math.log10(m_double_prime * f) - 42.5);
        const R_coincidence = R_mass.map((r, i) => { const f = FREQS[i], f_ratio = f / fc; if (Math.abs(f_ratio - 1) < 1e-6) return r; const c = (2*eta)/(Math.PI*f_ratio)*(1/Math.pow(1 - Math.pow(f_ratio, 2), 2)); return r - 10 * Math.log10(Math.abs(c) + 1); });
        const Lx = parseFloat(ui.lxInput.value)/1000, Ly = parseFloat(ui.lyInput.value)/1000;
        const P = Lx > 0 && Ly > 0 ? 2*(Lx+Ly) : 4.0; const A = Lx > 0 && Ly > 0 ? Lx*Ly : 1.0;
        const lambda_c = 343.0 / fc;
        const sigma = FREQS.map(f => { let s; if (f > fc) s = Math.pow(1 - fc/f, -0.5); else s = (P*lambda_c/(Math.PI*A)) * Math.pow(f/fc, 2); return Math.max(1e-4, Math.min(s, 5.0)); });
        const sigma_db = sigma.map(s => 10 * Math.log10(s));
        createPlot(ui.stlChart, 'stl-chart', FREQS, [{label: '質量則(垂直入射)', data: R_mass}, {label: 'コインシデンス考慮', data: R_coincidence}], '透過損失 (STL) 周波数特性');
        createTable(ui.stlTable, ['周波数(Hz)', '質量則(dB)', 'コインシデンス(dB)'], FREQS.map((f, i) => [f, R_mass[i].toFixed(1), R_coincidence[i].toFixed(1)]));
        createPlot(ui.radChart, 'rad-chart', FREQS, [{label: '放射効率', data: sigma_db}], '音響放射効率 周波数特性');
        createTable(ui.radTable, ['周波数(Hz)', 'σ', '10log(σ)(dB)'], FREQS.map((f, i) => [f, sigma[i].toFixed(3), sigma_db[i].toFixed(1)]));
    }
    
    // ★★★ 修正点7: 計算式を生成して表示する関数を追加 ★★★
    function updateFormulas(params) {
        const { D, fc, h, rho, nu, E } = params;

        // Basic Tab
        const basicFormulaHTML = `
            <h5>基本特性の計算式</h5>
            <p><b>曲げ剛性 (D):</b> $$ D = \\frac{E h^3}{12(1-\\nu^2)} $$</p>
            <p><b>臨界周波数 (f<sub>c</sub>):</b> $$ f_c = \\frac{c_0^2}{2\\pi h} \\sqrt{\\frac{12\\rho(1-\\nu^2)}{E}} $$</p>
        `;
        document.getElementById('basic-formula').innerHTML = basicFormulaHTML;

        // Natural Frequency Tab
        const naturalFreqFormulaHTML = `
            <h5>固有振動数の計算式 (四辺単純支持)</h5>
            <p><b>曲げ剛性 (D):</b> $$ D = \\frac{E h^3}{12(1-\\nu^2)} $$</p>
            <p><b>固有振動数 (f<sub>m,n</sub>):</b> $$ f_{m,n} = \\frac{\\pi}{2} \\sqrt{\\frac{D}{\\rho h}} \\left( \\left(\\frac{m}{L_x}\\right)^2 + \\left(\\frac{n}{L_y}\\right)^2 \\right) $$</p>
        `;
        document.getElementById('natural-freq-formula').innerHTML = naturalFreqFormulaHTML;

        // STL Tab
        const stlFormulaHTML = `
            <h5>透過損失の計算式</h5>
            <p><b>面密度 (m''):</b> $$ m'' = \\rho h $$</p>
            <p><b>質量則 (垂直入射, TL<sub>0</sub>):</b> $$ TL_0 = 20 \\log_{10}(m'' f) - 42.5 \\; (dB) $$</p>
            <p>コインシデンス効果は、臨界周波数($f_c$)付近での性能低下を考慮した補正値です。</p>
        `;
        document.getElementById('stl-formula').innerHTML = stlFormulaHTML;

        // Radiation Efficiency Tab
        const radFormulaHTML = `
            <h5>音響放射効率(σ)の計算式</h5>
            <p><b>周波数が臨界周波数未満 (f < f<sub>c</sub>):</b> $$ \\sigma \\approx \\frac{2(L_x+L_y) \\lambda_c}{\\pi L_x L_y} \\left(\\frac{f}{f_c}\\right)^2 $$</p>
            <p><b>周波数が臨界周波数以上 (f > f<sub>c</sub>):</b> $$ \\sigma \\approx \\left(1 - \\frac{f_c}{f}\\right)^{-0.5} $$</p>
            <p>ここで、\\(\\lambda_c\\)は臨界周波数における音波の波長です。</p>
        `;
        document.getElementById('rad-formula').innerHTML = radFormulaHTML;
        
        if (window.MathJax && window.MathJax.typeset) {
            window.MathJax.typeset();
        }
    }
    
    function createTable(tableElement, headers, data) { tableElement.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${data.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>`; }

    function createPlot(canvasElement, chartId, labels, datasets, title) {
        const ctx = canvasElement.getContext('2d');
        if (chartId === 'stl-chart' && stlChart) stlChart.destroy();
        if (chartId === 'rad-chart' && radChart) radChart.destroy();
        const chart = new Chart(ctx, { type: 'line', data: { labels, datasets: datasets.map((ds, i) => ({ label: ds.label, data: ds.data, borderColor: i === 0 ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 99, 132, 1)', backgroundColor: i === 0 ? 'rgba(54, 162, 235, 0.2)' : 'rgba(255, 99, 132, 0.2)', fill: false, borderWidth: 2, pointRadius: 3 })) }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: title, font: {size: 16} } }, scales: { x: { type: 'logarithmic', title: { display: true, text: '周波数 (Hz)' }, ticks: { callback: (v) => [63, 125, 250, 500, 1000, 2000, 4000, 8000].includes(v) ? v : null } }, y: { title: { display: true, text: 'dB' } } } } });
        if (chartId === 'stl-chart') stlChart = chart; else if (chartId === 'rad-chart') radChart = chart;
    }
    
    initialize();
</script>
</body>
</html>
