ご提示いただいたHTML/JavaScriptコードは、**WAVファイル**の内部構造を解析し、特に音響測定器やデータロガーが出力するWAVファイルに格納される**拡張メタデータ（非標準チャンク）**の詳細を表示するための、高度な解析ツールです。

このツールは、一般的な音声情報（サンプリングレートやビット深度）だけでなく、**測定装置固有の設定やキャリブレーション情報**（`TYPE`, `WSET`, `CSET`チャンクなど）を深く掘り下げて表示することに特化しています。

以下に、初めての方向けの使用ガイドと、専門家向けの詳細説明を記載します。

---

# 🔎 WAV Inspector — 内部データ＆機器メタデータ解析ツール

このツールは、WAVファイルというコンテナ形式の内部を詳しく調べ、特に騒音計や振動計などの**計測機器が記録した詳細設定（メーカー独自のメタデータ）**を抽出・表示するWebアプリケーションです。

## 🚀 はじめての使い方（クイックガイド）

### ステップ 1: WAVファイルの読み込み
1.  **「ファイルを選ぶ」**ボタン、または点線で囲まれた領域に、解析したい**WAVファイル**をドラッグ＆ドロップします。
2.  ファイルはサーバーにアップロードされず、ブラウザ内でのみ処理されます。

### ステップ 2: 概要とヘッダ情報の確認
ファイルを読み込むと、画面右上の「2) 概要」に基本的な情報が表示され、その下のセクションにWAVファイル形式の**標準的なヘッダ情報**が表示されます。

| 表示セクション | 内容 |
| :--- | :--- |
| **RIFF ヘッダ** | ファイル形式がWAVであることを示す基本情報。|
| **fmt subchunk** | **サンプリングレート (Fs)**、**チャンネル数 (Ch)**、**ビット深度**など、音データの仕様。|
| **data (Wave Data)**| 実際の音データがどこから始まるか、データのサイズ、**録音時間**の推定値。|

### ステップ 3: 拡張メタデータ（機器情報）の確認
このツールの最も重要な部分です。計測機器が追加する特殊なチャンク（データの塊）の内容が表示されます。

| 表示セクション | 主な情報 |
| :--- | :--- |
| **TYPE subchunk** | 機器が独自に設定した**ファイルタイプやリビジョン**。|
| **Wave Settings (WSET)**| **プリトリガ時間**（トリガがかかる前の録音時間）など、記録の設定。|
| **装置情報** | **機器の名称**、**シリアルナンバー**、ファームウェアの**バージョン情報**など。|
| **時刻情報** | 実際の**録音開始日時**、**トリガ日時**など。|
| **共通設定 (CSET)** | 機器の**測定レンジ**、**トリガモード**など、詳細な測定パラメータ。|
| **CSET (Chごとの設定)**| チャンネルごとの**センサータイプ**、**入力レンジ**、**単位 (Unit)**、**EU換算係数**（ValuePerBit/Offset）など、キャリブレーションの核となる情報。|

### ステップ 4: 波形プレビューとサンプルの抽出
「3) 波形プレビュー」セクションでは、読み込んだWAVファイルの波形の一部を描画できます。

* **「チャンネル」**を選択し、**「描画」**ボタンを押すと波形が表示されます。
* **「EU換算」**にチェックを入れると、CSETチャンクに記載された**ValuePerBit**や**Offset**を使って、物理量単位（例: $g, \text{Pa}, \text{V}$）に変換された波形を試描画できます。

---

# 💻 WAV Inspector: 技術詳細（専門家向け）

このツールは、WAVファイルの仕様（RIFF形式）に基づき、バイト列を直接解析する**カスタムのJavaScriptパーサー**で構成されており、特に**騒音振動計測分野**で普及している**特殊な非標準チャンク**の解釈に重点を置いています。

## 1. コア技術と標準チャンク解析

* **インメモリ処理**: ファイルリーダー（`FileReader`）を使用し、ファイルを`ArrayBuffer`としてメモリに読み込み、`DataView`でバイトレベルのアクセス（リトルエンディアン）を行います。サーバーへのアップロードは行いません。
* **RIFF/WAVE構造**: `parseWav`関数が、`RIFF`ヘッダ（`RIFF` ID, Size, `WAVE` ID）から始まり、ファイル全体を順次走査し、各**チャンクID (FourCC)** と**サイズ**に基づいてチャンクを特定します。
    * **標準チャンク**: `fmt `、`data` は標準的なWAV形式として厳密に解析されます。
    * **パディング処理**: WAV形式の慣習に従い、チャンクサイズが奇数の場合は**1バイトのパディング**をスキップ（`off = dataOffset + size + (size%2)`）しています。

## 2. 非標準チャンクの深層解析

このツールが特にターゲットとしているのは、計測機器メーカー（特に日本のメーカー）がデータロガーの記録設定を保存するために利用する非標準チャンクです。

| チャンクID | 目的/解析内容 | 主な抽出フィールド |
| :--- | :--- | :--- |
| **`TYPE`** | 機器のファイル形式識別子。 | `fileType` (文字列), `fileRev` (リビジョン番号)。 |
| **`WSET`** | 測定ウィンドウ設定。 | `pretime` (プリトリガ時間 [s])。|
| **`CSET`** | **Common Settings**。機器と測定の包括的な設定。 | `unitName`, `unitSerial`, `unitCpuVer` (バージョン情報), `triggerMode`, `measureFreqRangeCode` (周波数レンジ設定)。|
| **`CSET` (チャンネル)**| 各チャンネルの物理量変換情報。 | `name`, `sensorType`, `unit` (工学単位), **`valuePerBit`** (EU/bit), **`offsetValue`** (オフセット[EU])。|
| **`cue ` / `LIST adtl`** | WAV標準のマーカーチャンク。 | `cue ` (フレーム位置), `adtl` (マーカーラベルテキスト)。 |

### CSETチャンクの詳細

`CSET`チャンクの解析は、特定のメーカーのバイナリフォーマットに厳密に従っています。

* **バージョン情報**: `unitCpuVer`, `unitDspVer`などは4バイトの`uint32`として読み出され、`ver32`関数で「XX.XX.XX.XX」形式のバージョン文字列に変換されます。
* **工学単位 (EU) 換算**: チャンネル設定にある**`valuePerBit`**（量子化ステップあたりの物理量）と**`offsetValue`**（DCオフセット）は**IEEE 754 `Float64`**で読み出され、**`valToEU`**関数で波形描画やサンプル値表示に利用されます。

## 3. 検証とデータ整合性のチェック

「検証 (Validation)」セクションでは、WAV標準仕様と計測機器メタデータの整合性チェックを行っています。

* **標準WAVチェック**: `nBlockAlign`や`nAvgBytesPerSec`が他のヘッダ値から**計算されるべき値**と一致するか確認。
* **時間整合性チェック**: `CSET.common.actualRecordTimeMs`と、`data`チャンクのサイズから`fmt`情報を用いて算出した**総フレーム数**との差が、**$\pm 2\%$以内**であるかを確認。これにより、機器が記録したメタデータと実際のデータが一致しているか（データの欠損や不一致がないか）を判断します。

## 4. 波形プレビューの描画

**`drawWaveform`**関数は、HTML5 `Canvas`要素を使用して、WAVバイナリデータから直接波形を描画します。

* **振幅スケーリング**: 描画時、PCM値は**ビット数に応じて正規化**され（$\pm 1$の範囲）、`euToggle`がONの場合は**`valuePerBit`と`offsetValue`**が適用されます。
* **ダウンサンプリング**: 描画幅（ピクセル数）に応じて、複数のサンプルから最大値と最小値を抽出し、垂直線として描画する**Peak Detection**方式を採用しています（`samplesPerPx`の計算）。これにより、高速かつ正確な波形概観を提供します。
