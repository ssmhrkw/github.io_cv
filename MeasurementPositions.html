<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>加振点・受音点配置＋音場評価（JIS/ISO プリセット＋節回避探索）</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root{
      --bg:#fafbfe; --panel:#ffffff; --card:#ffffff; --ink:#0b1220; --muted:#5b6b82; --accent:#3557ff;
      --ok:#1a936f; --bad:#c0392b; --line:#e4e8f0;
    }
    *{box-sizing:border-box}
    body{ margin:0; color:var(--ink); background:var(--bg);
      font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN"; }
    header{ padding:16px 20px; border-bottom:1px solid var(--line); background:#fff; position:sticky; top:0; z-index:10; }
    header h1{font-size:18px; margin:0 0 6px}
    header p{margin:0; color:var(--muted); font-size:13px}
    main{ display:grid; grid-template-columns: 430px 1fr; gap:16px; padding:16px; }
    @media (max-width: 980px){ main{grid-template-columns: 1fr} }
    .panel{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; }
    details{ border:1px solid var(--line); border-radius:10px; background:#fff; margin:8px 0; }
    summary{ cursor:pointer; padding:10px 12px; font-weight:600; list-style:none; }
    summary::marker, summary::-webkit-details-marker{ display:none; }
    summary .triangle{ display:inline-block; width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid var(--muted); margin-right:6px; transform:rotate(0deg); transition:.2s; }
    details[open] summary .triangle{ transform:rotate(180deg); }
    .sec-body{ padding:10px 12px 14px; border-top:1px dashed var(--line); }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid-3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{font-size:12px; color:var(--muted)}
    input[type="number"], input[type="text"], select{
      width:100%; background:#fff; color:#0b1220; border:1px solid var(--line); border-radius:8px; padding:8px 10px; font-size:13px;
    }
    .btn{ appearance:none; border:1px solid var(--line); background:#fff; color:#0b1220; padding:9px 12px; border-radius:8px; font-size:13px; cursor:pointer; }
    .btn:hover{ border-color:#cfd7e3; }
    .btn-accent{ background:var(--accent); color:#fff; border:none; }
    .muted{color:var(--muted); font-size:12px}
    .plots{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 1200px){ .plots{grid-template-columns:1fr} }
    .plot-card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:8px }
    .footer-note{ color:var(--muted); font-size:12px; padding:8px 0 }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; background:#eef2ff; color:#26358b; border:1px solid #d9dffe; margin-right:6px }
    table.small{ width:100%; border-collapse:collapse; }
    table.small th, table.small td{ border:1px solid var(--line); padding:6px; font-size:12px; text-align:center; }
    .icon-btn{ width:28px; height:28px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    h3{ margin:8px 0 6px; font-size:14px; }
    .ok{ color:var(--ok) } .warn{ color:var(--bad) }
  </style>
</head>
<body>
<header>
  <h1>加振点（上階スラブ＝天井Z）・受音点（室内）配置＋音場評価</h1>
  <p>JIS A 1418-1/-2、ISO 16283-3、ISO 10140-3 のプリセット。矩形剛境界モデルで節近傍を可視化し、節回避探索も可能。</p>
</header>

<main>
  <!-- 左：コントロール -->
  <section class="panel" aria-label="controls">
    <details open>
      <summary><span class="triangle"></span>プリセット・生成</summary>
      <div class="sec-body">
        <div class="grid">
          <div>
            <label>プリセット / 手順</label>
            <select id="presetSelect">
              <option value="INCE5">INCE（5の目）</option>
              <option value="JIS5">旧JIS（5の目, z=1.2m）</option>
              <option value="JIS1418_2">JIS A 1418-2（ランダム・高さ制限なし）</option>
              <option value="JIS1418_TAP">JIS A 1418-1：タッピング</option>
              <option value="ISO16283_TAP">ISO 16283-3：Tapping Machine</option>
              <option value="ISO16283_RB">ISO 16283-3：Rubber Ball</option>
              <option value="ISO10140_HS">ISO 10140-3：Heavy/Soft</option>
            </select>
          </div>
          <div>
            <label>乱数シード（再現性）</label>
            <input id="seedInput" type="text" value="seed-1234" />
          </div>
        </div>

        <div class="grid" style="margin-top:8px">
          <div>
            <label>タッピング角度[°]（中心基準）</label>
            <input id="tapAngleDeg" type="number" step="1" value="45">
            <div class="muted">梁・リブ方向に対し45°推奨</div>
          </div>
          <div>
            <label>節回避探索：上限反復回数</label>
            <input id="searchLimit" type="number" step="100" value="100000">
            <div class="muted">警告が全消滅するまでランダム再生成（対象：ランダム系）</div>
          </div>
        </div>

        <div class="row" style="margin-top:6px; gap:8px;">
          <button class="btn-accent btn" id="btnGenerate">プリセット適用・生成</button>
          <button class="btn" id="btnSearch">節回避探索を開始</button>
          <label class="muted"><input id="showSlabEdges" type="checkbox" checked> スラブ枠表示（上階スラブは天井Z=Lzに固定）</label>
        </div>
        <div id="status" class="muted" style="margin-top:8px">準備OK。</div>
      </div>
    </details>

    <details open>
      <summary><span class="triangle"></span>室寸法・スラブ平面寸法 [m]</summary>
      <div class="sec-body">
        <div class="grid-3">
          <div><label>室Lx（X）</label><input id="roomLx" type="number" min="0.1" step="0.1" value="5.0"></div>
          <div><label>室Ly（Y）</label><input id="roomLy" type="number" min="0.1" step="0.1" value="4.0"></div>
          <div><label>室Lz（高さ）</label><input id="roomLz" type="number" min="0.1" step="0.1" value="3.0"></div>
        </div>
        <div class="muted" style="margin-top:6px">
          スラブZは<b>位置</b>。本ツールでは「上階スラブの代表平面」を<b>室の天井Z=Lz</b>に固定（入力不要）。
        </div>
        <div class="grid" style="margin-top:8px">
          <div><label>スラブSx（空欄=室Lx）</label><input id="slabLx" type="number" step="0.1" placeholder=""></div>
          <div><label>スラブSy（空欄=室Ly）</label><input id="slabLy" type="number" step="0.1" placeholder=""></div>
        </div>
      </div>
    </details>

    <details>
      <summary><span class="triangle"></span>点数・制約</summary>
      <div class="sec-body">
        <div class="grid-3">
          <div><label>受音点（マイク）個数</label><input id="nMic" type="number" min="1" step="1" value="4"></div>
          <div><label>加振点（スラブ）個数</label><input id="nSrc" type="number" min="1" step="1" value="5"></div>
          <div><label>最大試行回数 / 点</label><input id="maxTries" type="number" min="10" step="10" value="5000"></div>
        </div>
        <div class="grid-3" style="margin-top:8px">
          <div><label>マイク同士の最小距離</label><input id="micPairMin" type="number" min="0" step="0.05" value="0.7"></div>
          <div><label>境界（壁）からの最小距離</label><input id="micWallMin" type="number" min="0" step="0.05" value="0.5"></div>
          <div><label>床からの最小距離</label><input id="micFloorMin" type="number" min="0" step="0.05" value="0.5"></div>
        </div>
        <div class="grid-3" style="margin-top:8px">
          <div><label>天井からの最小距離</label><input id="micCeilMin" type="number" min="0" step="0.05" value="0.5"></div>
          <div><label>加振点 同士の最小距離</label><input id="srcPairMin" type="number" min="0" step="0.05" value="0.5"></div>
          <div><label>加振点 縁からの最小距離</label><input id="srcEdgeMin" type="number" min="0" step="0.05" value="0.5"></div>
        </div>
        <div class="muted" style="margin-top:6px">
          既定：壁・床・天井から≥0.5 m、マイク相互≥0.7 m。プリセットに応じて上書きあり。
        </div>
      </div>
    </details>

    <details>
      <summary><span class="triangle"></span>自由記入（行追加→プロット）</summary>
      <div class="sec-body">
        <div class="row">
          <button class="btn icon-btn" id="addMicRow" title="受音点行を追加">＋</button>
          <span class="muted">受音点（x,y,z）を行で追加</span>
        </div>
        <table class="small" id="micTable">
          <thead><tr><th>#</th><th>x[m]</th><th>y[m]</th><th>z[m]</th><th>操作</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top:8px">
          <button class="btn icon-btn" id="addSrcRow" title="加振点行を追加">＋</button>
          <span class="muted">加振点（x,y）を行で追加（タッピングは中心点）</span>
        </div>
        <table class="small" id="srcTable">
          <thead><tr><th>#</th><th>x[m]</th><th>y[m]</th><th>操作</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top:10px">
          <button class="btn-accent" id="plotManual">プロット</button>
          <button class="btn" id="clearManual">クリア</button>
        </div>
      </div>
    </details>
  </section>

  <!-- 右：可視化 -->
  <section>
    <div class="plots">
      <div class="plot-card">
        <div id="roomPlot" style="width:100%;height:540px"></div>
      </div>
      <div class="plot-card">
        <div id="slabPlot" style="width:100%;height:540px"></div>
      </div>
    </div>

    <!-- 音場警告 -->
    <div class="plot-card" style="margin-top:12px">
      <h3>音場Warning（節近傍｜各受音点）</h3>
      <div class="muted" style="margin-bottom:6px">
        |Φ| &lt; ε（既定 ε=0.10）を<b>節近傍</b>、|Φ| &lt; 0.02 を<b>特異点に非常に近い可能性</b>として警告。低次モードを含む場合はレベル差が出やすい。
      </div>
      <div id="warnPanel" class="mono"></div>
    </div>

    <div class="footer-note">
      <span class="badge">注</span>
      記号凡例：〇=重量系（RB/Heavy-Soft）、□=軽量系、×＋長方形=タッピング。タッピング矩形は実寸（W=0.520 m, D=0.260 m）で表示。
    </div>
  </section>
</main>

<script>
/* ===== 乱数（シード再現性） ===== */
function xmur3(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=(h<<13)|(h>>>19);} return function(){ h=Math.imul(h^(h>>>16),2246822507); h=Math.imul(h^(h>>>13),3266489909); return (h^=h>>>16)>>>0; } }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function rngFromSeed(seedStr){ const s=xmur3(seedStr)(); return mulberry32(s); }
function randRange(rng, min, max){ return min + (max - min) * rng(); }

/* ===== ユーティリティ ===== */
function numVal(id){ const v=document.getElementById(id).value; return (v===""||v==null)?NaN:Number(v); }
function setStatus(msg, ok=true){ const el=document.getElementById('status'); el.textContent=msg; el.className= ok? 'muted ok':'muted warn'; }
function fmt(n){ return Number(n.toFixed(3)); }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function dist3(a,b){ return Math.hypot(a.x-b.x, a.y-b.y, a.z-b.z); }
function dist2(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function rad(deg){ return deg*Math.PI/180; }

/* ===== 入力読取（スラブZは常にLz） ===== */
function readDim(){
  const Lx=Number(numVal('roomLx')), Ly=Number(numVal('roomLy')), Lz=Number(numVal('roomLz'));
  let Sx=Number(numVal('slabLx')), Sy=Number(numVal('slabLy'));
  if (isNaN(Sx)) Sx=Lx; if (isNaN(Sy)) Sy=Ly;
  const Sz=Lz; // 上階スラブは天井Zに固定
  return {room:{Lx,Ly,Lz}, slab:{Sx,Sy,Sz}};
}
function readConstraints(){
  return {
    nMic: Number(numVal('nMic')),
    nSrc: Number(numVal('nSrc')),
    maxTries: Number(numVal('maxTries')),
    micPairMin: Number(numVal('micPairMin')),
    micWallMin: Number(numVal('micWallMin')),
    micFloorMin: Number(numVal('micFloorMin')),
    micCeilMin: Number(numVal('micCeilMin')),
    srcPairMin: Number(numVal('srcPairMin')),
    srcEdgeMin: Number(numVal('srcEdgeMin')),
  };
}

/* ===== 5の目（左上→右上→中央→左下→右下） ===== */
function dice5Positions(Sx,Sy){
  return [
    {x:Sx/3,   y:2*Sy/3},
    {x:2*Sx/3, y:2*Sy/3},
    {x:Sx/2,   y:Sy/2},
    {x:Sx/3,   y:Sy/3},
    {x:2*Sx/3, y:Sy/3},
  ];
}

/* ===== 加振点（2D：中央付近1点を含む） ===== */
function sampleSrcPointsWithCenter(cfg, rng){
  const {Sx,Sy,Sz}=cfg.slab; const {nSrc, srcPairMin, srcEdgeMin, maxTries}=cfg.constraints;
  const xsMin=srcEdgeMin, xsMax=Sx-srcEdgeMin; const ysMin=srcEdgeMin, ysMax=Sy-srcEdgeMin;
  if (xsMax<=xsMin || ysMax<=ysMin) throw new Error("加振点の可用領域がありません（縁からの離隔が広すぎます）。");
  const points=[];
  const rC = 0.15 * Math.min(Sx, Sy);
  const cx = Sx/2, cy = Sy/2;
  { // 中央付近1点
    let ok=false, tries=0;
    while(!ok && tries<maxTries){
      tries++;
      const ang = 2*Math.PI * rng();
      const rad = rC * Math.sqrt(rng());
      let px = cx + rad*Math.cos(ang), py = cy + rad*Math.sin(ang);
      px = clamp(px, xsMin, xsMax); py = clamp(py, ysMin, ysMax);
      points.push({x:px,y:py,z:Sz}); ok=true;
    }
  }
  for(let i=1;i<nSrc;i++){
    let ok2=false, tries2=0;
    while(!ok2 && tries2<maxTries){
      tries2++;
      const px=randRange(rng,xsMin,xsMax), py=randRange(rng,ysMin,ysMax);
      const cand={x:px,y:py,z:Sz};
      ok2 = points.every(p=>dist2(p,cand)>=srcPairMin);
      if(ok2) points.push(cand);
    }
    if(!ok2) throw new Error(`加振点${i+1}の配置に失敗（制約厳/試行不足）。`);
  }
  return points;
}

/* ===== 受音点（3Dランダム） ===== */
function sampleMicPoints(cfg, rng){
  const {Lx,Ly,Lz}=cfg.room;
  const {nMic, micPairMin, micWallMin, micFloorMin, micCeilMin, maxTries}=cfg.constraints;
  const xsMin=micWallMin, xsMax=Lx-micWallMin;
  const ysMin=micWallMin, ysMax=Ly-micWallMin;
  const zMin=micFloorMin, zMax=(Lz-micCeilMin);
  if (xsMax<=xsMin || ysMax<=ysMin || zMax<zMin) throw new Error("受音点の可用領域がありません（制約を緩めてください）。");
  const points=[];
  for(let i=0;i<nMic;i++){
    let ok=false, tries=0;
    while(!ok && tries<maxTries){
      tries++;
      const px=randRange(rng,xsMin,xsMax), py=randRange(rng,ysMin,ysMax);
      const pz=randRange(rng,zMin,zMax);
      const cand={x:px,y:py,z:pz};
      ok = points.every(p=>dist3(p,cand)>=micPairMin);
      if(ok) points.push(cand);
    }
    if(!ok) throw new Error(`受音点${i+1}の配置に失敗（制約厳/試行不足）。`);
  }
  return points;
}

/* ===== 室モード（矩形・剛境界） ===== */
function modalFreq(c, Lx, Ly, Lz, nx, ny, nz){
  const kx=nx/Lx, ky=ny/Ly, kz=nz/Lz; return (c/2) * Math.sqrt(kx*kx + ky*ky + kz*kz);
}
function phiAt(x,y,z,Lx,Ly,Lz,nx,ny,nz){
  return Math.cos(nx*Math.PI*x/Lx)*Math.cos(ny*Math.PI*y/Ly)*Math.cos(nz*Math.PI*z/Lz);
}
function angleToNearestNode(angle){ let r=(angle+Math.PI/2)%Math.PI; if(r<0) r+=Math.PI; r-=Math.PI/2; return Math.abs(r); }
function distToNode1D(coord, L, n){ if(n===0) return null; const dtheta=angleToNearestNode(n*Math.PI*coord/L); return dtheta*L/(n*Math.PI); }
function computeWarnings(dims, mics, params){
  const {Lx,Ly,Lz}=dims.room; const c=params.c, eps=params.eps, topK=params.topK, Nmax=params.Nmax;
  const modes=[]; for(let nx=0; nx<=Nmax; nx++){ for(let ny=0; ny<=Nmax; ny++){ for(let nz=0; nz<=Nmax; nz++){
    if(nx===0&&ny===0&&nz===0) continue; const f=modalFreq(c,Lx,Ly,Lz,nx,ny,nz); modes.push({nx,ny,nz,f,sum:nx+ny+nz});
  } } }
  modes.sort((a,b)=>a.f-b.f);
  const perMic=[];
  for(let i=0;i<mics.length;i++){
    const p=mics[i]; const hits=[];
    for(const m of modes){
      const phi=Math.abs(phiAt(p.x,p.y,p.z,Lx,Ly,Lz,m.nx,m.ny,m.nz));
      if (phi < eps){
        hits.push({...m, phi,
          dx: m.nx>0 ? distToNode1D(p.x, Lx, m.nx) : null,
          dy: m.ny>0 ? distToNode1D(p.y, Ly, m.ny) : null,
          dz: m.nz>0 ? distToNode1D(p.z, Lz, m.nz) : null
        });
      }
    }
    hits.sort((a,b)=>a.f-b.f);
    perMic.push({ micIndex:i+1, count:hits.length, list:hits.slice(0, topK),
                  minPhi: hits.length? Math.min(...hits.map(h=>h.phi)) : null,
                  hasLowOrder: hits.some(h=>h.sum<=2) });
  }
  return {modesCount:modes.length, perMic};
}
function hasAnyWarnings(warns){
  return warns.perMic.some(m=>m.count>0);
}

/* ===== タッピングマシン矩形（回転） ===== */
const TAP_W = 0.520; // 実寸（m）
const TAP_D = 0.260; // 実寸（m）
function makeRotRect(cx, cy, lenW, lenD, angleRad){
  const dx=lenW/2, dy=lenD/2;
  const corners=[[-dx,-dy],[dx,-dy],[dx,dy],[-dx,dy],[-dx,-dy]];
  const cosA=Math.cos(angleRad), sinA=Math.sin(angleRad);
  const pts = corners.map(([x,y])=>{
    const xr = x*cosA - y*sinA, yr = x*sinA + y*cosA;
    return {x: cx + xr, y: cy + yr};
  });
  return pts;
}

/* ===== プリセット生成 ===== */
function presetApply(code, seedBump=0){
  const dims=readDim(); const cons=readConstraints();
  const rng=rngFromSeed((document.getElementById('seedInput').value||"seed") + `-${seedBump}`);
  const angle=rad(Number(numVal('tapAngleDeg'))||45);

  let pointsMic=[], pointsSrc=[], srcMeta=[];
  function ensureAtLeast(min){ cons.nSrc=Math.max(min, Number(numVal('nSrc'))||min); }

  // 共通の基準（後で上書き）
  cons.micWallMin=0.5; cons.micFloorMin=0.5; cons.micCeilMin=0.5; cons.micPairMin=0.7;
  cons.srcEdgeMin=0.5;

  if (code==='INCE5' || code==='JIS5'){
    const pts2D = dice5Positions(dims.slab.Sx,dims.slab.Sy);
    if (code==='JIS5'){
      const zFix = Math.max(cons.micFloorMin, Math.min(1.2, dims.room.Lz - cons.micCeilMin));
      pointsMic = pts2D.map(p=>({x:p.x,y:p.y,z:zFix}));
    }else{
      const zMin=cons.micFloorMin, zMax=dims.room.Lz - cons.micCeilMin;
      const ratios=[0/6,1/6,3/6,5/6,6/6];
      pointsMic = pts2D.map((p,i)=>({x:p.x,y:p.y,z: zMin + (zMax-zMin)*ratios[i]}));
    }
    pointsSrc = pts2D.map(p=>({x:p.x,y:p.y,z:dims.slab.Sz}));
    srcMeta = pts2D.map(()=>({type:'light'})); // □（軽量）
    cons.nMic=5; cons.nSrc=5;
  }
  else if (code==='JIS1418_2'){
    // JIS A 1418-2（高さ制限なし）
    cons.nMic=Math.max(4, Number(numVal('nMic'))||4);
    cons.nSrc=Math.min(5, Math.max(3, Number(numVal('nSrc'))||5));
    pointsMic = sampleMicPoints({room:dims.room,constraints:cons}, rng);
    pointsSrc = sampleSrcPointsWithCenter({slab:dims.slab,constraints:cons}, rng);
    srcMeta = pointsSrc.map(()=>({type:'light'})); // □（軽量）
  }
  else if (code==='JIS1418_TAP'){
    // JIS A 1418-1 5.1/5.2.1
    ensureAtLeast(3); cons.nSrc=Math.min(5, Math.max(3, cons.nSrc||4));
    cons.micPairMin=0.7; cons.micWallMin=0.5; cons.micCeilMin=0.5; cons.micFloorMin=0.5;
    cons.nMic = Math.max(4, Number(numVal('nMic')) || cons.nSrc*2);
    pointsMic = sampleMicPoints({room:dims.room,constraints:cons}, rng);
    pointsSrc = sampleSrcPointsWithCenter({slab:dims.slab,constraints:cons}, rng);
    srcMeta = pointsSrc.map(()=>({type:'tap', w:TAP_W, d:TAP_D, angle}));
  }
  else if (code==='ISO16283_TAP'){
    // ISO 16283-3 Tapping：縁≥0.5m、角度UI。天井距離≥1.0m。
    ensureAtLeast(4);
    cons.micPairMin=0.7; cons.micWallMin=0.5; cons.micCeilMin=1.0;
    cons.nMic = Math.max(cons.nSrc*2, Number(numVal('nMic'))||cons.nSrc*2);
    pointsMic = sampleMicPoints({room:dims.room,constraints:cons}, rng);
    pointsSrc = sampleSrcPointsWithCenter({slab:dims.slab,constraints:cons}, rng);
    srcMeta = pointsSrc.map(()=>({type:'tap', w:TAP_W, d:TAP_D, angle}));
  }
  else if (code==='ISO16283_RB'){
    // ISO 16283-3 Rubber Ball（重量系）
    ensureAtLeast(4);
    cons.micPairMin=0.7; cons.micWallMin=0.5; cons.micCeilMin=1.0;
    cons.nMic = Math.max(cons.nSrc*2, Number(numVal('nMic'))||cons.nSrc*2);
    pointsMic = sampleMicPoints({room:dims.room,constraints:cons}, rng);
    pointsSrc = sampleSrcPointsWithCenter({slab:dims.slab,constraints:cons}, rng);
    srcMeta = pointsSrc.map(()=>({type:'heavy'})); // 〇
  }
  else if (code==='ISO10140_HS'){
    // ISO 10140-3 Heavy/Soft（重量系）
    ensureAtLeast(4);
    cons.micPairMin=0.7; cons.micWallMin=0.7; cons.micCeilMin=1.0;
    cons.nMic = Math.max(4, Number(numVal('nMic'))||Math.max(4, cons.nSrc*2));
    pointsMic = sampleMicPoints({room:dims.room,constraints:cons}, rng);
    pointsSrc = sampleSrcPointsWithCenter({slab:dims.slab,constraints:cons}, rng);
    srcMeta = pointsSrc.map(()=>({type:'heavy'})); // 〇
  }
  else{
    throw new Error('未知のプリセット');
  }

  // UI反映
  document.getElementById('nMic').value=cons.nMic;
  document.getElementById('nSrc').value=cons.nSrc;

  // 描画
  plotAndEvaluate({room:dims.room, slab:dims.slab, pointsMic, pointsSrc, srcMeta});
  fillManualTables(pointsMic, pointsSrc);

  // ステータス
  const labels={
    INCE5:'INCE（5の目）',
    JIS5:'旧JIS（5の目, z=1.2m）',
    JIS1418_2:'JIS A 1418-2（ランダム・高さ制限なし）',
    JIS1418_TAP:'JIS A 1418-1：タッピング',
    ISO16283_TAP:'ISO 16283-3：Tapping Machine',
    ISO16283_RB:'ISO 16283-3：Rubber Ball',
    ISO10140_HS:'ISO 10140-3：Heavy/Soft'
  };
  setStatus(`${labels[code]} を適用しました。`, true);

  return {pointsMic, pointsSrc, srcMeta, dims};
}

/* ===== Plotly描画（3D/2D：サイズ調整） ===== */
let _micTraceIndex = null;
function makeRoomEdges(Lx,Ly,Lz){
  function xyz(list){ return {x:list.map(p=>p[0]), y:list.map(p=>p[1]), z:list.map(p=>p[2])}; }
  const bottom = xyz([[0,0,0],[Lx,0,0],[Lx,Ly,0],[0,Ly,0],[0,0,0]]);
  const top    = xyz([[0,0,Lz],[Lx,0,Lz],[Lx,Ly,Lz],[0,Ly,Lz],[0,0,Lz]]);
  const verts  = xyz([[0,0,0],[0,0,Lz],[NaN,NaN,NaN],[Lx,0,0],[Lx,0,Lz],[NaN,NaN,NaN],[Lx,Ly,0],[Lx,Ly,Lz],[NaN,NaN,NaN],[0,Ly,0],[0,Ly,Lz]]);
  return [
    {type:'scatter3d',mode:'lines',...bottom, line:{width:2}, hoverinfo:'skip', name:'room-bottom'},
    {type:'scatter3d',mode:'lines',...top,    line:{width:2}, hoverinfo:'skip', name:'room-top'},
    {type:'scatter3d',mode:'lines',...verts,  line:{width:2}, hoverinfo:'skip', name:'room-edges'}
  ];
}
function slabFrame3D(Sx,Sy,Sz){
  const x=[0,Sx,Sx,0,0], y=[0,0,Sy,Sy,0], z=[Sz,Sz,Sz,Sz,Sz];
  return {type:'scatter3d', mode:'lines', x, y, z, line:{width:3}, hoverinfo:'skip', name:'slab(上階)'};
}

function plotAll(state){
  const { room, slab, pointsMic, pointsSrc, srcMeta=[] } = state;
  const showSlabEdges = document.getElementById('showSlabEdges').checked;
  const base = makeRoomEdges(room.Lx, room.Ly, room.Lz);

  // 受音点（3D）
  const micTrace = {
    type:'scatter3d', mode:'markers+text',
    x: pointsMic.map(p=>p.x), y: pointsMic.map(p=>p.y), z: pointsMic.map(p=>p.z),
    marker:{size:6}, text: pointsMic.map((_,i)=>`Mic ${i+1}`), textposition:'top center', name:'受音点'
  };

  // 加振点（3D）：heavy=〇, light=□, tap=矩形＋×
  const lift = Math.max(0.02, 0.02*room.Lz);
  const src3D_x = [], src3D_y = [], src3D_z = [], src3D_sym=[];
  const src2D_x = [], src2D_y = [], src2D_sym=[];
  const extra3D = []; // タッピング矩形の線
  const extra2D = [];

  for(let i=0;i<pointsSrc.length;i++){
    const p=pointsSrc[i], meta=srcMeta[i]||{type:'light'};
    const z3 = Math.max(0, slab.Sz - lift);
    if (meta.type==='tap'){
      // 実寸W×Dの回転矩形（3D/2D）
      const rect = makeRotRect(p.x, p.y, meta.w||TAP_W, meta.d||TAP_D, meta.angle||0);
      const rx=rect.map(o=>o.x), ry=rect.map(o=>o.y), rz=rect.map(()=>slab.Sz);
      extra3D.push({type:'scatter3d', mode:'lines', x:rx, y:ry, z:rz, line:{width:4}, name:`Tap ${i+1}`, hoverinfo:'skip'});
      extra2D.push({type:'scatter', mode:'lines', x:rx, y:ry, name:`Tap ${i+1}`, hoverinfo:'skip'});
      // 中心×印
      src3D_x.push(p.x); src3D_y.push(p.y); src3D_z.push(z3); src3D_sym.push('x');
      src2D_x.push(p.x); src2D_y.push(p.y); src2D_sym.push('x');
    }else{
      const sym = (meta.type==='heavy')? 'circle' : 'square';
      src3D_x.push(p.x); src3D_y.push(p.y); src3D_z.push(z3); src3D_sym.push(sym);
      src2D_x.push(p.x); src2D_y.push(p.y); src2D_sym.push(sym);
    }
  }

  const src3DTrace = {
    type:'scatter3d', mode:'markers+text',
    x: src3D_x, y: src3D_y, z: src3D_z,
    marker:{size:8, symbol:src3D_sym},
    text: src3D_x.map((_,i)=>`Src ${i+1}`), textposition:'bottom center', name:'加振点(上階)'
  };
  const slabEdges = showSlabEdges ? [slabFrame3D(slab.Sx, slab.Sy, slab.Sz)] : [];
  const data3D = [...base, ...slabEdges, micTrace, ...extra3D, src3DTrace];

  // 2D
  const slabRect = { type:'scatter', mode:'lines', x:[0,slab.Sx,slab.Sx,0,0], y:[0,0,slab.Sy,slab.Sy,0], hoverinfo:'skip', name:'Slab' };
  const src2D = { type:'scatter', mode:'markers+text', x: src2D_x, y: src2D_y,
    marker:{size:8, symbol:src2D_sym}, text: src2D_x.map((_,i)=>`S${i+1}`), textposition:'top center', name:'加振点' };
  const micProj2D = { type:'scatter', mode:'markers', x: pointsMic.map(p=>p.x), y: pointsMic.map(p=>p.y),
    marker:{size:6, symbol:'circle-open'}, name:'受音点の床投影' };
  const data2D = [slabRect, ...extra2D, src2D, micProj2D];

  const pad = 0.12;
  const roomLayout = {
    scene:{
      xaxis:{title:'X [m]', range:[-pad*room.Lx, (1+pad)*room.Lx]},
      yaxis:{title:'Y [m]', range:[-pad*room.Ly, (1+pad)*room.Ly]},
      zaxis:{title:'Z [m]', range:[-0.05*room.Lz, (1+pad)*room.Lz]},
      aspectmode:'data', camera:{ eye:{x:2.1, y:-2.1, z:1.4} }, bgcolor:'#ffffff'
    },
    margin:{l:0,r:0,t:20,b:0}, paper_bgcolor:'#ffffff', plot_bgcolor:'#ffffff', showlegend:true
  };
  const slabLayout = {
    xaxis:{title:'X [m]',range:[0,slab.Sx],scaleanchor:'y',scaleratio:1},
    yaxis:{title:'Y [m]',range:[0,slab.Sy]}, margin:{l:50,r:20,t:20,b:40},
    paper_bgcolor:'#ffffff', plot_bgcolor:'#ffffff', showlegend:true
  };

  Plotly.newPlot('roomPlot', data3D, roomLayout, {responsive:true, displaylogo:false});
  Plotly.newPlot('slabPlot', data2D, slabLayout, {responsive:true, displaylogo:false});

  _micTraceIndex = base.length + slabEdges.length; // micトレース位置
}

/* ===== 評価＋テーブル連動 ===== */
function plotAndEvaluate(state){
  plotAll(state);
  const params = { c:343, eps:0.10, topK:10, Nmax:4 };
  const warns = computeWarnings({room:state.room}, state.pointsMic, params);
  const colors = warns.perMic.map(w => w.count>0 ? 'rgb(192,57,43)' : 'rgb(53,87,255)');
  if (_micTraceIndex!==null){ Plotly.restyle('roomPlot', {'marker.color':[colors]}, [_micTraceIndex]); }

  let html = '';
  html += `評価対象モード数（Nmax=${params.Nmax}）：${warns.modesCount}<br>`;
  for(const m of warns.perMic){
    const severe = (m.minPhi!==null && m.minPhi<0.02);
    const tag = (m.count>0)
      ? (severe ? `<span class="warn">特異点に非常に近い可能性</span>` : `<span class="warn">節近傍</span>`)
      : `<span class="ok">節近傍なし（しきい値内）</span>`;
    html += `<div style="margin-top:8px"><b>Mic ${m.micIndex}</b>：${tag}`;
    if (m.count>0){
      if (m.hasLowOrder) html += `（低次モード含む → <b>大きなレベル差の可能性</b>）`;
      html += `<br><table class="small" style="margin-top:4px"><thead><tr><th>nx</th><th>ny</th><th>nz</th><th>f[Hz]</th><th>|Φ|</th><th>dx[m]</th><th>dy[m]</th><th>dz[m]</th></tr></thead><tbody>`;
      for(const it of m.list){
        html += `<tr><td>${it.nx}</td><td>${it.ny}</td><td>${it.nz}</td><td>${fmt(it.f)}</td><td>${fmt(it.phi)}</td><td>${it.dx?fmt(it.dx):'-'}</td><td>${it.dy?fmt(it.dy):'-'}</td><td>${it.dz?fmt(it.dz):'-'}</td></tr>`;
      }
      html += `</tbody></table>`;
      html += `<div class="muted" style="margin-top:4px">→ 対策：XY/Zを±0.2–1.0 m調整、段差変更、代替点を併行評価。</div>`;
    }
    html += `</div>`;
  }
  document.getElementById('warnPanel').innerHTML = html;

  return warns;
}

/* ===== 自由記入テーブル ===== */
function addRow(tbody, cols){
  const tr=document.createElement('tr'); const idx=tbody.children.length+1;
  tr.innerHTML = `<td>${idx}</td>` + cols.map(c=>`<td><input type="number" step="${c.step||'0.01'}" value="${c.val??''}" /></td>`).join('')
    + `<td><button class="btn icon-btn del">×</button></td>`;
  tbody.appendChild(tr);
  tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); Array.from(tbody.children).forEach((r,i)=>r.children[0].textContent=i+1); });
}
function getTablePoints3D(tbody){
  const ps=[]; for(const tr of tbody.children){
    const [x,y,z]=Array.from(tr.querySelectorAll('input')).map(i=>Number(i.value));
    if([x,y,z].some(v=>Number.isNaN(v))) throw new Error("受音点に数値でない行があります。");
    ps.push({x,y,z});
  } return ps;
}
function getTablePoints2D(tbody, z){
  const ps=[]; for(const tr of tbody.children){
    const [x,y]=Array.from(tr.querySelectorAll('input')).map(i=>Number(i.value));
    if([x,y].some(v=>Number.isNaN(v))) throw new Error("加振点に数値でない行があります。");
    ps.push({x,y,z});
  } return ps;
}
function fillManualTables(mics, srcs){
  const micTB=document.querySelector('#micTable tbody'); const srcTB=document.querySelector('#srcTable tbody');
  micTB.innerHTML=''; srcTB.innerHTML='';
  for(const p of mics){ addRow(micTB, [{val:fmt(p.x)},{val:fmt(p.y)},{val:fmt(p.z)}]); }
  for(const p of srcs){ addRow(srcTB, [{val:fmt(p.x)},{val:fmt(p.y)}]); }
}

/* ===== 節回避探索 ===== */
function isRandomPreset(code){
  return ['JIS1418_2','JIS1418_TAP','ISO16283_TAP','ISO16283_RB','ISO10140_HS'].includes(code);
}
function searchUntilNoWarnings(){
  const code = document.getElementById('presetSelect').value;
  if (!isRandomPreset(code)){
    setStatus('このプリセットは固定配置のため「節回避探索」の対象外です。ランダム系を選択してください。', false);
    return;
  }
  const limit = Math.max(1, Number(numVal('searchLimit')) || 100000);
  let best = null;
  for (let i=0; i<limit; i++){
    const state = presetApply(code, i);           // シードに i を混ぜて多様化
    const warns = plotAndEvaluate({room:state.dims.room, slab:state.dims.slab, pointsMic:state.pointsMic, pointsSrc:state.pointsSrc, srcMeta:state.srcMeta});
    if (!hasAnyWarnings(warns)){
      setStatus(`節回避探索：${i+1}回目で全受音点の警告なし配置を発見。`, true);
      return;
    }
    if (i===0 || (best && warns.perMic.filter(m=>m.count>0).length < best.badMics)){
      best = {i, badMics: warns.perMic.filter(m=>m.count>0).length};
    }
  }
  setStatus(`節回避探索：上限に到達（最良= #${best?best.i+1:'-'}、警告あり受音点数=${best?best.badMics:'-' }）。制約を緩めるか室寸法/点数を見直してください。`, false);
}

/* ===== イベント ===== */
document.getElementById('btnGenerate').addEventListener('click', ()=>{
  try{ presetApply(document.getElementById('presetSelect').value); }catch(err){ console.error(err); setStatus(`エラー：${err.message}`, false); }
});
document.getElementById('btnSearch').addEventListener('click', ()=>{
  try{ searchUntilNoWarnings(); }catch(err){ console.error(err); setStatus(`探索エラー：${err.message}`, false); }
});
document.getElementById('addMicRow').addEventListener('click', ()=> addRow(document.querySelector('#micTable tbody'), [{},{},{}]) );
document.getElementById('addSrcRow').addEventListener('click', ()=> addRow(document.querySelector('#srcTable tbody'), [{},{}]) );
document.getElementById('plotManual').addEventListener('click', ()=>{
  try{
    const dims=readDim();
    const mic=getTablePoints3D(document.querySelector('#micTable tbody'));
    const src=getTablePoints2D(document.querySelector('#srcTable tbody'), dims.slab.Sz);
    plotAndEvaluate({room:dims.room, slab:dims.slab, pointsMic:mic, pointsSrc:src, srcMeta: src.map(()=>({type:'light'}))});
    setStatus(`自由記入を描画：受音点 ${mic.length}、加振点 ${src.length}。`, true);
  }catch(err){ console.error(err); setStatus(`エラー（自由記入）：${err.message}`, false); }
});
document.getElementById('clearManual').addEventListener('click', ()=>{
  document.querySelector('#micTable tbody').innerHTML='';
  document.querySelector('#srcTable tbody').innerHTML='';
});

/* 初期化：JIS A 1418-2 で一度描画 */
(function init(){
  try{
    document.getElementById('roomLx').value=5.0;
    document.getElementById('roomLy').value=4.0;
    document.getElementById('roomLz').value=3.0;
    document.getElementById('presetSelect').value='JIS1418_2';
    presetApply('JIS1418_2');
  }catch(err){ console.error(err); }
})();
</script>
</body>
</html>
