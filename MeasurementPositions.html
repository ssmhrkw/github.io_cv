<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>加振・受音点配置ツール：モンテカルロ／節マップ／最適化つき（堅牢化版）</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script>
  window.MathJax={tex:{inlineMath:[['\\(','\\)'],['$','$']]},svg:{fontCache:'global'}};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
<style>
:root{--bg:#fafbfe;--panel:#fff;--ink:#0b1220;--muted:#5b6b82;--accent:#3557ff;--line:#e4e8f0;--ok:#1a936f;--warn:#c0392b;--hint:#e67e22}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN";}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:14px 16px;z-index:10}header h1{margin:0 0 4px;font-size:18px}header p{margin:0;color:var(--muted);font-size:12px}
main{display:grid;grid-template-columns:520px 1fr;gap:16px;padding:16px}@media (max-width:1100px){main{grid-template-columns:1fr}}.panel{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
details{border:1px solid var(--line);border-radius:10px;background:#fff;margin:8px 0}summary{cursor:pointer;padding:10px 12px;font-weight:600}summary::marker,summary::-webkit-details-marker{display:none}
.tri{display:inline-block;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid var(--muted);margin-right:6px;transition:.2s}details[open] .tri{transform:rotate(180deg)}
.sec{padding:8px 12px 12px;border-top:1px dashed var(--line)}.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}label{font-size:12px;color:var(--muted)}
input[type="number"],input[type="text"],select{width:100%;background:#fff;color:#0b1220;border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:13px}
.btn{appearance:none;border:1px solid var(--line);background:#fff;color:#0b1220;padding:9px 12px;border-radius:8px;font-size:13px;cursor:pointer}.btn:hover{border-color:#cfd7e3}.btn-accent{background:#3557ff;color:#fff;border:none}
.muted{color:var(--muted);font-size:12px}.plot-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px}.plots{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:1400px){.plots{grid-template-columns:1fr}}.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;background:#eef2ff;color:#26358b;border:1px solid #d9dffe;margin-right:6px}
.small{width:100%;border-collapse:collapse}.small th,.small td{border:1px solid var(--line);padding:6px;font-size:12px;text-align:center}.icon-btn{width:28px;height:28px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center}
.progress{height:10px;background:#f0f3fa;border:1px solid var(--line);border-radius:999px;overflow:hidden}.bar{height:100%;width:0%;background:linear-gradient(90deg,#7aa6ff,#3557ff);transition:width .06s}
.codebox{background:#f8fafc;border:1px solid var(--line);border-radius:8px;padding:8px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre;overflow:auto}
.ok{color:var(--ok)}.warn{color:var(--warn)}.hint{color:var(--hint)}
</style>
</head>
<body>
<header>
  <h1>加振点・受音点配置ツール + モンテカルロ / 節マップ / 最適化</h1>
  <p>INCE／旧JISは<strong>対角1/4点＋中央</strong>、軽量タッピングは<strong>対角線±45°規則</strong>（A=−45°, B=+45°, 中央=+45°）。</p>
</header>

<main>
  <section class="panel">
    <details open>
      <summary><span class="tri"></span>プリセット・加振タイプ・生成</summary>
      <div class="sec">
        <div class="grid">
          <div>
            <label>標準（プリセット）</label>
            <select id="stdSelect">
              <option value="INCE">INCE</option>
              <option value="OLDJIS">旧JIS</option>
              <option value="JIS">JIS</option>
              <option value="ISO16283">ISO 16283-3</option>
              <option value="ISO10140">ISO 10140-3</option>
            </select>
          </div>
          <div>
            <label>乱数シード</label>
            <input id="seedInput" type="text" value="seed-1234"/>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <label><input type="radio" name="srcType" value="light" checked> 軽量（タッピング）</label>
          <label><input type="radio" name="srcType" value="heavy"> 重量（RB/Heavy-Soft）</label>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn-accent btn" id="btnGenerate">プリセット適用・生成</button>
          <button class="btn" id="btnSearch">節回避探索</button>
          <label class="muted"><input id="showSlabEdges" type="checkbox" checked> スラブ枠表示</label>
        </div>
        <div id="status" class="muted" style="margin-top:6px">準備OK。</div>
        <div class="progress"><div id="progressBar" class="bar"></div></div>
        <div class="codebox" id="bestPanel" style="margin-top:8px">（未探索）</div>
      </div>
    </details>
  </section>

  <section>
    <div class="plots">
      <div class="plot-card"><div id="roomPlot" style="width:100%;height:520px"></div></div>
      <div class="plot-card"><div id="slabPlot" style="width:100%;height:520px"></div></div>
    </div>
  </section>
</main>

<script>
function statusMsg(msg,cls){ const el=document.getElementById('status'); if(!el) return; el.textContent=msg; el.className = cls?('muted '+cls):'muted'; }
window.addEventListener('error', e => { statusMsg('実行時エラー: '+(e?.message||'不明'), 'warn'); });

const PLOTLY_OK = () => (typeof Plotly!=='undefined' && typeof Plotly.newPlot==='function');
function safeNewPlot(id,data,layout,config){ if(!PLOTLY_OK()){ statusMsg('Plotly未ロード', 'warn'); return false; } try{ Plotly.newPlot(id,data,layout,config); return true; } catch(e){ console.error(e); statusMsg('Plotly描画エラー: '+e.message,'warn'); return false; } }
function safeRestyle(id,props,traces){ if(!PLOTLY_OK()) return; try{ Plotly.restyle(id,props,traces); }catch(e){ console.warn('restyle failed:', e); } }
function safeAddTraces(id,traces){ if(!PLOTLY_OK()) return; try{ Plotly.addTraces(id,traces); }catch(e){ console.warn('addTraces failed:', e); } }

function numVal(id){const v=document.getElementById(id).value;return (v===""||v==null)?NaN:Number(v);}
function fmt(n){return Number(n.toFixed(3));}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function dist3(a,b){return Math.hypot(a.x-b.x,a.y-b.y,a.z-b.z);}
function dist2(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}
function rad(d){return d*Math.PI/180;}

function readDim(){
  const Lx=Number(numVal('roomLx')||5.0), Ly=Number(numVal('roomLy')||4.0), Lz=Number(numVal('roomLz')||3.0);
  let Sx=Number(numVal('slabLx')); let Sy=Number(numVal('slabLy')); if(isNaN(Sx))Sx=Lx; if(isNaN(Sy))Sy=Ly;
  const Sz=Lz; return {room:{Lx,Ly,Lz}, slab:{Sx,Sy,Sz}};
}

const TAP_W=0.520, TAP_D=0.260;
function rotRect(cx,cy,w,d,ang){ const dx=w/2, dy=d/2, cs=Math.cos(ang), sn=Math.sin(ang); const pts=[[-dx,-dy],[dx,-dy],[dx,dy],[-dx,dy],[-dx,-dy]].map(([x,y])=>({x:cx+x*cs-y*sn,y:cy+x*sn+y*cs})); return pts; }

function dice5(Sx,Sy){
  const qx1=Sx/4, qx3=3*Sx/4, qy1=Sy/4, qy3=3*Sy/4;
  return [{x:qx1,y:qy3},{x:qx3,y:qy3},{x:Sx/2,y:Sy/2},{x:qx1,y:qy1},{x:qx3,y:qy1}];
}

function anglesByDiagonal(points,Sx,Sy){
  const midX=Sx/2, midY=Sy/2, eps=1e-9;
  return points.map(p=>{
    const isCenter=Math.abs(p.x-midX)<eps && Math.abs(p.y-midY)<eps;
    if(isCenter) return +Math.PI/4;
    const onA=((p.x<=midX && p.y<=midY)||(p.x>=midX && p.y>=midY));
    return onA?-Math.PI/4:+Math.PI/4;
  });
}

let _lastState=null;

function roomEdges(Lx,Ly,Lz){
  function xyz(a){return{x:a.map(p=>p[0]),y:a.map(p=>p[1]),z:a.map(p=>p[2])}}
  const b=xyz([[0,0,0],[Lx,0,0],[Lx,Ly,0],[0,Ly,0],[0,0,0]]);
  const t=xyz([[0,0,Lz],[Lx,0,Lz],[Lx,Ly,Lz],[0,Ly,Lz],[0,0,Lz]]);
  const v=xyz([[0,0,0],[0,0,Lz],[NaN,NaN,NaN],[Lx,0,0],[Lx,0,Lz],[NaN,NaN,NaN],[Lx,Ly,0],[Lx,Ly,Lz],[NaN,NaN,NaN],[0,Ly,0],[0,Ly,Lz]]);
  return[{type:'scatter3d',mode:'lines',...b,line:{width:2},hoverinfo:'skip',name:'room-bottom'},
         {type:'scatter3d',mode:'lines',...t,line:{width:2},hoverinfo:'skip',name:'room-top'},
         {type:'scatter3d',mode:'lines',...v,line:{width:2},hoverinfo:'skip',name:'room-edges'}];
}
function slabFrame3D(Sx,Sy,Sz){ const x=[0,Sx,Sx,0,0], y=[0,0,Sy,Sy,0], z=[Sz,Sz,Sz,Sz,Sz]; return {type:'scatter3d',mode:'lines',x,y,z,line:{width:3},hoverinfo:'skip',name:'slab(上階)'}; }

function plotAll(st){
  const {room,slab,pointsMic,pointsSrc,srcMeta=[]}=st;
  const showEdges=true;
  const base=roomEdges(room.Lx,room.Ly,room.Lz);

  const sizeSrc3D=5,sizeSrc2D=6; const sizeMic3D=Math.max(1,sizeSrc3D-1), sizeMic2D=Math.max(1,sizeSrc2D-1);

  const micPts3D={type:'scatter3d',mode:'markers',x:pointsMic.map(p=>p.x),y:pointsMic.map(p=>p.y),z:pointsMic.map(p=>p.z),marker:{size:sizeMic3D},name:'受音点(点)'};
  const micTxt3D={type:'scatter3d',mode:'text',x:pointsMic.map(p=>p.x),y:pointsMic.map(p=>p.y),z:pointsMic.map(p=>p.z),text:pointsMic.map(()=> 'x'), textposition:'middle center', name:'受音点(x)'};

  const lift=Math.max(0.02,0.02*room.Lz);
  const extra3D=[], extra2D=[];
  for(let i=0;i<pointsSrc.length;i++){
    const p=pointsSrc[i], meta=srcMeta[i];
    if(meta&&meta.type==='tap'){
      const rx=rotRect(p.x,p.y,meta.w||TAP_W,meta.d||TAP_D,meta.angle||0);
      extra3D.push({type:'scatter3d',mode:'lines',x:rx.map(o=>o.x),y:rx.map(o=>o.y),z:rx.map(()=>slab.Sz),line:{width:3},name:`Tap ${i+1}`,hoverinfo:'skip'});
      extra2D.push({type:'scatter',mode:'lines',x:rx.map(o=>o.x),y:rx.map(o=>o.y),name:`Tap ${i+1}`,hoverinfo:'skip'});
    }
  }

  const slabRect={type:'scatter',mode:'lines',x:[0,slab.Sx,slab.Sx,0,0],y:[0,0,slab.Sy,slab.Sy,0],hoverinfo:'skip',name:'Slab'};
  const src2D=null;
  const mic2D={type:'scatter',mode:'markers',x:pointsMic.map(p=>p.x),y:pointsMic.map(p=>p.y),marker:{size:sizeMic2D,symbol:'x'},name:'受音点の床投影'};

  const qx1 = slab.Sx/4, qx3 = 3*slab.Sx/4; const qy1 = slab.Sy/4, qy3 = 3*slab.Sy/4;
  const qLines=[
    {type:'scatter',mode:'lines',x:[qx1,qx1],y:[0,slab.Sy],name:'x=1/4',hoverinfo:'skip',line:{width:1,dash:'dot'}},
    {type:'scatter',mode:'lines',x:[qx3,qx3],y:[0,slab.Sy],name:'x=3/4',hoverinfo:'skip',line:{width:1,dash:'dot'}},
    {type:'scatter',mode:'lines',x:[0,slab.Sx],y:[qy1,qy1],name:'y=1/4',hoverinfo:'skip',line:{width:1,dash:'dot'}},
    {type:'scatter',mode:'lines',x:[0,slab.Sx],y:[qy3,qy3],name:'y=3/4',hoverinfo:'skip',line:{width:1,dash:'dot'}}
  ];

  const data3D=[...base,slabFrame3D(slab.Sx,slab.Sy,slab.Sz),micPts3D,micTxt3D,...extra3D];
  const data2D=[slabRect,...qLines,...extra2D,mic2D];

  const pad=0.12;
  const roomLayout={scene:{xaxis:{title:'X[m]',range:[-pad*room.Lx,(1+pad)*room.Lx]},yaxis:{title:'Y[m]',range:[-pad*room.Ly,(1+pad)*room.Ly]},zaxis:{title:'Z[m]',range:[-0.05*room.Lz,(1+pad)*room.Lz]},aspectmode:'data',camera:{eye:{x:2.1,y:-2.1,z:1.4}},bgcolor:'#fff'},margin:{l:0,r:0,t:20,b:0},paper_bgcolor:'#fff',plot_bgcolor:'#fff',showlegend:true};
  const slabLayout={xaxis:{title:'X[m]',range:[0,slab.Sx],scaleanchor:'y',scaleratio:1},yaxis:{title:'Y[m]',range:[0,slab.Sy]},margin:{l:50,r:20,t:20,b:40},paper_bgcolor:'#fff',plot_bgcolor:'#fff',showlegend:true};

  safeNewPlot('roomPlot',data3D,roomLayout,{responsive:true,displaylogo:false});
  safeNewPlot('slabPlot',data2D,slabLayout,{responsive:true,displaylogo:false});
}

function applyPreset(){
  const dims=readDim();
  const pts=dice5(dims.slab.Sx,dims.slab.Sy);
  const pointsMic=pts.map(p=>({x:p.x,y:p.y,z:dims.room.Lz/2}));
  const pointsSrc=pts.map(p=>({x:p.x,y:p.y,z:dims.slab.Sz}));
  const angs=anglesByDiagonal(pointsSrc,dims.slab.Sx,dims.slab.Sy);
  const srcMeta=pointsSrc.map((_,i)=>({type:'tap',w:TAP_W,d:TAP_D,angle:angs[i]}));
  const state={room:dims.room,slab:dims.slab,pointsMic,pointsSrc,srcMeta,isLight:true,std:'INCE/OLDJIS(quarter)'};
  _lastState=state; plotAll(state); statusMsg('初期化完了（1/4点＋45°）','ok');
}

function setProgress(r){document.getElementById('progressBar').style.width=(Math.max(0,Math.min(1,r))*100).toFixed(1)+'%';}
function drawTolBubbles(st){
  const traces=[];
  for(const mic of st.pointsMic){
    const r=0.3;
    const N=72, xs=[], ys=[];
    for(let i=0;i<=N;i++){const th=2*Math.PI*i/N; xs.push(mic.x+r*Math.cos(th)); ys.push(mic.y+r*Math.sin(th));}
    traces.push({type:'scatter',mode:'lines',x:xs,y:ys,name:`Tol Mic(${fmt(mic.x)},${fmt(mic.y)})`,hoverinfo:'skip',line:{width:2}});
  }
  safeAddTraces('slabPlot',traces);
  statusMsg(`許容公差バブルを描画（Mic=${st.pointsMic.length}）`,'ok');
}

function boot(){
  let tries=0;
  const t=setInterval(()=>{
    tries++;
    if(PLOTLY_OK()){
      clearInterval(t);
      try{ applyPreset(); }catch(e){ console.error(e); statusMsg('初期化例外: '+e.message,'warn'); }
    }else if(tries>30){
      clearInterval(t); statusMsg('Plotlyが読み込めていません。','warn');
    }else{
      statusMsg('Plotly読込待ち…','hint');
    }
  },200);
}
window.addEventListener('load', boot);
</script>
</body>
</html>
