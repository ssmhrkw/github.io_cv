
# CSV Segmenter (Web) — v3.3: 詳細分析

このウェブアプリケーションは、CSV形式の時系列データを読み込み、**特定区間（セグメント）の視覚的な選択**を可能にし、選択されたデータに基づいて**音響・振動関連のメトリクス（ご提案形式の計算）**を実行・エクスポートするために設計されたツールです。

了解しました。提供された詳細分析に基づき、「**CSV Segmenter (Web) — v3.3**」の使い方をステップバイステップで説明します。

---

## 💻 CSV Segmenter (Web) — v3.3 の使い方

このツールは、時系列のCSVデータから特定の衝撃・応答区間を抽出し、振動・音響伝達の評価指標を計算することを目的としています。

### ステップ 1: データの読み込み

まず、解析したい時系列データを含むCSVファイルをアプリケーションに読み込ませます。

1.  **データの準備**: 解析したいCSVファイルをローカルに用意するか、アクセス可能なURLを確認します。このCSVは、時系列（Time）や振動・音響チャンネル（FH, Acc, Mic）のデータを含んでいる必要があります。
2.  **読み込み方法を選択**:
    * **ローカルファイル**: 「**CSVファイルの選択**」ボタンをクリックし、ファイルを選択します。
    * **URLから**: 「**URL**」入力欄にCSVファイルのURLを入力し、「**URLからロード**」ボタンをクリックします。
3.  **状態確認**: 読み込みが成功すると、画面上部に「$\text{CSV Data: } [ \text{OK} ]$」と表示され、CSVの列名が**チャンネル・マッピング**セクションに自動で展開されます。

***

### ステップ 2: チャンネル・マッピングの設定

読み込んだCSVの列が、アプリケーション内でどのような役割を果たすかを定義します。

1.  **役割 (Role) の選択**:
    * **Time**: 時刻データ。
    * **FH (Force History)**: 衝撃力や加振力など、**基準となる力**のデータ。
    * **Acc (加速度)**: 応答加速度データ。**粒子速度 ($v$) として扱われます。**
    * **Mic (マイク/音圧)**: 音圧（$p$）データ。**粒子速度 ($v$) に変換されます。**
    * **Ignore**: 解析に使用しない列。
2.  **Mic距離の設定**: 役割を `Mic` に設定したチャンネルがある場合、その測定距離を「**Mic距離 (m)**」に入力します。
3.  **マッピングの適用**: 設定が完了したら、「**マッピングを適用してプロット**」ボタンをクリックします。
    * これにより、データが数値配列に変換され、右側の**プレビュー**エリアに各チャンネルの時系列グラフが描画されます。

***

### ステップ 3: 衝撃・応答区間の選択

グラフ上で区間（セグメント）を選択し、解析対象のデータ範囲を定義します。

#### A. 基準となる FH 区間の選択

FH（Force History）チャンネルのグラフで、衝撃が加えられた**区間**を定義します。

1.  **FHグラフをクリック**: FHチャンネルのグラフ上で、衝撃の**開始点**と**終了点**を**連続して $2$ 回**クリックします。
2.  **確認**: 選択された区間は、グラフ上に**青色のシェイプ**としてハイライト表示されます。
    * 選択が $2$ 点に満たない場合は「$\text{Selection: } [ \text{NG} ]$」と表示されます。
    * 選択が完了すると、左側の「**選択区間情報**」に FH の開始、終了時刻、継続時間 $T_{\text{FH}}$、最大・最小値が表示されます。

#### B. 応答チャンネル（Acc/Mic）の区間選択

応答チャンネル（Acc, Mic）のグラフで、FHによる**応答区間**を定義します。

* **応答区間 (青色)**: 応答の**開始点**と**終了点**を**連続して $2$ 回**クリックし、青色の応答区間を確定します。

* **応答開始点（ガイド付き）**: 応答の**開始点のみ**をクリックすると、その点から FH の継続時間 $T_{\text{FH}}$ 分の幅を持つ**黄色いガイド帯**が表示されます。このガイドを参考に、応答の**終了点**を $2$ 回目のクリックで確定することも可能です。

* **選択クリア**: 間違えた場合は、「**全選択をクリア**」ボタンで全ての選択をリセットできます。

***

### ステップ 4: メトリクスの計算とエクスポート

区間の選択後、定義された伝達指標を計算します。

1.  **メトリクスの計算**:
    * 画面左側の「**メトリクスを計算**」ボタンをクリックします。
    * FHチャンネルと、青色の区間が確定された応答チャンネル（Acc/Mic）に基づき、下部の「**計算結果（メトリクス）**」表に以下の指標が表示されます。
        * `Sum Abs(R)`、`Max_abs(R)`
        * `F/v_Sum`（総合伝達効率）、`F/v_Max`（ピーク伝達効率）
        * これらに対応する $\text{dB}$ 値 (`F/v_dB_Sum`, `F/v_dB_Max`)
2.  **セグメントのエクスポート**:
    * 「**セグメントをエクスポート**」ボタンをクリックします。
    * すべてのチャンネルの選択区間が抽出され、`combined_segment_#.csv` というファイル名でダウンロードされます。
    * エクスポート後、セグメント番号が自動でインクリメントされます。
3.  **サマリーのエクスポート**:
    * 「**サマリーをエクスポート**」ボタンをクリックします。
    * 計算結果の表全体が `calculation_summary.csv` というファイル名でダウンロードされます。
---

## 💻 アプリケーション概要

| 項目 | 詳細 |
| :--- | :--- |
| **名称** | `CSV Segmenter (Web) — v3.3` |
| **機能** | CSVデータの読み込み（URLまたはローカルファイル）、列のマッピング（役割定義）、時系列データのプレビュー、グラフ上でのセグメント（区間）選択、選択区間の統計情報表示、音響・振動メトリクス計算、結果のエクスポート。|
| **技術** | HTML5, CSS3, JavaScript, **PapaParse** (CSV処理), **Plotly.js** (グラフ描画), Google Analytics |
| **主要概念** | FH（Force History、衝撃力）チャンネルの区間を基準とし、他のチャンネルの応答区間を分析する。|

---

## 🛠️ 技術スタックと構成

### 1. 外部ライブラリ

| ライブラリ | 目的 |
| :--- | :--- |
| `gtag.js` | Google Analytics（アクセス解析）。 |
| `papaparse@5.4.1` | CSVファイルの効率的な解析とJavaScriptオブジェクトへの変換。 |
| `plotly-2.30.0` | データの時系列グラフ表示と、ユーザー操作（クリックによる区間選択）のインタラクティブな処理。 |

### 2. デザイン (CSS)

- **レスポンシブデザイン**: メインコンテンツは最大 $1200 \text{ px}$ に制限。デスクトップサイズ（$1024 \text{ px}$以上）では $2$ 列グリッド (`grid-2`) レイアウトに切り替わります。
- **カラースキーム**: 明るい背景（`--bg: #faf6ed`）と濃いテキスト（`--text: #1e293b`）を使用。
- **状態表示**: 成功（`--ok`, `.ok-state`, `.status-ok`）、失敗/エラー（`--danger`, `.ng-state`, `.status-ng`）、警告（`--warn`）の色が明確に定義されています。
- **タイポグラフィ**: データ表示には等幅フォント（`.mono`）が使用されています。

---

## 🖥️ UI要素と処理ステップ

アプリケーションのUIは、**データ入力/設定**（左側）と**プレビュー**（右側）の $2$ 領域に分かれています。

### 1. データ入力 (セクション 1)

| ID/要素 | 機能 | 処理ロジック |
| :--- | :--- | :--- |
| `#csvUrl` | **URLからのCSV読み込み** | `loadCSVFromURL()`: `fetch` APIでCSVを読み込み、`parseCSVText()`に渡す。CORSモードで取得。|
| `#csvFile` | **ローカルCSVファイル選択** | `loadCSVFromFile()`: `FileReader`でファイルを読み込み、`parseCSVText()`に渡す。UTF-8推奨。|
| `#btnLoadUrl`, `#btnLoadFile` | CSV読み込みのトリガー。 | CSVが読み込まれると、列名が抽出され、**マッピングUI**が自動生成されます。|

---

### 2. チャンネル・マッピング (セクション 2)

CSVデータ列とアプリケーションの役割を関連付けます。

- **マッピングテーブル**:
    - **CSV列名 (Src)**: 読み込まれた元の列名。
    - **役割 (Role)**: `Ignore`, `FH` (Force History), `Acc` (加速度), `Mic` (マイク/音圧), `Time` から選択。
    - **Mic距離 (m)**: `Mic` 選択時のみ使用され、後続の計算で利用されます。
- **機能**:
    - `#btnApplyMapping`: **マッピングを適用**し、データ列をFloat64Arrayに変換、**チャンネル名をユニーク化**（例: `Mic`, `Mic_2`）、`mapped`オブジェクトに格納してプロットを描画します。
    - `#btnResetMapping`: マッピングUIとすべての結果をリセット。
    - `#btnPreset1`: `Time, FH, Acc, Acc, Mic, ...` の初期マッピングを自動適用する機能。

---

### 3. ツールと情報表示 (セクション 3)

| エリア/ID | 機能 | 詳細 |
| :--- | :--- | :--- |
| **サンプリング周波数** | 固定値 | **$51200 \text{ Hz}$** に固定表示されています。CSVにTime列がない場合、インデックスからこの値を使用して時刻を生成します（$t = \text{index} / 51200$）。|
| `#segmentNo` | **セグメント番号** | エクスポートファイル名（`combined_segment_#.csv`）に使用。エクスポート後に自動インクリメント。|
| `#btnClearSelections` | **全選択クリア** | すべてのグラフ上の選択区間をリセット。|
| `#btnCompute` | **メトリクス計算** | FH区間と他のチャンネルの区間からメトリクス（後述）を計算し、`#metricsBody`に表示。|
| `#btnExportSegment` | **セグメントのエクスポート** | 全チャンネルの選択区間を抽出・結合し、新しいCSVファイル（`combined_segment_#.csv`）としてダウンロード。**全チャンネルの区間選択が必須。**|
| `#btnExportSummary` | **サマリーのエクスポート** | 計算されたメトリクス結果をCSV（`calculation_summary.csv`）としてダウンロード。|
| `#infoPanel` | **選択区間情報** | 選択されたセグメントの**開始、終了、継続時間、最大絶対値、最小値**を表示。|

### 4. プレビュー (右側セクション)

- **`#plots`**: マッピングされた各チャンネル（Time, Ignore以外）の**時系列グラフ**がPlotly.jsで描画されます。
- **選択機能**:
    1. グラフをクリックすると、その時点の時刻 $t$ が記録されます（`selections`オブジェクトに保存）。
    2. $2$ 回クリックすることで、**選択区間**が青いシェイプとしてグラフ上に表示されます。
    3. FHチャンネルの区間が確定（$2$点選択）した後、他のチャンネルの**開始点のみ**をクリックすると、その開始点から**FHの継続時間 $T_{\text{FH}}$** をガイドとした帯（黄色）が表示されます。

---

## ⚙️ コア計算ロジック（メトリクス）

`computeAndRenderMetrics()` 関数で実行されます。これは、FH（Force History）の応答を基準に、他のチャンネル（応答、R）の応答を評価する、特定の振動・音響評価メトリクスを計算するロジックです。

### 1. 単位変換（Micチャンネル）

音圧 $p$ は、以下の式で粒子速度 $v$ に変換されます。

$$
v = \frac{p}{\rho c}
$$

ここで、 $\rho$ (空気密度) $\approx 1.21 \text{ kg/m}^3$、 $c$ (音速) $\approx 343 \text{ m/s}$、$\rho c \approx 415 \text{ Pa} \cdot \text{s/m}$ が使用されます。Accチャンネルはそのまま $v$ として扱われます。

### 2. 計算される指標

FHチャンネル (S) および応答チャンネル (R) の選択区間 $i \in I_{\text{S}}$ および $j \in I_{\text{R}}$ に基づき、以下のメトリクスが計算されます。

| 指標名 | 物理量 | 応答 (R) の計算 | 基準 (S) の計算 | 概要 |
| :--- | :--- | :--- | :--- | :--- |
| **Sum Abs(R)** | $\sum_{j \in I_{\text{R}}} |R_j|$ | 応答チャンネルの**絶対値の総和** | — | 応答のエネルギー/インパルス量。 |
| **Max\_abs(R)** | $\max_{j \in I_{\text{R}}} |R_j|$ | 応答チャンネルの**最大絶対値** | — | 応答のピーク値。 |
| **F/v\_Sum** | $\frac{\sum |S|}{\sum |v|}$ | $\frac{\sum_{i \in I_{\text{S}}} |S_i|}{\sum_{j \in I_{\text{R}}} |v_j|}$ | FH（S）の絶対値総和を、応答（R）の絶対値総和（$v$ 変換済み）で割る。| 総合的な伝達効率。 |
| **F/v\_dB\_Sum**| $20 \log_{10} \left( \frac{\sum |S|}{\sum |v|} \right)$ | 上記 $\text{F/v\_Sum}$ のデシベル値。 | — | 伝達損失またはインピーダンスの $\text{dB}$ 表現。 |
| **F/v\_Max** | $\frac{\max |S|}{\max |v|}$ | $\frac{\max_{i \in I_{\text{S}}} |S_i|}{\max_{j \in I_{\text{R}}} |v_j|}$ | FH（S）の最大絶対値を、応答（R）の最大絶対値（$v$ 変換済み）で割る。| ピーク値の伝達効率。 |
| **F/v\_dB\_Max**| $20 \log_{10} \left( \frac{\max |S|}{\max |v|} \right)$ | 上記 $\text{F/v\_Max}$ のデシベル値。 | — | ピーク値の伝達損失 $\text{dB}$ 表現。 |

---
